{% extends 'users/base.html' %}
{% load static %}

{% block title %}Silay City DRRMO Monitoring Dashboard{% endblock %}

{% block header_title %}SCDRRMO - FMSWGIS{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
<style>
        :root {
            --primary-blue: #1e3a5f;
            --secondary-blue: #2563eb;
            --accent-blue: #60a5fa;
            --light-blue: #dbeafe;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
            margin: 0;
            padding-top: 64px !important;
            background-color: white;
            min-height: 100vh;
        }

        .main-content {
            padding: 0 !important;
            max-width: none !important;
            margin: 0 !important;
            position: relative;
            z-index: 1;
        }

        html, body {
            overflow-x: hidden !important;
            width: 100% !important;
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 16px;
            }
        }

        /* Navigation Bar */
        .nav-bar {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            gap: 12px;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
            padding: 36px 40px;
            border-radius: 12px;
            border: none;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        .page-header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            position: relative;
            z-index: 1;
            margin: 0;
        }

        /* Buttons */
        .back-btn, .back-to-dashboard, .print-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 22px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            color: white;
            border-radius: 12px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }

        .back-btn::before, .back-to-dashboard::before, .print-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .back-btn:hover::before, .back-to-dashboard:hover::before, .print-button:hover::before {
            left: 100%;
        }

        .back-btn:hover, .back-to-dashboard:hover, .print-button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(37, 99, 235, 0.45);
            text-decoration: none;
            color: white;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        }

        .back-btn i, .back-to-dashboard i, .print-button i {
            transition: transform 0.3s ease;
        }

        .back-btn:hover i, .print-button:hover i {
            transform: translateX(3px);
        }

        .back-to-dashboard:hover i {
            transform: translateX(-3px);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .nav-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-title i {
            color: var(--secondary-blue);
            font-size: 18px;
        }

        /* Card Design */
        .card {
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: auto;
            overflow: visible;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            box-shadow: 
                0 24px 60px rgba(0, 0, 0, 0.15),
                0 12px 30px rgba(37, 99, 235, 0.1);
            border-color: #93c5fd;
        }
        
        .card:has(.metric-item:hover),
        .card:has(.help-icon:hover) {
            z-index: 999999 !important;
            transform: none !important;
        }

        .metrics-grid:has(.metric-item:hover) {
            z-index: 999998 !important;
        }

        .card.collapsible,
        .card.flood-records-section {
            overflow: visible;
        }

        /* Modern Card Header */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.1);
            transition: all 0.3s ease;
        }

        .card-header:hover {
            border-bottom-color: rgba(99, 102, 241, 0.3);
        }

        .card h2 {
            margin: 0;
            color: var(--text-dark);
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.02em;
        }

        .card h2 i {
            color: var(--secondary-blue);
            font-size: 20px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .collapse-icon {
            font-size: 20px;
            color: var(--secondary-blue);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(59, 130, 246, 0.1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
            background: rgba(100, 116, 139, 0.1);
        }

        .collapse-icon:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }

        .card-content {
            max-height: 10000px;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 1;
        }

        .card-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .refresh-info {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 8px;
            display: inline-block;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
            overflow: visible;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 640px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Metric Cards - PAGASA 3D Style */
        .metric-item {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border: 2px solid #e0e7ff;
            position: relative;
            cursor: help;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
            /* PAGASA-style 3D elevation */
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.08),
                0 3px 8px rgba(0, 0, 0, 0.1),
                0 6px 16px rgba(0, 0, 0, 0.08),
                inset 0 -1px 3px rgba(0, 0, 0, 0.05),
                inset 0 1px 2px rgba(255, 255, 255, 0.9);
            z-index: 1;
        }

        .metric-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.6) 0%, 
                transparent 40%, 
                rgba(0, 0, 0, 0.02) 100%);
            pointer-events: none;
        }

        .metric-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: 1;
        }

        .metric-item:hover::after {
            transform: scaleX(1);
        }

        .metric-item:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.1),
                0 6px 16px rgba(0, 0, 0, 0.12),
                0 12px 32px rgba(0, 0, 0, 0.15),
                0 20px 48px rgba(0, 0, 0, 0.12),
                inset 0 -2px 6px rgba(0, 0, 0, 0.08),
                inset 0 2px 4px rgba(255, 255, 255, 1);
            border-color: #93c5fd;
            z-index: 99999 !important;
        }

        /* Metric Card Colors */
        .metric-item:nth-child(1) {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .metric-item:nth-child(1):hover {
            border-color: #93c5fd;
        }

        .metric-item:nth-child(2) {
            background: #fffbeb;
            border-color: #fde68a;
        }

        .metric-item:nth-child(2):hover {
            border-color: #fcd34d;
        }

        .metric-item:nth-child(3) {
            background: #faf5ff;
            border-color: #e9d5ff;
        }

        .metric-item:nth-child(3):hover {
            border-color: #d8b4fe;
        }

        .metric-item:nth-child(4) {
            background: #ecfdf5;
            border-color: #a7f3d0;
        }

        .metric-item:nth-child(4):hover {
            border-color: #6ee7b7;
        }

        .metric-item:nth-child(5) {
            background: #f0f9ff;
            border-color: #bae6fd;
        }

        .metric-item:nth-child(5):hover {
            border-color: #7dd3fc;
        }

        /* Modern Tooltip */
        .metric-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(8px);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
            backdrop-filter: blur(10px);
            color: white;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: normal;
            width: 300px;
            max-height: 600px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999999999 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }
        
        .metric-item:hover .metric-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .metric-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: rgba(15, 23, 42, 0.98);
        }

        .metric-item i {
            font-size: 18px;
            margin-right: 8px;
        }

        .metric-item:nth-child(1) i { color: #3b82f6; }
        .metric-item:nth-child(2) i { color: #f59e0b; }
        .metric-item:nth-child(3) i { color: #8b5cf6; }
        .metric-item:nth-child(4) i { color: #10b981; }
        .metric-item:nth-child(5) i { color: #06b6d4; }

        .metric-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .metric-label-text {
            display: flex;
            align-items: center;
        }
        
        /* Weather Icon Display */
        .weather-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            opacity: 0.6;
            filter: grayscale(20%);
            font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif;
            line-height: 1;
        }
            display: flex;
            align-items: center;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .metric-value {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .trend-indicator.trend-up {
            background: #fef2f2;
            color: #dc2626;
        }

        .trend-indicator.trend-down {
            background: #f0fdf4;
            color: #059669;
        }

        .trend-indicator.trend-neutral {
            background: #f8fafc;
            color: #6b7280;
        }

        .trend-indicator i {
            font-size: 10px;
        }

        .metric-item:nth-child(1) .metric-label { color: #2563eb; }
        .metric-item:nth-child(1) .metric-value { color: #1e40af; }
        
        .metric-item:nth-child(2) .metric-label { color: #d97706; }
        .metric-item:nth-child(2) .metric-value { color: #b45309; }
        
        .metric-item:nth-child(3) .metric-label { color: #7c3aed; }
        .metric-item:nth-child(3) .metric-value { color: #6d28d9; }
        
        .metric-item:nth-child(4) .metric-label { color: #059669; }
        .metric-item:nth-child(4) .metric-value { color: #047857; }
        
        .metric-item:nth-child(5) .metric-label { color: #0891b2; }
        .metric-item:nth-child(5) .metric-value { color: #0e7490; }

        /* Risk Banner */
        .risk-banner {
            width: 100%;
            padding: 20px 32px;
            margin-bottom: 24px;
            border-radius: 16px;
            color: white;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            position: relative;
            cursor: help;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* PAGASA-style 3D layered shadows */
            box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.05),
                0 4px 8px rgba(0, 0, 0, 0.08),
                0 8px 16px rgba(0, 0, 0, 0.1),
                0 16px 32px rgba(0, 0, 0, 0.12),
                inset 0 -2px 8px rgba(0, 0, 0, 0.15),
                inset 0 2px 4px rgba(255, 255, 255, 0.25);
            transform: perspective(1000px) rotateX(2deg);
            transform-style: preserve-3d;
            z-index: 10;
        }
        
        .risk-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                transparent 50%, 
                rgba(0, 0, 0, 0.1) 100%);
            pointer-events: none;
        }
        
        .risk-banner:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-8px) scale(1.01);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.06),
                0 8px 16px rgba(0, 0, 0, 0.1),
                0 16px 32px rgba(0, 0, 0, 0.15),
                0 24px 48px rgba(0, 0, 0, 0.2),
                inset 0 -2px 10px rgba(0, 0, 0, 0.2),
                inset 0 2px 6px rgba(255, 255, 255, 0.3);
            z-index: 50;
        }

        .risk-banner:hover .risk-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .risk-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: normal;
            width: 340px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease;
            z-index: 100;
            margin-top: 10px;
            line-height: 1.5;
        }

        .risk-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: rgba(17, 24, 39, 0.95);
        }

        .risk-tooltip strong {
            color: #fbbf24;
            font-weight: 600;
        }

        .risk-banner.low-risk { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: rgba(254, 243, 199, 0.6);
        }

        .risk-banner.low-risk::after {
            content: '✓';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 32px;
            opacity: 0.3;
            font-weight: bold;
        }

        /* 3D Sun with Rays for Low Risk */
        .risk-banner.low-risk::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: 
                radial-gradient(circle at 35% 35%, #fef3c7, #fbbf24),
                linear-gradient(0deg, transparent 45%, rgba(254, 243, 199, 0.6) 48%, transparent 52%),
                linear-gradient(45deg, transparent 45%, rgba(254, 243, 199, 0.5) 48%, transparent 52%),
                linear-gradient(90deg, transparent 45%, rgba(254, 243, 199, 0.6) 48%, transparent 52%),
                linear-gradient(135deg, transparent 45%, rgba(254, 243, 199, 0.5) 48%, transparent 52%);
            border-radius: 50%;
            opacity: 0.5;
            box-shadow: 
                0 0 25px rgba(251, 191, 36, 0.5),
                0 0 50px rgba(251, 191, 36, 0.3),
                inset -5px -5px 15px rgba(217, 119, 6, 0.2),
                inset 5px 5px 15px rgba(255, 255, 255, 0.4);
            animation: pulse-sun-banner 4s ease-in-out infinite;
        }
        
        @keyframes pulse-sun-banner {
            0%, 100% { transform: translateY(-50%) scale(1) rotate(0deg); }
            50% { transform: translateY(-50%) scale(1.15) rotate(90deg); }
        }

        .risk-banner.moderate-risk { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-color: rgba(254, 215, 170, 0.6);
            animation: moderate-pulse 3s ease-in-out infinite;
        }

        .risk-banner.moderate-risk::after {
            content: '⚠';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 36px;
            opacity: 0.4;
            animation: warning-pulse 2s ease-in-out infinite;
        }

        /* 3D Fluffy Cloud for Moderate Risk */
        .risk-banner.moderate-risk::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            width: 60px;
            height: 35px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.5), rgba(230, 230, 230, 0.4));
            border-radius: 50px;
            opacity: 0.6;
            box-shadow: 
                0 6px 18px rgba(0, 0, 0, 0.15),
                inset 0 -4px 10px rgba(0, 0, 0, 0.12),
                inset 0 3px 6px rgba(255, 255, 255, 0.6),
                -18px -3px 0 -5px rgba(255, 255, 255, 0.5),
                -16px -3px 0 -3px rgba(230, 230, 230, 0.4),
                18px -3px 0 -5px rgba(255, 255, 255, 0.4),
                16px -3px 0 -3px rgba(230, 230, 230, 0.35),
                0 -8px 0 -8px rgba(255, 255, 255, 0.5),
                0 -6px 0 -6px rgba(240, 240, 240, 0.45);
            animation: float-cloud-banner 6s ease-in-out infinite;
        }
        
        @keyframes float-cloud-banner {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-50%) translateX(-8px); }
        }

        @keyframes moderate-pulse {
            0%, 100% { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 4px 10px rgba(0, 0, 0, 0.15), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.2); }
            50% { box-shadow: 0 8px 20px rgba(249, 115, 22, 0.4), 0 4px 10px rgba(249, 115, 22, 0.3), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.2); }
        }

        @keyframes warning-pulse {
            0%, 100% { opacity: 0.4; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
        }

        .risk-banner.high-risk { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: rgba(254, 202, 202, 0.6);
            animation: high-risk-pulse 2s ease-in-out infinite;
        }

        .risk-banner.high-risk::after {
            content: '⚠';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            opacity: 0.5;
            animation: critical-warning 1.5s ease-in-out infinite;
        }

        /* 3D Storm Cloud with Rain for High Risk */
        .risk-banner.high-risk::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 15px;
            width: 65px;
            height: 40px;
            background: linear-gradient(180deg, rgba(220, 220, 220, 0.4), rgba(180, 180, 180, 0.5));
            border-radius: 50px;
            opacity: 0.7;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.25),
                inset 0 -5px 12px rgba(0, 0, 0, 0.2),
                inset 0 4px 10px rgba(255, 255, 255, 0.3),
                -20px -2px 0 -6px rgba(200, 200, 200, 0.45),
                -18px -2px 0 -4px rgba(180, 180, 180, 0.4),
                20px -2px 0 -6px rgba(200, 200, 200, 0.35),
                18px -2px 0 -4px rgba(180, 180, 180, 0.3),
                0 -10px 0 -8px rgba(210, 210, 210, 0.5),
                0 -8px 0 -6px rgba(190, 190, 190, 0.45),
                /* Rain drops */
                -15px 42px 0 -10px rgba(255, 255, 255, 0.4),
                0 45px 0 -10px rgba(255, 255, 255, 0.5),
                15px 42px 0 -10px rgba(255, 255, 255, 0.4);
            animation: storm-cloud-banner 3s ease-in-out infinite;
        }

        @keyframes storm-cloud-banner {
            0%, 100% { 
                transform: translateY(0);
                filter: brightness(0.9);
            }
            50% { 
                transform: translateY(-6px);
                filter: brightness(1.1);
            }
        }

        @keyframes high-risk-pulse {
            0%, 100% { 
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 4px 10px rgba(0, 0, 0, 0.15), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.2);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 8px 24px rgba(239, 68, 68, 0.6), 0 4px 12px rgba(239, 68, 68, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.4), inset 0 -2px 4px rgba(0, 0, 0, 0.25);
                transform: scale(1.005);
            }
        }

        @keyframes critical-warning {
            0%, 100% { opacity: 0.5; transform: translateY(-50%) scale(1) rotate(0deg); }
            25% { opacity: 0.8; transform: translateY(-50%) scale(1.15) rotate(-10deg); }
            75% { opacity: 0.8; transform: translateY(-50%) scale(1.15) rotate(10deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
        }

        /* Modern Graph Sections */
        .graph-section {
            margin-bottom: 32px;
            padding: 28px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .graph-section:hover {
            box-shadow: var(--shadow-lg);
        }

        .graph-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.03em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .graph-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        /* Modern Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0;
            background: transparent;
            width: fit-content;
        }
        
        .toggle-switch:hover {
            opacity: 0.9;
        }
        
        .toggle-switch input[type="checkbox"] {
            width: 48px;
            height: 26px;
            appearance: none;
            background: #cbd5e1;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .toggle-switch input[type="checkbox"]:checked::before {
            left: 25px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .toggle-switch label {
            margin: 0;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-dark);
            font-weight: 600;
            user-select: none;
            transition: color 0.2s ease;
        }

        .toggle-switch:hover label {
            color: var(--secondary-blue);
        }

        /* Modern Table Design */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 24px;
            font-size: 14px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        table th, table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        table th {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.8px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table th:first-child {
            border-top-left-radius: 12px;
        }

        table th:last-child {
            border-top-right-radius: 12px;
        }

        table tbody tr {
            transition: all 0.2s ease;
        }

        table tbody tr:hover {
            background: linear-gradient(90deg, #f8fafc, #ffffff);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        table tbody tr:last-child td {
            border-bottom: none;
        }

        table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        table td {
            color: var(--text-dark);
            font-weight: 500;
        }

        /* Modern Forecast Cards */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        @media (max-width: 640px) {
            .forecast-grid {
                grid-template-columns: 1fr;
            }
        }

        .forecast-card {
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .forecast-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: #93c5fd;
        }

        .forecast-card:hover::before {
            transform: scaleX(1);
        }

        .forecast-date {
            font-size: 14px;
            font-weight: 700;
            color: var(--secondary-blue);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .forecast-detail {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--text-dark);
        }

        .forecast-detail i {
            width: 20px;
            color: var(--secondary-blue);
            font-size: 16px;
        }

        .forecast-detail strong {
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Modern Form Styling */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Modern Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before, .btn-secondary::before, .btn-danger::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-primary:hover::before, .btn-secondary:hover::before, .btn-danger:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-primary:active, .btn-secondary:active, .btn-danger:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 56px !important;
            }

            .content-wrapper {
                padding: 16px;
            }

            .page-header {
                padding: 24px 20px;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .card {
                padding: 20px;
            }

            .card h2 {
                font-size: 16px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .metric-value {
                font-size: 22px;
            }

            .risk-banner {
                padding: 16px 20px;
                font-size: 15px;
            }

            .graph-section {
                padding: 20px;
            }

            .nav-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-left {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 12px 10px;
            }

            .metric-tooltip {
                width: 250px;
                font-size: 11px;
                padding: 10px 14px;
            }
        }

        @media (max-width: 480px) {
            .page-header h1 {
                font-size: 20px;
            }

            .metric-value {
                font-size: 20px;
            }

            .card h2 {
                font-size: 15px;
            }

            .forecast-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State Animation */
        @keyframes skeleton-loading {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }

            body::before {
                display: none;
            }

            .nav-bar, .back-btn, .print-button, .action-buttons {
                display: none !important;
            }

            .card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }

            .card:hover {
                transform: none;
            }
        }

        /* Table row styles are now handled by the modern table section above */
        table tbody tr:nth-child(even) {
            background-color: rgba(248, 250, 252, 0.3);
        }

        .hidden {
            display: none;
        }

        /* Modern Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            margin-top: 16px;
            margin-right: 8px;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            text-decoration: none;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-apply {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            margin-top: 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-apply::before {
            content: '✓';
            font-size: 16px;
            font-weight: bold;
        }

        .btn-apply:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-apply:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-reset {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            margin-top: 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }
        
        .btn-reset::before {
            content: '↻';
            font-size: 16px;
        }

        .btn-reset:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .btn-reset:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-clear {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            margin-top: 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-clear::before {
            content: '×';
            font-size: 20px;
            font-weight: bold;
        }

        .btn-clear:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-clear:active {
            transform: translateY(-1px) scale(0.98);
        }

        .year-checkbox-label:hover {
            background: linear-gradient(135deg, #eff6ff, #dbeafe) !important;
            border-color: #93c5fd !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .year-checkbox-label:has(input:checked) {
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, #dbeafe, #eff6ff) !important;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        /* Modern Edit/Delete Buttons */
        .btn-edit {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 8px 14px;
            font-size: 12px;
            margin: 2px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .btn-edit:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            padding: 8px 14px;
            font-size: 12px;
            margin: 2px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
        }

        .btn-delete:active {
            transform: translateY(0) scale(0.98);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Modern Charts Grid - Responsive 2x2 layout */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Trends Charts - Full width single column */
        .trends-charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .chart-container:hover {
            border-color: #93c5fd;
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .chart-container:hover::before {
            transform: scaleX(1);
        }

        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
        }

        .chart-container canvas {
            max-height: 280px;
            cursor: grab;
            border-radius: 8px;
        }

        .chart-container canvas:active {
            cursor: grabbing;
        }

        /* Modern Chart Insight Box */
        .chart-insight {
            margin-top: 16px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-left: 4px solid #3b82f6;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .chart-insight:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(3px);
        }

        .chart-insight i {
            color: #3b82f6;
            font-size: 14px;
            margin-top: 2px;
            flex-shrink: 0;
            background: rgba(59, 130, 246, 0.1);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .chart-insight span {
            flex: 1;
            font-weight: 500;
        }

        .chart-insight strong {
            color: #1e40af;
            font-weight: 700;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Insights Section */
        .insights-section {
            margin-bottom: 28px;
        }

        .insights-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
            letter-spacing: -0.02em;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(59, 130, 246, 0.1);
        }
        
        .insights-section h3 i {
            color: var(--secondary-blue);
            font-size: 16px;
        }

        /* Modern Alerts Container */
        .alerts-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .alert-card {
            padding: 18px 20px;
            border-radius: 12px;
            border-left: 4px solid;
            background: white;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .alert-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .alert-high { 
            background: #fef2f2;
            border-left-color: #ef4444;
            color: #991b1b;
        }
        
        .alert-medium { 
            background: #fffbeb;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        
        .alert-low { 
            background: #f0fdf4;
            border-left-color: #10b981;
            color: #065f46;
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        
        .alert-header i {
            font-size: 16px;
        }

        .alert-message {
            font-size: 13px;
            line-height: 1.6;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        /* Modern Analysis Grid */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }

        @media (max-width: 640px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        .analysis-card {
            padding: 18px 20px;
            border-radius: 12px;
            border-left: 4px solid;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            box-shadow: var(--shadow-sm);
        }
        
        .analysis-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .impact-high { 
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .impact-moderate,
        .impact-medium { 
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }
        
        .impact-low { 
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }

        .analysis-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 6px;
            font-size: 13px;
        }

        .analysis-content {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            transition: border-color 0.15s ease;
        }
        
        .recommendation-item:hover {
            border-color: #cbd5e1;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
            letter-spacing: 0.3px;
        }

        .priority-high { 
            background: #fef2f2;
            color: #dc2626;
        }
        .priority-medium { 
            background: #fffbeb;
            color: #d97706;
        }
        .priority-low { 
            background: #f0fdf4;
            color: #059669;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-action {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
            font-size: 13px;
        }

        .recommendation-reason {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .trends-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .trend-card {
            padding: 14px 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: #faf5ff;
            transition: border-color 0.15s ease;
        }
        
        .trend-card:hover {
            border-color: #d8b4fe;
        }

        .trend-title {
            font-weight: 600;
            color: #5b21b6;
            margin-bottom: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trend-analysis {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .trend-recommendation {
            font-size: 12px;
            color: #7c3aed;
            font-weight: 500;
            font-style: italic;
            padding: 8px 10px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 4px;
            border-left: 3px solid #a78bfa;
        }

        .empty-state {
            text-align: center;
            padding: 32px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 40px;
            color: #cbd5e1;
            margin-bottom: 12px;
        }

        .empty-state h3 {
            color: var(--text-dark);
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .empty-state p {
            font-size: 13px;
            line-height: 1.5;
        }

        /* Time Range Selector */
        .time-range-selector {
            margin-bottom: 16px;
            padding: 14px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .time-range-selector > label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .range-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .time-range-btn {
            padding: 8px 14px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .time-range-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .time-range-btn.btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .time-range-btn.btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            justify-content: space-between;
            align-items: center;
        }

        .export-buttons.records-export {
            justify-content: space-between;
        }

        .export-btn {
            padding: 10px 18px;
            background: white;
            color: var(--text-dark);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .export-btn:hover {
            background: #f8fafc;
            text-decoration: none;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .export-btn:active {
            background: #f1f5f9;
        }

        .export-btn i {
            font-size: 14px;
        }

        .export-btn.csv {
            border-color: #a7f3d0;
            color: #059669;
        }

        .export-btn.csv:hover {
            background: #ecfdf5;
            border-color: #6ee7b7;
        }

        .export-btn.pdf {
            border-color: #fecaca;
            color: #dc2626;
        }

        .export-btn.pdf:hover {
            background: #fef2f2;
            border-color: #f87171;
        }

        .custom-date-picker {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .custom-date-picker label {
            font-weight: 600;
            color: #1e40af;
        }

        .custom-date-picker input {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .custom-date-picker input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .custom-date-picker span {
            font-weight: 600;
            color: #6b7280;
        }

        #range-label {
            font-size: 13px;
            font-weight: 600;
            color: #1e40af;
            margin-top: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        #range-label strong {
            color: #1e3a8a;
        }

        /* Filter Tabs Styling */
        .filter-tabs-container {
            margin-bottom: 24px;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            border-bottom: 3px solid #e5e7eb;
            margin-bottom: 0;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: -3px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 8px 8px 0 0;
        }

        .filter-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .filter-tab.active {
            color: #1e40af;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
            font-weight: 800;
        }

        .filter-tab i {
            font-size: 14px;
        }

        .filter-tab-content {
            display: none;
            padding: 24px;
            background: white;
            border-radius: 0 12px 12px 12px;
            border: 2px solid #e5e7eb;
            border-top: none;
            animation: fadeInContent 0.3s ease;
        }

        .filter-tab-content.active {
            display: block;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Active Filter Badge */
        .active-filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            border: 2px solid #93c5fd;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .active-filter-badge i {
            color: #3b82f6;
        }

        .active-filter-badge .filter-value {
            color: #1e3a8a;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 800;
        }

        /* Year Checkboxes - Compact Horizontal */
        .year-selection-grid {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .year-checkbox-wrapper {
            flex: 1;
            min-width: 140px;
        }

        .year-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .year-checkbox-label:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .year-checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin: 0;
        }

        .year-checkbox-label input[type="checkbox"]:checked + span {
            color: #1e40af;
            font-weight: 800;
        }

        .year-checkbox-label:has(input:checked) {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        /* Custom Date Inputs - Improved */
        .date-inputs-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .date-input-group label {
            font-size: 12px;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-input-group input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
            min-width: 160px;
        }

        .date-input-group input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Month/Day Select Styling */
        .month-day-select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #374151;
        }

        .month-day-select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .month-day-select:hover {
            border-color: #3b82f6;
        }

        /* Button Group */
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-apply, .btn-reset {
            padding: 12px 24px;
            border: 2px solid;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-apply {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: #2563eb;
        }

        .btn-apply:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-reset {
            background: white;
            color: #6b7280;
            border-color: #d1d5db;
        }

        .btn-reset:hover {
            background: #f9fafb;
            color: #374151;
            border-color: #9ca3af;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 16px;
            }

            .nav-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
            }

            .print-button {
                width: 100%;
                justify-content: center;
            }

            .export-buttons {
                width: 100%;
            }

            .export-btn {
                flex: 1;
                justify-content: center;
                min-width: 140px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 16px;
            }

            table {
                font-size: 11px;
            }

            table th, table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .content-wrapper {
                padding: 12px;
            }

            .risk-banner {
                font-size: 16px;
                padding: 16px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 16px;
            }

            .card h2 {
                font-size: 16px;
            }

            .metric-value {
                font-size: 16px;
            }

            .nav-bar {
                padding: 12px;
            }

            .nav-title {
                font-size: 14px;
            }

            .quick-nav {
                display: none;
            }
        }

        /* Quick Navigation */
        .quick-nav {
            position: sticky;
            top: 80px;
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }

        .quick-nav h3 {
            margin: 0 0 12px 0;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .quick-nav h3 i {
            color: var(--secondary-blue);
            font-size: 12px;
        }

        .quick-nav-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-nav-link {
            padding: 8px 14px;
            background: #f8fafc;
            color: var(--text-dark);
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid var(--border-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .quick-nav-link i {
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .quick-nav-link:hover {
            background: var(--secondary-blue);
            color: white;
            text-decoration: none;
            border-color: var(--secondary-blue);
        }
        
        .quick-nav-link:hover i {
            color: white;
        }

        /* Flood Records Tabs */
        .flood-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 6px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .flood-tab {
            padding: 10px 18px;
            background: white;
            color: #6b7280;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .flood-tab i {
            font-size: 14px;
        }

        .flood-tab:hover {
            color: #3b82f6;
            background: #eff6ff;
            border-color: #93c5fd;
        }

        .flood-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .flood-tab.active:hover {
            background: #2563eb;
        }

        .flood-tab-content {
            display: none;
        }

        .flood-tab-content.active {
            display: block;
        }

        /* Flood Records Section */
        .flood-records-section {
            background: white;
            border: 1px solid #e2e8f0;
            overflow: visible !important;
            z-index: 300 !important;
        }

        .flood-records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #60a5fa, transparent) 1;
            flex-wrap: wrap;
            gap: 16px;
        }

        .flood-records-title {
            font-size: 24px;
            font-weight: 900;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }

        .flood-records-title i {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
        }

        .flood-records-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin: 0;
            font-weight: 500;
        }

        .records-count-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid #93c5fd;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #1e40af;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .records-count-badge i {
            font-size: 16px;
        }

        .records-count-badge span {
            font-size: 18px;
            color: #3b82f6;
        }

        .records-export {
            margin-bottom: 24px;
        }

        .flood-records-table-container {
            overflow-x: auto;
            overflow-y: visible;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            margin-bottom: 16px;
            position: relative;
            z-index: 310;
        }

        .flood-records-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .flood-records-table thead {
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .flood-records-table thead th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: white;
            white-space: nowrap;
            border-bottom: 1px solid #e2e8f0;
        }

        .flood-records-table thead th:last-child {
            border-right: none;
        }

        .flood-records-table tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.15s ease;
        }

        .flood-records-table tbody tr:hover {
            background: #f1f5f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .flood-records-table tbody td {
            padding: 10px 12px;
            color: #374151;
            white-space: nowrap;
        }

        .flood-records-table tbody td:last-child {
            border-right: none;
        }

        .flood-records-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Barangay breakdown tooltips */
        .barangay-breakdown-cell {
            position: relative;
            cursor: help;
            z-index: 1;
        }

        .barangay-breakdown-cell:hover {
            z-index: 99990;
        }

        .barangay-info-icon {
            font-size: 12px;
            color: #3b82f6;
            margin-left: 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .barangay-breakdown-cell:hover .barangay-info-icon {
            opacity: 1;
        }

        .barangay-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(12px);
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 99999;
            pointer-events: none;
            opacity: 1;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .barangay-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #1e293b;
        }

        .barangay-tooltip-title {
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: #60a5fa;
        }

        .barangay-tooltip-item {
            padding: 3px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .barangay-tooltip-item::before {
            content: '•';
            color: #3b82f6;
            font-weight: bold;
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 12px;
            border: 2px dashed #cbd5e0;
            margin: 20px 0;
        }

        .empty-state.show {
            display: block;
        }

        .empty-state-icon {
            font-size: 64px;
            color: #cbd5e0;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: #718096;
            max-width: 400px;
            margin: 0 auto;
        }

        .add-record-container {
            text-align: center;
            padding-top: 12px;
        }

        .add-record-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 32px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .add-record-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .add-record-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .add-record-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            text-decoration: none;
        }

        .add-record-btn:active {
            transform: translateY(-1px);
        }

        .add-record-btn i {
            font-size: 18px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .add-record-btn:hover i {
            transform: scale(1.2) rotate(90deg);
        }

        .add-record-btn span {
            position: relative;
            z-index: 1;
        }

        /* Flood Records Filter */
        .flood-records-filter {
            margin-bottom: 16px;
            background: #f8fafc;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 16px;
        }

        .filter-header {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-header i {
            color: var(--secondary-blue);
        }

        .filter-controls {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .filter-group input,
        .filter-group select,
        .year-select {
            padding: 10px 14px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-size: 13px;
            min-width: 140px;
            transition: all 0.2s ease;
            background: white;
            cursor: pointer;
        }

        .filter-group input:focus,
        .filter-group select:focus,
        .year-select:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filter-group input:hover,
        .filter-group select:hover,
        .year-select:hover {
            border-color: #94a3b8;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .filter-apply-btn,
        .filter-reset-btn {
            padding: 8px 16px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-apply-btn {
            background: var(--secondary-blue);
            color: white;
        }

        .filter-apply-btn:hover {
            background: #1e40af;
        }

        .filter-reset-btn {
            background: #f1f5f9;
            color: var(--text-muted);
            border-color: var(--border-gray);
        }

        .filter-reset-btn:hover {
            background: var(--border-gray);
            color: var(--text-dark);
        }

        /* Compact spacing */
        .page-header {
            padding: 24px;
            margin-bottom: 20px;
        }

        .page-header h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .page-header p {
            font-size: 13px;
        }

        .risk-banner {
            padding: 20px 24px;
            margin-bottom: 20px;
            font-size: 18px;
        }

        /* Responsive charts */
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container canvas {
                max-height: 200px;
            }
        }

        /* Trend Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            font-size: 14px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            animation: slideIn 0.3s ease;
        }

        .trend-up {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .trend-down {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .trend-stable {
            color: #64748b;
            background: rgba(100, 116, 139, 0.1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Summary Dashboard */
        .summary-dashboard {
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
            border-radius: 20px;
            padding: 36px;
            margin-bottom: 28px;
            box-shadow: 0 20px 60px rgba(30, 58, 95, 0.25), 0 10px 30px rgba(0, 0, 0, 0.1);
            color: white;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }

        .summary-dashboard::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            pointer-events: none;
        }

        .summary-dashboard::after {
            content: '';
            position: absolute;
            bottom: -20%;
            left: 10%;
            width: 250px;
            height: 250px;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }

        .summary-dashboard h2 {
            color: white;
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 640px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 32px 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .summary-card:hover {
            background: white;
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .summary-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.95;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 6px;
            letter-spacing: -0.05em;
        }

        .summary-status {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Help Icon */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-blue);
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: help;
            margin-left: 8px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1001;
        }

        .help-icon:hover {
            background: var(--primary-blue);
            transform: scale(1.1);
            z-index: 1002;
        }

        .help-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.97);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: normal;
            width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            line-height: 1.5;
        }

        .help-icon:hover .help-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .help-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.97);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 20px;
            margin-bottom: 10px;
        }

        .skeleton-chart {
            height: 220px;
            width: 100%;
        }

        /* Live Update Indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .live-pulse {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-live 2s ease-in-out infinite;
        }

        @keyframes pulse-live {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Refresh Countdown Badge */
        .refresh-countdown {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .refresh-icon {
            width: 8px;
            height: 8px;
            border: 2px solid #3b82f6;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .badge-realtime {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .badge-updated {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .badge-historical {
            background: #faf5ff;
            color: #7c3aed;
            border: 1px solid #e9d5ff;
        }

        /* Keyboard Shortcuts Hint */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 11px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        .keyboard-hint kbd {
            background: var(--light-gray);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-weight: 600;
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-to-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .back-to-top:hover::before {
            opacity: 1;
        }

        .back-to-top i {
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .back-to-top:hover i {
            transform: translateY(-3px);
            animation: bounce 0.6s ease infinite;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .back-to-top:active {
            transform: scale(0.95);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(-3px);
            }
            50% {
                transform: translateY(-6px);
            }
        }

        /* Enhanced Mobile Touch Targets */
        @media (max-width: 768px) {
            .quick-nav-link {
                padding: 12px 16px;
                font-size: 13px;
            }

            .flood-tab {
                padding: 14px 18px;
                font-size: 13px;
            }

            .time-range-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .btn {
                padding: 14px 22px;
                font-size: 15px;
            }

            .flood-records-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .flood-records-title {
                font-size: 20px;
            }

            .records-count-badge {
                padding: 8px 16px;
                font-size: 13px;
            }

            .flood-records-table {
                font-size: 11px;
            }

            .flood-records-table thead th {
                padding: 10px 8px;
                font-size: 10px;
            }

            .flood-records-table tbody td {
                padding: 8px 6px;
            }

            .add-record-btn {
                padding: 12px 24px;
                font-size: 14px;
            }

            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        /* Event Records Modal */
        .event-records-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .event-records-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 0;
            border-radius: 8px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 80px;
        }

        .modal-header {
            padding: 16px 20px;
            background: white;
            color: var(--text-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-header h2 i {
            color: #64748b;
        }

        .modal-close {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }

        .impact-analysis-header {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 16px;
        }

        .view-records-tab {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2), 0 4px 8px rgba(59, 130, 246, 0.15);
        }

        .view-records-tab:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3), 0 6px 12px rgba(59, 130, 246, 0.2);
        }

        .view-records-tab .records-badge {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }

        .view-records-tab:hover .records-badge {
            background: rgba(255, 255, 255, 0.35);
        }

        .impact-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 0;
        }

        .impact-grid-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: border-color 0.15s ease;
        }

        .impact-grid-item:hover {
            border-color: #cbd5e1;
        }

        .impact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .impact-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .impact-header h3 i {
            color: #64748b;
            font-size: 14px;
        }

        .impact-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-btn {
            background: #f1f5f9;
            color: var(--text-muted);
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .fullscreen-btn:hover {
            background: #e2e8f0;
            color: var(--text-dark);
        }

        .fullscreen-btn i {
            font-size: 11px;
        }

        /* Fullscreen Chart Modal */
        .fullscreen-chart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(2px);
            z-index: 10000;
            padding: 100px 24px 24px 24px; /* Top padding accounts for navbar */
        }

        .fullscreen-chart-modal.show {
            display: flex;
            flex-direction: column;
        }

        .fullscreen-chart-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .fullscreen-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .fullscreen-chart-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-chart-header h2 i {
            color: #64748b;
            font-size: 16px;
        }

        .fullscreen-close-btn {
            background: #f1f5f9;
            color: var(--text-muted);
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
        }

        .fullscreen-close-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .fullscreen-chart-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .fullscreen-chart-body canvas {
            max-width: 100%;
            max-height: 100%;
        }

        @media (max-width: 1200px) {
            .impact-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 98%;
                max-height: 95vh;
            }

            .modal-header {
                padding: 16px 20px;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .modal-body {
                padding: 16px 20px;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1>Real-Time Monitoring</h1>
            <p>Flood risk assessment and environmental data tracking for Silay City</p>
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="quick-nav">
        <h3><i class="fas fa-compass"></i> Jump to Section</h3>
        <div class="quick-nav-links">
            <a href="#current-conditions" class="quick-nav-link"><i class="fas fa-gauge-high"></i> Current Conditions</a>
            <a href="#weather-forecast" class="quick-nav-link"><i class="fas fa-cloud-sun"></i> 7-Day Weather Forecast</a>
            <a href="#insights" class="quick-nav-link"><i class="fas fa-lightbulb"></i> Forecast Insights</a>
            <a href="#trends" class="quick-nav-link"><i class="fas fa-chart-line"></i> Rainfall and Tide Trends</a>
            <a href="#analysis" class="quick-nav-link"><i class="fas fa-chart-bar"></i> Flood Impact Analysis</a>
        </div>
    </div>

    <!-- Flood Risk Alert Banner -->
    <div class="risk-banner {% if 'Low Risk' in combined_risk_level %}low-risk{% elif 'Moderate Risk' in combined_risk_level %}moderate-risk{% elif 'High Risk' in combined_risk_level %}high-risk{% endif %}">
        <i class="fas fa-exclamation-triangle" style="margin-right: 12px;"></i>
        Current Flood Risk: {{ combined_risk_level }}
        <div class="risk-tooltip">
            <div style="font-weight: 700; margin-bottom: 12px; font-size: 14px; color: #60a5fa; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 8px;">
                <i class="fas fa-shield-alt"></i> Risk Assessment Breakdown
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div><strong>☔ Rainfall:</strong> {{ rainfall_data.value_mm }} mm</div>
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; {% if 'High' in rain_risk_level %}background: #ef4444; color: white;{% elif 'Moderate' in rain_risk_level %}background: #f97316; color: white;{% else %}background: #10b981; color: white;{% endif %}">{{ rain_risk_level }}</span>
                </div>
                <div style="font-size: 11px; color: #d1d5db; margin-left: 4px;">
                    {% if 'High' in rain_risk_level %}⚠️ Heavy rainfall detected - Immediate flood risk{% elif 'Moderate' in rain_risk_level %}⚡ Significant precipitation - Monitor closely{% else %}✓ Normal rainfall levels - Low flood threat{% endif %}
                </div>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div><strong>🌊 Tide Level:</strong> {{ tide_data.height_m }} m</div>
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; {% if 'High' in tide_risk_level %}background: #ef4444; color: white;{% elif 'Moderate' in tide_risk_level %}background: #f97316; color: white;{% else %}background: #10b981; color: white;{% endif %}">{{ tide_risk_level }}</span>
                </div>
                <div style="font-size: 11px; color: #d1d5db; margin-left: 4px;">
                    {% if 'High' in tide_risk_level %}⚠️ Very high tide - Coastal flooding probable{% elif 'Moderate' in tide_risk_level %}⚡ Elevated tide - Reduced drainage capacity{% else %}✓ Normal tide levels - Adequate drainage{% endif %}
                </div>
            </div>
            
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.15); font-size: 12px;">
                <strong>📊 Overall Risk:</strong>
                <div style="margin-top: 6px; color: #d1d5db;">
                    {% if 'High Risk' in combined_risk_level %}
                    <span style="color: #fca5a5;">🔴 CRITICAL:</span> Combined rainfall and tide levels create immediate flood threat. Emergency protocols should be activated. Monitor vulnerable areas closely.
                    {% elif 'Moderate Risk' in combined_risk_level %}
                    <span style="color: #fdba74;">🟡 ELEVATED:</span> Weather conditions indicate increased flood potential. Enhanced monitoring recommended. Prepare contingency measures.
                    {% else %}
                    <span style="color: #86efac;">🟢 NORMAL:</span> Current conditions within safe parameters. Continue routine monitoring. Standard flood preparedness protocols apply.
                    {% endif %}
                </div>
            </div>
            
            <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.15); border-radius: 6px; font-size: 11px; color: #bfdbfe;">
                <i class="fas fa-info-circle"></i> <strong>Note:</strong> Risk calculated using benchmark thresholds. Data updates hourly (rainfall/weather) and every 3 hours (tides).
            </div>
        </div>
    </div>

    <!-- Current Data Cards -->
    <div class="card" id="current-conditions">
        <h2>
            <i class="fas fa-gauge-high"></i> Current Conditions
            <span class="status-badge badge-realtime"><span class="live-pulse"></span> Live</span>
            <span class="help-icon">?
                <span class="help-tooltip">Real-time environmental data from Open-Meteo API. Updates hourly for Silay City, Negros Occidental.</span>
            </span>
        </h2>
        <div class="metrics-grid">
            <div class="metric-item">
                <div class="metric-label">
                    <span class="metric-label-text"><i class="fas fa-cloud-rain"></i> Rainfall</span>
                    <span class="weather-icon">{% if rainfall_data.value_mm >= 50 %}🌧️{% elif rainfall_data.value_mm >= 30 %}🌦️{% elif rainfall_data.value_mm >= 10 %}☁️{% else %}⛅{% endif %}</span>
                </div>
                <div class="metric-value" data-rainfall>{{ rainfall_data.value_mm }} mm<span class="trend-indicator" data-trend-rainfall style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #60a5fa;"><i class="fas fa-cloud-rain"></i> Rainfall Measurement</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ rainfall_data.value_mm }} mm</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Accumulated precipitation in the last hour</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ rainfall_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Risk Assessment:</strong>
                            <div style="margin-top: 4px;">{% if rainfall_data.value_mm >= 50 %}<span style="color: #ef4444; font-weight: 600;">⚠️ HIGH RISK</span> - Heavy rainfall (≥50mm). Flood threat imminent. Activate emergency protocols.{% elif rainfall_data.value_mm >= 30 %}<span style="color: #f97316; font-weight: 600;">⚡ MODERATE RISK</span> - Significant rainfall (30-50mm). Increased flood potential. Monitor closely.{% else %}<span style="color: #10b981; font-weight: 600;">✓ LOW RISK</span> - Light rainfall (<30mm). Normal conditions. Continue routine monitoring.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label">
                    <span class="metric-label-text"><i class="fas fa-thermometer-half"></i> Temperature</span>
                    <span class="weather-icon">{% if weather_data.temperature_c >= 35 %}🥵{% elif weather_data.temperature_c >= 32 %}☀️{% elif weather_data.temperature_c >= 28 %}🌤️{% elif weather_data.temperature_c >= 24 %}⛅{% else %}🌥️{% endif %}</span>
                </div>
                <div class="metric-value" data-temperature>{{ weather_data.temperature_c }}°C<span class="trend-indicator" data-trend-temperature style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #f87171;"><i class="fas fa-thermometer-half"></i> Air Temperature</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ weather_data.temperature_c }}°C</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Measured at 2 meters above ground level</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ weather_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Flood Impact:</strong>
                            <div style="margin-top: 4px;">{% if weather_data.temperature_c > 32 %}<span style="color: #ef4444; font-weight: 600;">🔥 HIGH IMPACT</span> - Elevated temperatures (>32°C) increase atmospheric moisture and evaporation, potentially intensifying rainfall events.{% elif weather_data.temperature_c > 28 %}<span style="color: #f97316; font-weight: 600;">🌡️ MODERATE</span> - Warm conditions (28-32°C). Normal tropical climate parameters.{% else %}<span style="color: #10b981; font-weight: 600;">✓ NORMAL</span> - Temperature within typical range (<28°C). Standard conditions for the region.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label">
                    <span class="metric-label-text"><i class="fas fa-tint"></i> Humidity</span>
                    <span class="weather-icon">{% if weather_data.humidity_percent >= 90 %}💦{% elif weather_data.humidity_percent >= 80 %}💧{% elif weather_data.humidity_percent >= 60 %}💨{% else %}☀️{% endif %}</span>
                </div>
                <div class="metric-value" data-humidity>{{ weather_data.humidity_percent }}%<span class="trend-indicator" data-trend-humidity style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #8b5cf6;"><i class="fas fa-tint"></i> Relative Humidity</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ weather_data.humidity_percent }}%</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Atmospheric moisture content at 2m height</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ weather_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Flood Impact:</strong>
                            <div style="margin-top: 4px;">{% if weather_data.humidity_percent > 85 %}<span style="color: #ef4444; font-weight: 600;">💧 CRITICAL</span> - Very high humidity (>85%). Air is saturated with moisture, reducing evaporation capacity. Rainfall will accumulate rapidly, increasing flood risk significantly.{% elif weather_data.humidity_percent > 70 %}<span style="color: #f97316; font-weight: 600;">⚡ ELEVATED</span> - High humidity (70-85%). Moisture-laden air increases precipitation potential and reduces natural drainage.{% else %}<span style="color: #10b981; font-weight: 600;">✓ NORMAL</span> - Moderate humidity (<70%). Adequate evaporation capacity. Standard atmospheric conditions.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label">
                    <span class="metric-label-text"><i class="fas fa-wind"></i> Wind Speed</span>
                    <span class="weather-icon">{% if weather_data.wind_speed_kph >= 60 %}🌪️{% elif weather_data.wind_speed_kph >= 40 %}💨{% elif weather_data.wind_speed_kph >= 20 %}🍃{% else %}🌾{% endif %}</span>
                </div>
                <div class="metric-value" data-wind>{{ weather_data.wind_speed_kph }} km/h<span class="trend-indicator" data-trend-wind style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #fbbf24;"><i class="fas fa-wind"></i> Wind Speed</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ weather_data.wind_speed_kph }} km/h</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Measured at 10 meters above ground level</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ weather_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Weather Impact:</strong>
                            <div style="margin-top: 4px;">{% if weather_data.wind_speed_kph > 60 %}<span style="color: #ef4444; font-weight: 600;">🌪️ STORM WARNING</span> - Strong winds (>60 km/h). Potential tropical storm or typhoon. Severe weather alert. Compound flood risk.{% elif weather_data.wind_speed_kph > 40 %}<span style="color: #f97316; font-weight: 600;">💨 HIGH WINDS</span> - Strong breeze (40-60 km/h). Associated with weather systems. Monitor for storm development.{% elif weather_data.wind_speed_kph > 20 %}<span style="color: #fbbf24; font-weight: 600;">🍃 MODERATE</span> - Moderate winds (20-40 km/h). Fresh breeze conditions. Normal weather variability.{% else %}<span style="color: #10b981; font-weight: 600;">✓ CALM</span> - Light winds (<20 km/h). Gentle breeze or calm conditions. Stable weather pattern.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label">
                    <span class="metric-label-text"><i class="fas fa-water"></i> Tide Level</span>
                    <span class="weather-icon">{% if tide_data.height_m >= 1.5 %}🌊{% elif tide_data.height_m >= 1.0 %}🏖️{% else %}🏝️{% endif %}</span>
                </div>
                <div class="metric-value" data-tide>{{ tide_data.height_m }} m<span class="trend-indicator" data-trend-tide style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #10b981;"><i class="fas fa-water"></i> Tidal Height</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ tide_data.height_m }} m</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Height relative to Mean Sea Level (MSL)</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Monitoring Station:</strong> Cebu City</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.3157°N, 123.8854°E</div>
                            <div style="color: #9ca3af; font-size: 10px; margin-top: 2px;">Data applicable to coastal areas of Negros Occidental</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> WorldTides API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ tide_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 3 hours</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Flood Impact:</strong>
                            <div style="margin-top: 4px;">{% if tide_data.height_m >= 1.5 %}<span style="color: #ef4444; font-weight: 600;">🌊 HIGH TIDE ALERT</span> - Very high tide (≥1.5m). Combined with rainfall, creates critical flood conditions in low-lying coastal areas. Storm surge potential.{% elif tide_data.height_m >= 1.0 %}<span style="color: #f97316; font-weight: 600;">⚠️ ELEVATED TIDE</span> - High tide (1.0-1.5m). Increased coastal flood risk. Drainage systems may be impeded. Monitor vulnerable areas.{% elif tide_data.height_m >= 0 %}<span style="color: #10b981; font-weight: 600;">✓ NORMAL TIDE</span> - Moderate tide level (0-1.0m). Standard tidal conditions. Natural drainage functioning normally.{% else %}<span style="color: #3b82f6; font-weight: 600;">🌑 LOW TIDE</span> - Below mean sea level (<0m). Optimal drainage conditions. Reduced coastal flood risk.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Forecast Section -->
    <div class="card collapsible" id="weather-forecast">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-cloud-sun"></i> 7-Day Weather Forecast
                <span class="status-badge badge-updated">Open-Meteo</span>
                <span class="help-icon">?
                    <span class="help-tooltip">Weather predictions for Silay City. Includes temperature, precipitation, humidity, and wind speed. Updates hourly.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">
        <div class="toggle-switch" style="margin-bottom: 16px;">
            <input type="checkbox" id="toggleForecast" onchange="toggleView('forecast')">
            <label for="toggleForecast">Show Table View</label>
        </div>
        
        <!-- Forecast Chart View -->
        <div id="forecastChart">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Temperature Forecast (°C)</h3>
                    <canvas id="temperatureForecastChart"></canvas>
                    <div class="chart-insight" id="temp-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading temperature analysis...</span>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Precipitation Forecast (mm)</h3>
                    <canvas id="precipitationForecastChart"></canvas>
                    <div class="chart-insight" id="precip-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading precipitation analysis...</span>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Humidity Forecast (%)</h3>
                    <canvas id="humidityForecastChart"></canvas>
                    <div class="chart-insight" id="humidity-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading humidity analysis...</span>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Wind Speed Forecast (km/h)</h3>
                    <canvas id="windSpeedForecastChart"></canvas>
                    <div class="chart-insight" id="wind-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading wind analysis...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Forecast Table View -->
        <div id="forecastTable" class="hidden">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Min Temp</th>
                        <th>Max Temp</th>
                        <th>Precipitation</th>
                        <th>Humidity</th>
                        <th>Wind Speed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in weather_forecast %}
                    <tr>
                        <td>{{ day.formatted_date }}</td>
                        <td>{{ day.temp_min|floatformat:1 }}°C</td>
                        <td>{{ day.temp_max|floatformat:1 }}°C</td>
                        <td>{{ day.precipitation|floatformat:1 }} mm</td>
                        <td>{{ day.humidity|floatformat:0 }}%</td>
                        <td>{{ day.wind_speed|floatformat:1 }} km/h</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6">No forecast data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- Flood Prediction Insights -->
    <div class="card collapsible" id="insights">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-lightbulb"></i> Forecast Insights
                <span class="status-badge badge-updated">Generated</span>
                <span class="help-icon">?
                    <span class="help-tooltip">Intelligent analysis combining forecast data with historical patterns. Provides risk alerts and recommendations.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">

        {% if insights.risk_alerts %}
        <div class="insights-section">
            <h3><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Risk Alerts</h3>
            <div class="alerts-container">
                {% for alert in insights.risk_alerts %}
                <div class="alert-card alert-{{ alert.severity }}">
                    <div class="alert-header">{% if alert.type == 'warning' %}<i class="fas fa-exclamation-triangle"></i>{% else %}<i class="fas fa-info-circle"></i>{% endif %} {{ alert.title }}</div>
                    <div class="alert-message">{{ alert.message }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if insights.forecast_analysis %}
        <div class="insights-section">
            <h3><i class="fas fa-chart-line" style="color: var(--secondary-blue);"></i> Forecast Analysis</h3>
            <div class="analysis-grid">
                {% for analysis in insights.forecast_analysis %}
                <div class="analysis-card impact-{{ analysis.impact }}">
                    <div class="analysis-title">{{ analysis.title }}</div>
                    <div class="analysis-content">{{ analysis.analysis }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if insights.recommendations %}
        <div class="insights-section">
            <h3><i class="fas fa-lightbulb" style="color: #10b981;"></i> Recommended Actions</h3>
            <div class="recommendations-list">
                {% for rec in insights.recommendations %}
                <div class="recommendation-item">
                    <span class="priority-badge {{ rec.priority }}">{{ rec.priority }}</span>
                    <div class="recommendation-content">
                        <div class="recommendation-action">{{ rec.action }}</div>
                        <div class="recommendation-reason">{{ rec.reason }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if insights.trends %}
        <div class="insights-section">
            <h3><i class="fas fa-history" style="color: #8b5cf6;"></i> Historical Context</h3>
            <div class="trends-container">
                {% for trend in insights.trends %}
                <div class="trend-card">
                    <div class="trend-title">{{ trend.title }}</div>
                    <div class="trend-analysis">{{ trend.analysis }}</div>
                    {% if trend.recommendation %}<div class="trend-recommendation">{{ trend.recommendation }}</div>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    <!-- Rainfall and Tide Trends -->
    <div class="card collapsible" id="trends">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-chart-line"></i> Rainfall and Tide Level Historical Trends
                <span class="status-badge badge-historical">Time Series</span>
                <span class="help-icon">?
                    <span class="help-tooltip">Historical rainfall and tide level data. Filter by time range or compare multiple years. Export to PDF.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">
        
        <!-- Export Button - Always Visible -->
        <div class="export-buttons">
            <button onclick="exportTrendsPDF()" id="export-trends-pdf" class="export-btn pdf" style="border: none; cursor: pointer;">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
        </div>

        <!-- Active Filter Display -->
        <div class="active-filter-badge">
            <i class="fas fa-filter"></i>
            <span>Currently Viewing:</span>
            <span class="filter-value" id="active-filter-display">{{ range_label }}</span>
        </div>
        
        <!-- Tabbed Filter Interface -->
        <div class="filter-tabs-container">
            <div class="filter-tabs">
                <button class="filter-tab active" data-tab="quick-range">
                    <i class="fas fa-clock"></i> Quick Range
                </button>
                <button class="filter-tab" data-tab="compare-years">
                    <i class="fas fa-layer-group"></i> Compare Years
                </button>
                <button class="filter-tab" data-tab="custom-dates">
                    <i class="fas fa-calendar-alt"></i> Custom Dates
                </button>
            </div>

            <!-- Quick Range Tab -->
            <div class="filter-tab-content active" id="quick-range-tab">
                <div style="margin-bottom: 12px;">
                    <label style="font-weight: 700; font-size: 13px; color: #374151; display: block; margin-bottom: 12px;">
                        <i class="fas fa-info-circle" style="color: #3b82f6;"></i> 
                        Select a predefined time range to view recent data
                    </label>
                </div>
                <div class="range-buttons">
                    <button data-time-range="24h" class="time-range-btn {% if time_range == '24h' or not time_range %}btn-primary{% endif %}">24 Hours</button>
                    <button data-time-range="7d" class="time-range-btn {% if time_range == '7d' %}btn-primary{% endif %}">7 Days</button>
                    <button data-time-range="30d" class="time-range-btn {% if time_range == '30d' %}btn-primary{% endif %}">30 Days</button>
                    <button data-time-range="90d" class="time-range-btn {% if time_range == '90d' %}btn-primary{% endif %}">90 Days</button>
                    <button data-time-range="all" class="time-range-btn {% if time_range == 'all' %}btn-primary{% endif %}">All Time</button>
                </div>
            </div>

            <!-- Compare Years Tab -->
            <div class="filter-tab-content" id="compare-years-tab">
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 700; font-size: 13px; color: #374151; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-info-circle" style="color: #3b82f6;"></i> 
                        Compare data across multiple years
                    </label>
                    <p style="font-size: 12px; color: #6b7280; margin: 0; line-height: 1.5;">
                        Select one year to view it alone, or multiple years to overlay them for comparison. 
                        The time range from the Quick Range tab will apply to your selected years.
                    </p>
                </div>
                
                <div class="year-selection-grid">
                    <div class="year-checkbox-wrapper">
                        <label class="year-checkbox-label">
                            <input type="checkbox" class="year-comparison-checkbox" value="2025" checked style="accent-color: #473472;">
                            <span>2025 (Current)</span>
                        </label>
                    </div>
                    <div class="year-checkbox-wrapper">
                        <label class="year-checkbox-label">
                            <input type="checkbox" class="year-comparison-checkbox" value="2024" style="accent-color: #53629E;">
                            <span>2024</span>
                        </label>
                    </div>
                    <div class="year-checkbox-wrapper">
                        <label class="year-checkbox-label">
                            <input type="checkbox" class="year-comparison-checkbox" value="2023" style="accent-color: #87BAC3;">
                            <span>2023</span>
                        </label>
                    </div>
                </div>
                
                <div id="selected-years-display" style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 6px; font-size: 13px; color: #1e40af; display: none;">
                    <strong><i class="fas fa-eye"></i> Viewing:</strong> <span id="selected-years-list"></span>
                </div>
            </div>

            <!-- Custom Dates Tab -->
            <div class="filter-tab-content" id="custom-dates-tab">
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 700; font-size: 13px; color: #374151; display: block; margin-bottom: 8px;">
                        <i class="fas fa-info-circle" style="color: #3b82f6;"></i> 
                        Select month and day range
                    </label>
                    <p style="font-size: 12px; color: #6b7280; margin: 0; line-height: 1.5;">
                        Choose start and end dates (year is determined by Compare Years selection).
                    </p>
                </div>
                
                <div class="date-inputs-row">
                    <div class="date-input-group">
                        <label>Start Month/Day</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="start-month" class="month-day-select">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="start-day" class="month-day-select">
                                <option value="">Day</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="align-self: flex-end; padding-bottom: 12px; color: #9ca3af; font-weight: 700;">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    
                    <div class="date-input-group">
                        <label>End Month/Day</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="end-month" class="month-day-select">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="end-day" class="month-day-select">
                                <option value="">Day</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="toggle-switch" style="margin-bottom: 16px;">
            <input type="checkbox" id="toggleTrends" onchange="toggleView('trends')">
            <label for="toggleTrends">Show Table View</label>
        </div>
        
        <!-- Chart View -->
        <div id="trendsChart">
            <div class="trends-charts-grid">
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">Rainfall Trend</h3>
                        <button onclick="rainfallTrendChart.resetZoom()" style="padding: 6px 14px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                            <i class="fas fa-search-minus"></i> Reset Zoom
                        </button>
                    </div>
                    <canvas id="rainfallTrendChart"></canvas>
                    <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; font-size: 12px; color: #92400e;">
                        <i class="fas fa-lightbulb"></i> <strong>How to use:</strong><br>
                        <span style="margin-left: 20px;">1️⃣ <strong>Zoom in:</strong> Scroll mouse wheel UP over the chart</span><br>
                        <span style="margin-left: 20px;">2️⃣ <strong>Pan:</strong> After zooming in, click and drag left/right to navigate</span><br>
                        <span style="margin-left: 20px;">3️⃣ <strong>Reset:</strong> Click "Reset Zoom" button above</span>
                    </div>
                </div>

                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">Tide Level Trend</h3>
                        <button onclick="tideTrendChart.resetZoom()" style="padding: 6px 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                            <i class="fas fa-search-minus"></i> Reset Zoom
                        </button>
                    </div>
                    <canvas id="tideTrendChart"></canvas>
                    <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; font-size: 12px; color: #92400e;">
                        <i class="fas fa-lightbulb"></i> <strong>How to use:</strong><br>
                        <span style="margin-left: 20px;">1️⃣ <strong>Zoom in:</strong> Scroll mouse wheel UP over the chart</span><br>
                        <span style="margin-left: 20px;">2️⃣ <strong>Pan:</strong> After zooming in, click and drag left/right to navigate</span><br>
                        <span style="margin-left: 20px;">3️⃣ <strong>Reset:</strong> Click "Reset Zoom" button above</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Table View -->
        <div id="trendsTable" class="hidden">
            <table>
                <thead>
                    <tr><th>Timestamp</th><th>Rainfall (mm)</th><th>Tide Level (m)</th></tr>
                </thead>
                <tbody id="trendsTableBody"></tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- Flood Records Analysis -->
    <div class="card collapsible" id="analysis">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-chart-bar"></i> Flood Impact Analysis
                <span class="status-badge badge-historical">Statistics</span>
                <span class="help-icon">?
                    <span class="help-tooltip">Statistical analysis of past flood events. View casualties, affected populations, property damage, and economic impact.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">
        
        <div class="impact-analysis-header">
            <button onclick="openEventRecordsModal()" class="view-records-btn view-records-tab">
                <i class="fas fa-database"></i>
                <span>Event Records</span>
                <span class="records-badge">{{ flood_records|length }}</span>
            </button>
        </div>

        <div class="impact-grid">
            <!-- Casualties Graph -->
            <div class="impact-grid-item">
                <div class="impact-header">
                    <h3><i class="fas fa-user-injured"></i> Casualties</h3>
                    <div class="impact-header-actions">
                        <button class="fullscreen-btn" onclick="openFullscreenChart('casualties')" title="View Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggleCasualties" onchange="toggleView('casualties')">
                            <label for="toggleCasualties">Table</label>
                        </div>
                    </div>
                </div>
                <div id="casualtiesChart-container">
                    <canvas id="casualtiesChart"></canvas>
                </div>
                <div class="chart-insight" id="casualties-insight">
                    <i class="fas fa-lightbulb"></i>
                    <span>Loading casualties analysis...</span>
                </div>
                <table id="casualtiesTable" class="hidden">
                    <thead><tr><th>Date</th><th>Dead</th><th>Injured</th><th>Missing</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>{{ record.casualties_dead }}</td><td>{{ record.casualties_injured }}</td><td>{{ record.casualties_missing }}</td></tr>{% empty %}<tr><td colspan="4">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Affected Individuals Graph -->
            <div class="impact-grid-item">
                <div class="impact-header">
                    <h3><i class="fas fa-users"></i> Affected Individuals</h3>
                    <div class="impact-header-actions">
                        <button class="fullscreen-btn" onclick="openFullscreenChart('affected')" title="View Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggleAffected" onchange="toggleView('affected')">
                            <label for="toggleAffected">Table</label>
                        </div>
                    </div>
                </div>
                <div id="affectedChart-container">
                    <canvas id="affectedChart"></canvas>
                </div>
                <div class="chart-insight" id="affected-insight">
                    <i class="fas fa-lightbulb"></i>
                    <span>Loading affected individuals analysis...</span>
                </div>
                <table id="affectedTable" class="hidden">
                    <thead><tr><th>Date</th><th>Persons</th><th>Families</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>{{ record.affected_persons }}</td><td>{{ record.affected_families }}</td></tr>{% empty %}<tr><td colspan="3">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Houses Damaged Graph -->
            <div class="impact-grid-item">
                <div class="impact-header">
                    <h3><i class="fas fa-home"></i> Houses Damaged</h3>
                    <div class="impact-header-actions">
                        <button class="fullscreen-btn" onclick="openFullscreenChart('houses')" title="View Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggleHouses" onchange="toggleView('houses')">
                            <label for="toggleHouses">Table</label>
                        </div>
                    </div>
                </div>
                <div id="housesChart-container">
                    <canvas id="housesChart"></canvas>
                </div>
                <div class="chart-insight" id="houses-insight">
                    <i class="fas fa-lightbulb"></i>
                    <span>Loading houses damage analysis...</span>
                </div>
                <table id="housesTable" class="hidden">
                    <thead><tr><th>Date</th><th>Partially</th><th>Totally</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>{{ record.houses_damaged_partially }}</td><td>{{ record.houses_damaged_totally }}</td></tr>{% empty %}<tr><td colspan="3">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Property Damage Graph -->
            <div class="impact-grid-item">
                <div class="impact-header">
                    <h3><i class="fas fa-dollar-sign"></i> Property Damage</h3>
                    <div class="impact-header-actions">
                        <button class="fullscreen-btn" onclick="openFullscreenChart('damage')" title="View Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggleDamage" onchange="toggleView('damage')">
                            <label for="toggleDamage">Table</label>
                        </div>
                    </div>
                </div>
                <div id="damageChart-container">
                    <canvas id="damageChart"></canvas>
                </div>
                <div class="chart-insight" id="damage-insight">
                    <i class="fas fa-lightbulb"></i>
                    <span>Loading property damage analysis...</span>
                </div>
                <table id="damageTable" class="hidden">
                    <thead><tr><th>Date</th><th>Infrastructure</th><th>Agriculture</th><th>Institutions</th><th>Private</th><th>Total</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>₱{{ record.damage_infrastructure_php|floatformat:0 }}</td><td>₱{{ record.damage_agriculture_php|floatformat:0 }}</td><td>₱{{ record.damage_institutions_php|floatformat:0 }}</td><td>₱{{ record.damage_private_commercial_php|floatformat:0 }}</td><td>₱{{ record.damage_total_php|floatformat:0 }}</td></tr>{% empty %}<tr><td colspan="6">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <!-- Event Records Modal -->
    <div id="eventRecordsModal" class="event-records-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-database"></i>
                    Event Records
                    <span style="background: #eff6ff; color: var(--secondary-blue); padding: 4px 12px; border-radius: 6px; font-size: 13px; margin-left: 8px; font-weight: 600;">
                        <span id="modal-record-count">{{ flood_records|length }}</span> Events
                    </span>
                </h2>
                <button onclick="closeEventRecordsModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Filter Section -->
                <div class="flood-records-filter">
                    <div class="filter-header">
                        <i class="fas fa-filter"></i> Filter Records by Year
                    </div>
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="filter-start-year">From Year:</label>
                            <select id="filter-start-year" class="year-select">
                                <option value="">-- All Years --</option>
                                {% for year in available_years %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filter-end-year">To Year:</label>
                            <select id="filter-end-year" class="year-select">
                                <option value="">-- All Years --</option>
                                {% for year in available_years %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="export-buttons records-export">
                    <a href="{% url 'export_flood_records' %}?type=pdf" class="export-btn pdf" id="export-pdf-btn">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </a>
                    <a href="{% url 'flood_record_form' %}" class="add-record-btn">
                        <i class="fas fa-plus-circle"></i> Add New Flood Record
                    </a>
                </div>
                
                <div class="flood-records-table-container">
                    <table class="flood-records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Event</th>
                                <th>Barangays</th>
                                <th>Dead</th>
                                <th>Injured</th>
                                <th>Missing</th>
                                <th>Affected Persons</th>
                                <th>Affected Families</th>
                                <th>Houses (Partial/Total)</th>
                                <th>Infrastructure Damage</th>
                                <th>Agriculture Damage</th>
                                <th>Institutions Damage</th>
                                <th>Private/Commercial Damage</th>
                                <th>Total Damage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in flood_records %}
                            <tr>
                                <td>{{ record.date|date:"Y-m-d" }}</td>
                                <td>{{ record.event }}</td>
                                <td>{{ record.affected_barangays }}</td>
                                <td>{{ record.casualties_dead_fmt }}</td>
                                <td>{{ record.casualties_injured_fmt }}</td>
                                <td>{{ record.casualties_missing_fmt }}</td>
                                <td>{{ record.affected_persons_fmt }}</td>
                                <td>{{ record.affected_families_fmt }}</td>
                                <td>{{ record.houses_damaged_partially_fmt }}/{{ record.houses_damaged_totally_fmt }}</td>
                                <td>₱{{ record.damage_infrastructure_php_fmt }}</td>
                                <td>₱{{ record.damage_agriculture_php_fmt }}</td>
                                <td>₱{{ record.damage_institutions_php_fmt }}</td>
                                <td>₱{{ record.damage_private_commercial_php_fmt }}</td>
                                <td>₱{{ record.damage_total_php_fmt }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'flood_record_edit' record.id %}" class="btn btn-edit"><i class="fas fa-edit"></i></a>
                                        <a href="{% url 'flood_record_delete' record.id %}" class="btn btn-delete"><i class="fas fa-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="15">No flood records available</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Empty State for Filtered Results -->
                <div class="empty-state" id="flood-records-empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-filter"></i>
                    </div>
                    <div class="empty-state-title">No Flood Records Found</div>
                    <div class="empty-state-text">
                        No flood records match the selected year range. Try adjusting your filters or reset to view all records.
                    </div>
                </div>
        </div>
    </div>
</div>

<!-- Fullscreen Chart Modal -->
<div id="fullscreenChartModal" class="fullscreen-chart-modal">
    <div class="fullscreen-chart-content">
        <div class="fullscreen-chart-header">
            <h2>
                <i id="fullscreen-chart-icon" class="fas fa-chart-bar"></i>
                <span id="fullscreen-chart-title">Chart</span>
            </h2>
            <button onclick="closeFullscreenChart()" class="fullscreen-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="fullscreen-chart-body">
            <canvas id="fullscreenChart"></canvas>
        </div>
    </div>
</div>

<!-- Back to Top Button -->
<button id="back-to-top" class="back-to-top" title="Back to top">
    <i class="fas fa-chevron-up"></i>
</button>

<!-- Keyboard Shortcuts Hint -->
<div class="keyboard-hint" id="keyboard-hint">
    <strong>Keyboard Shortcuts:</strong><br>
    Press <kbd>1-6</kbd> to jump to sections | <kbd>?</kbd> to show/hide this help
</div>

<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="{% static 'js/chart.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
    let rainfallTrendChart, tideTrendChart;

    document.addEventListener('DOMContentLoaded', function() {
        // Back to Top Button Functionality
        const backToTopButton = document.getElementById('back-to-top');
        
        console.log('Back to Top Button:', backToTopButton);
        
        if (backToTopButton) {
            console.log('Button found! Setting up event listeners...');
            
            // Show/hide button based on scroll position
            function toggleBackToTop() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                console.log('Scroll position:', scrollTop);
                if (scrollTop > 300) {
                    backToTopButton.classList.add('show');
                    console.log('Button should be visible');
                } else {
                    backToTopButton.classList.remove('show');
                    console.log('Button should be hidden');
                }
            }
            
            // Check on scroll
            window.addEventListener('scroll', toggleBackToTop);
            
            // Smooth scroll to top when clicked
            backToTopButton.addEventListener('click', function(e) {
                console.log('Button clicked!');
                e.preventDefault();
                e.stopPropagation();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // Initial check
            toggleBackToTop();
        } else {
            console.error('Back to top button not found in DOM!');
        }
        
        // Open Event Records modal if hash is present
        if (window.location.hash === '#flood-records') {
            setTimeout(() => {
                openEventRecordsModal();
            }, 100);
        }

        // Initialize rainfall trend chart
        const ctxRainfallTrend = document.getElementById('rainfallTrendChart').getContext('2d');
        const gradientRainfall = ctxRainfallTrend.createLinearGradient(0, 0, 0, 400);
        gradientRainfall.addColorStop(0, 'rgba(71, 52, 114, 0.4)');
        gradientRainfall.addColorStop(0.5, 'rgba(71, 52, 114, 0.2)');
        gradientRainfall.addColorStop(1, 'rgba(71, 52, 114, 0.0)');

        rainfallTrendChart = new Chart(ctxRainfallTrend, {
            type: 'line',
            data: {
                labels: {{ rainfall_timestamps|safe }},
                datasets: [{
                    label: 'Rainfall (mm)',
                    data: {{ rainfall_values|safe }},
                    backgroundColor: gradientRainfall,
                    borderColor: 'rgba(71, 52, 114, 1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(71, 52, 114, 1)',
                    pointBorderWidth: 3,
                    pointHoverBackgroundColor: 'rgba(71, 52, 114, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    segment: {
                        borderColor: ctx => {
                            // Make line segments semi-transparent for smoother look
                            return 'rgba(71, 52, 114, 0.9)';
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            font: { size: 13, weight: '600', family: "'Inter', 'Segoe UI', sans-serif" },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 8,
                            boxHeight: 8
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(59, 130, 246, 0.5)',
                        borderWidth: 1,
                        padding: 16,
                        displayColors: true,
                        titleFont: { size: 14, weight: '700', family: "'Inter', 'Segoe UI', sans-serif" },
                        bodyFont: { size: 13, weight: '500', family: "'Inter', 'Segoe UI', sans-serif" },
                        cornerRadius: 8,
                        caretSize: 8,
                        callbacks: {
                            label: function(context) {
                                return ' ' + context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' mm';
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                                speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        limits: {
                            x: {min: 'original', max: 'original'},
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            drawBorder: false,
                            lineWidth: 1
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            font: { size: 12, weight: '500', family: "'Inter', 'Segoe UI', sans-serif" },
                            padding: 10,
                            color: '#64748b',
                            callback: function(value) {
                                return value + ' mm';
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            font: { size: 11, weight: '500', family: "'Inter', 'Segoe UI', sans-serif" },
                            maxRotation: 45,
                            minRotation: 45,
                            color: '#64748b',
                            padding: 8
                        }
                    }
                },
                animation: {
                    duration: 1200,
                    easing: 'easeInOutCubic'
                },
                elements: {
                    line: {
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round'
                    }
                }
            }
        });

        // Initialize tide trend chart
        const ctxTideTrend = document.getElementById('tideTrendChart').getContext('2d');
        const gradientTide = ctxTideTrend.createLinearGradient(0, 0, 0, 400);
        gradientTide.addColorStop(0, 'rgba(71, 52, 114, 0.4)');
        gradientTide.addColorStop(0.5, 'rgba(71, 52, 114, 0.2)');
        gradientTide.addColorStop(1, 'rgba(71, 52, 114, 0.0)');

        tideTrendChart = new Chart(ctxTideTrend, {
            type: 'line',
            data: {
                labels: {{ tide_timestamps|safe }},
                datasets: [{
                    label: 'Tide Level (m)',
                    data: {{ tide_values|safe }},
                    backgroundColor: gradientTide,
                    borderColor: 'rgba(71, 52, 114, 1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(71, 52, 114, 1)',
                    pointBorderWidth: 3,
                    pointHoverBackgroundColor: 'rgba(71, 52, 114, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    segment: {
                        borderColor: ctx => {
                            return 'rgba(71, 52, 114, 0.9)';
                        }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            font: { size: 13, weight: '600', family: "'Inter', 'Segoe UI', sans-serif" },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 8,
                            boxHeight: 8
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(16, 185, 129, 0.5)',
                        borderWidth: 1,
                        padding: 16,
                        displayColors: true,
                        titleFont: { size: 14, weight: '700', family: "'Inter', 'Segoe UI', sans-serif" },
                        bodyFont: { size: 13, weight: '500', family: "'Inter', 'Segoe UI', sans-serif" },
                        cornerRadius: 8,
                        caretSize: 8,
                        callbacks: {
                            label: function(context) {
                                return ' ' + context.dataset.label + ': ' + context.parsed.y.toFixed(3) + ' m';
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                                speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        limits: {
                            x: {min: 'original', max: 'original'},
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            drawBorder: false,
                            lineWidth: 1
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            font: { size: 12, weight: '500', family: "'Inter', 'Segoe UI', sans-serif" },
                            padding: 10,
                            color: '#64748b',
                            callback: function(value) {
                                return value.toFixed(2) + ' m';
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        border: {
                            display: false
                        },
                        ticks: {
                            font: { size: 11, weight: '500', family: "'Inter', 'Segoe UI', sans-serif" },
                            maxRotation: 45,
                            minRotation: 45,
                            color: '#64748b',
                            padding: 8
                        }
                    }
                },
                animation: {
                    duration: 1200,
                    easing: 'easeInOutCubic'
                },
                elements: {
                    line: {
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round'
                    }
                }
            }
        });

        // Filter Tab Switching
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.filter-tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                this.classList.add('active');
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });

        // Time range buttons
        document.querySelectorAll('.time-range-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const timeRange = this.getAttribute('data-time-range');
                
                // Remove active class from all buttons
                document.querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                });
                
                // Add active class to clicked button
                this.classList.add('btn-primary');
                
                updateTimeRange(timeRange);
            });
        });

        // Populate day dropdowns based on month selection
        function populateDays(monthSelectId, daySelectId) {
            const monthSelect = document.getElementById(monthSelectId);
            const daySelect = document.getElementById(daySelectId);
            const month = monthSelect.value;
            
            if (!month) return;
            
            const year = new Date().getFullYear();
            const daysInMonth = new Date(year, parseInt(month), 0).getDate();
            
            daySelect.innerHTML = '<option value="">Day</option>';
            for (let i = 1; i <= daysInMonth; i++) {
                const day = i < 10 ? '0' + i : i.toString();
                daySelect.innerHTML += `<option value="${day}">${i}</option>`;
            }
        }
        
        // Initialize day dropdowns with current month
        document.getElementById('start-month').value = new Date().getMonth() + 1 < 10 ? '0' + (new Date().getMonth() + 1) : (new Date().getMonth() + 1).toString();
        document.getElementById('end-month').value = new Date().getMonth() + 1 < 10 ? '0' + (new Date().getMonth() + 1) : (new Date().getMonth() + 1).toString();
        populateDays('start-month', 'start-day');
        populateDays('end-month', 'end-day');
        
        // Month change event listeners
        document.getElementById('start-month').addEventListener('change', function() {
            populateDays('start-month', 'start-day');
            handleStartDateChange();
        });
        document.getElementById('end-month').addEventListener('change', function() {
            populateDays('end-month', 'end-day');
            handleEndDateChange();
        });
        
        // Day change event listeners
        document.getElementById('start-day').addEventListener('change', handleStartDateChange);
        document.getElementById('end-day').addEventListener('change', handleEndDateChange);
        
        // Year selection event listeners - checkbox change triggers immediate update
        document.querySelectorAll('.year-comparison-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', applyYearComparison);
        });
        
        updateTrendsTable({{ rainfall_timestamps|safe }}, {{ rainfall_values|safe }}, {{ tide_values|safe }});
    });

    function updateTimeRange(timeRange) {
        document.getElementById('active-filter-display').innerHTML = 'Loading...';

        // Clear custom date inputs when switching to quick range
        const startMonthEl = document.getElementById('start-month');
        const endMonthEl = document.getElementById('end-month');
        const startDayEl = document.getElementById('start-day');
        const endDayEl = document.getElementById('end-day');
        
        if (startMonthEl && endMonthEl && startDayEl && endDayEl) {
            startMonthEl.value = new Date().getMonth() + 1 < 10 ? '0' + (new Date().getMonth() + 1) : (new Date().getMonth() + 1).toString();
            endMonthEl.value = new Date().getMonth() + 1 < 10 ? '0' + (new Date().getMonth() + 1) : (new Date().getMonth() + 1).toString();
            startDayEl.value = '';
            endDayEl.value = '';
            if (typeof populateDays === 'function') {
                populateDays('start-month', 'start-day');
                populateDays('end-month', 'end-day');
            }
        }

        // Get currently selected years from Compare Years checkboxes
        const checkedBoxes = document.querySelectorAll('.year-comparison-checkbox:checked');
        const selectedYears = Array.from(checkedBoxes).map(checkbox => parseInt(checkbox.value));
        
        // If no years selected, default to 2025
        if (selectedYears.length === 0) {
            document.querySelector('.year-comparison-checkbox[value="2025"]').checked = true;
            selectedYears.push(2025);
        }
        
        // Sort years in descending order
        selectedYears.sort((a, b) => b - a);

        // Color mapping for years
        const yearColors = {
            2025: { border: 'rgba(71, 52, 114, 1)', bg: 'rgba(71, 52, 114, 0.2)' }, // Purple
            2024: { border: 'rgba(83, 98, 158, 1)', bg: 'rgba(83, 98, 158, 0.2)' }, // Blue
            2023: { border: 'rgba(135, 186, 195, 1)', bg: 'rgba(135, 186, 195, 0.2)' }  // Light Blue
        };
        
        // Build API URL with selected years
        let apiUrl = `/monitoring/api/trends/?time_range=${timeRange}&`;
        
        if (selectedYears.length === 1) {
            apiUrl += `year=${selectedYears[0]}`;
        } else {
            apiUrl += `compare_years=${selectedYears.join(',')}`;
        }
        
        const yearText = selectedYears.length === 1 ? `${selectedYears[0]}` : `${selectedYears.length} years`;
        document.getElementById('active-filter-display').innerHTML = `Loading ${yearText} data...`;
        
        console.log('Quick Range - Fetching from URL:', apiUrl);
        console.log('Quick Range - Selected years:', selectedYears);
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Quick Range - API Response:', data);
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Update charts based on single or multi-year
                if (selectedYears.length === 1) {
                    // Single year view
                    const year = selectedYears[0];
                    const colors = yearColors[year] || { border: 'rgba(100, 116, 139, 1)', bg: 'rgba(100, 116, 139, 0.2)' };
                    
                    rainfallTrendChart.data.labels = data.rainfall_timestamps;
                    rainfallTrendChart.data.datasets = [{
                        label: `Rainfall ${year} (mm)`,
                        data: data.rainfall_values,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.border,
                        pointHoverBorderWidth: 3
                    }];
                    rainfallTrendChart.update();

                    tideTrendChart.data.labels = data.tide_timestamps;
                    tideTrendChart.data.datasets = [{
                        label: `Tide Level ${year} (m)`,
                        data: data.tide_values,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.border,
                        pointHoverBorderWidth: 3
                    }];
                    tideTrendChart.update();

                    updateTrendsTable(data.rainfall_timestamps, data.rainfall_values, data.tide_values);

                    document.getElementById('active-filter-display').innerHTML = `${data.range_label} (${year})`;
                    document.getElementById('selected-years-display').style.display = 'none';
                } else {
                    // Multi-year comparison view
                    updateChartsWithMultiYearData(data);

                    const yearsList = selectedYears.join(', ');
                    document.getElementById('selected-years-list').textContent = yearsList;
                    document.getElementById('selected-years-display').style.display = 'block';
                    document.getElementById('active-filter-display').innerHTML = `${data.range_label} (${yearsList})`;
                }
            })
            .catch(error => {
                console.error('Quick Range - Error:', error);
                document.getElementById('active-filter-display').innerHTML = 'Error loading data';
                alert('Error loading data. Please try again.');
            });

        // Update export button links with current time range and selected years
        const exportParams = { time_range: timeRange };
        if (selectedYears.length === 1) {
            exportParams.year = selectedYears[0];
        } else if (selectedYears.length > 1) {
            exportParams.compare_years = selectedYears.join(',');
        }
        updateExportLinks(exportParams);
    }

    function handleStartDateChange() {
        const startMonth = document.getElementById('start-month').value;
        const startDay = document.getElementById('start-day').value;
        
        if (startMonth && startDay) {
            // Filter end month/day options to show only dates >= start date
            filterEndDateOptions(parseInt(startMonth), parseInt(startDay));
        } else {
            // If start date is incomplete, reset end date options
            resetEndDateOptions();
        }
        
        // Apply the custom date range filter
        applyCustomDateRange();
    }

    function handleEndDateChange() {
        const endMonth = document.getElementById('end-month').value;
        const endDay = document.getElementById('end-day').value;
        
        if (endMonth && endDay) {
            // Filter start month/day options to show only dates <= end date
            filterStartDateOptions(parseInt(endMonth), parseInt(endDay));
        } else {
            // If end date is incomplete, reset start date options
            resetStartDateOptions();
        }
        
        // Apply the custom date range filter
        applyCustomDateRange();
    }

    function filterEndDateOptions(startMonth, startDay) {
        const endMonthSelect = document.getElementById('end-month');
        const endDaySelect = document.getElementById('end-day');
        
        // Filter month options
        const monthOptions = endMonthSelect.getElementsByTagName('option');
        for (let i = 0; i < monthOptions.length; i++) {
            const option = monthOptions[i];
            const monthValue = option.value;
            
            if (monthValue) {
                const month = parseInt(monthValue);
                option.style.display = month < startMonth ? 'none' : '';
                option.disabled = month < startMonth;
            }
        }
        
        // If currently selected end month is now invalid, reset it
        const currentEndMonth = endMonthSelect.value;
        if (currentEndMonth && parseInt(currentEndMonth) < startMonth) {
            endMonthSelect.value = '';
            endDaySelect.value = '';
            endDaySelect.innerHTML = '<option value="">Day</option>';
            return;
        }
        
        // Filter day options if same month is selected
        if (currentEndMonth && parseInt(currentEndMonth) === startMonth) {
            const dayOptions = endDaySelect.getElementsByTagName('option');
            for (let i = 0; i < dayOptions.length; i++) {
                const option = dayOptions[i];
                const dayValue = option.value;
                
                if (dayValue) {
                    const day = parseInt(dayValue);
                    option.style.display = day < startDay ? 'none' : '';
                    option.disabled = day < startDay;
                }
            }
            
            // If currently selected end day is now invalid, reset it
            const currentEndDay = endDaySelect.value;
            if (currentEndDay && parseInt(currentEndDay) < startDay) {
                endDaySelect.value = '';
            }
        }
    }

    function filterStartDateOptions(endMonth, endDay) {
        const startMonthSelect = document.getElementById('start-month');
        const startDaySelect = document.getElementById('start-day');
        
        // Filter month options
        const monthOptions = startMonthSelect.getElementsByTagName('option');
        for (let i = 0; i < monthOptions.length; i++) {
            const option = monthOptions[i];
            const monthValue = option.value;
            
            if (monthValue) {
                const month = parseInt(monthValue);
                option.style.display = month > endMonth ? 'none' : '';
                option.disabled = month > endMonth;
            }
        }
        
        // If currently selected start month is now invalid, reset it
        const currentStartMonth = startMonthSelect.value;
        if (currentStartMonth && parseInt(currentStartMonth) > endMonth) {
            startMonthSelect.value = '';
            startDaySelect.value = '';
            startDaySelect.innerHTML = '<option value="">Day</option>';
            return;
        }
        
        // Filter day options if same month is selected
        if (currentStartMonth && parseInt(currentStartMonth) === endMonth) {
            const dayOptions = startDaySelect.getElementsByTagName('option');
            for (let i = 0; i < dayOptions.length; i++) {
                const option = dayOptions[i];
                const dayValue = option.value;
                
                if (dayValue) {
                    const day = parseInt(dayValue);
                    option.style.display = day > endDay ? 'none' : '';
                    option.disabled = day > endDay;
                }
            }
            
            // If currently selected start day is now invalid, reset it
            const currentStartDay = startDaySelect.value;
            if (currentStartDay && parseInt(currentStartDay) > endDay) {
                startDaySelect.value = '';
            }
        }
    }

    function resetEndDateOptions() {
        const endMonthSelect = document.getElementById('end-month');
        const endDaySelect = document.getElementById('end-day');
        
        // Reset month options
        const monthOptions = endMonthSelect.getElementsByTagName('option');
        for (let i = 0; i < monthOptions.length; i++) {
            const option = monthOptions[i];
            option.style.display = '';
            option.disabled = false;
        }
        
        // Reset day options
        const dayOptions = endDaySelect.getElementsByTagName('option');
        for (let i = 0; i < dayOptions.length; i++) {
            const option = dayOptions[i];
            option.style.display = '';
            option.disabled = false;
        }
    }

    function resetStartDateOptions() {
        const startMonthSelect = document.getElementById('start-month');
        const startDaySelect = document.getElementById('start-day');
        
        // Reset month options
        const monthOptions = startMonthSelect.getElementsByTagName('option');
        for (let i = 0; i < monthOptions.length; i++) {
            const option = monthOptions[i];
            option.style.display = '';
            option.disabled = false;
        }
        
        // Reset day options
        const dayOptions = startDaySelect.getElementsByTagName('option');
        for (let i = 0; i < dayOptions.length; i++) {
            const option = dayOptions[i];
            option.style.display = '';
            option.disabled = false;
        }
    }

    function applyCustomDateRange() {
        const startMonth = document.getElementById('start-month').value;
        const startDay = document.getElementById('start-day').value;
        const endMonth = document.getElementById('end-month').value;
        const endDay = document.getElementById('end-day').value;
        
        // Only apply when all fields are selected
        if (!startMonth || !startDay || !endMonth || !endDay) { 
            return; 
        }
        
        // Get selected year(s) from Compare Years checkboxes
        const checkedBoxes = document.querySelectorAll('.year-comparison-checkbox:checked');
        const selectedYears = Array.from(checkedBoxes).map(checkbox => parseInt(checkbox.value));
        
        // Must have at least one year selected
        if (selectedYears.length === 0) {
            document.querySelector('.year-comparison-checkbox[value="2025"]').checked = true;
            applyCustomDateRange();
            return;
        }
        
        // Sort years in descending order for consistent display
        selectedYears.sort((a, b) => b - a);
        
        // Use the first selected year for the date construction
        const year = selectedYears[0];
        
        // Construct full dates
        const startDate = `${year}-${startMonth}-${startDay}`;
        const endDate = `${year}-${endMonth}-${endDay}`;
        
        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);
        
        if (endDateObj < startDateObj) { 
            alert('End date must be after start date'); 
            return; 
        }
        
        // Remove active class from all time range buttons when custom range is applied
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
        });

        // Color mapping for years
        const yearColors = {
            2025: { border: 'rgba(71, 52, 114, 1)', bg: 'rgba(71, 52, 114, 0.2)' }, // Purple
            2024: { border: 'rgba(83, 98, 158, 1)', bg: 'rgba(83, 98, 158, 0.2)' }, // Blue
            2023: { border: 'rgba(135, 186, 195, 1)', bg: 'rgba(135, 186, 195, 0.2)' }  // Light Blue
        };

        // Build API URL with all selected years
        let apiUrl = `/monitoring/api/trends/?start_date=${startDate}&end_date=${endDate}&`;
        
        if (selectedYears.length === 1) {
            apiUrl += `year=${selectedYears[0]}`;
        } else {
            apiUrl += `compare_years=${selectedYears.join(',')}`;
        }

        // Update export button links with custom date range and selected years
        const exportParams = { start_date: startDate, end_date: endDate };
        if (selectedYears.length === 1) {
            exportParams.year = selectedYears[0];
        } else if (selectedYears.length > 1) {
            exportParams.compare_years = selectedYears.join(',');
        }
        updateExportLinks(exportParams);

        const yearText = selectedYears.length === 1 ? `${selectedYears[0]}` : `${selectedYears.length} years`;
        document.getElementById('active-filter-display').innerHTML = `Loading ${yearText} data...`;
        
        console.log('Custom Date Range - Fetching from URL:', apiUrl);
        console.log('Custom Date Range - Selected years:', selectedYears);
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Custom Date Range - API Response:', data);
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Create custom label showing month/day and year(s)
                const startFormatted = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endFormatted = new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const yearsText = selectedYears.join(', ');
                
                // Update charts based on single or multi-year
                if (selectedYears.length === 1) {
                    // Single year view
                    const year = selectedYears[0];
                    const colors = yearColors[year] || { border: 'rgba(100, 116, 139, 1)', bg: 'rgba(100, 116, 139, 0.2)' };
                    
                    rainfallTrendChart.data.labels = data.rainfall_timestamps;
                    rainfallTrendChart.data.datasets = [{
                        label: `Rainfall ${year} (mm)`,
                        data: data.rainfall_values,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.border,
                        pointHoverBorderWidth: 3
                    }];
                    rainfallTrendChart.update();

                    tideTrendChart.data.labels = data.tide_timestamps;
                    tideTrendChart.data.datasets = [{
                        label: `Tide Level ${year} (m)`,
                        data: data.tide_values,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.border,
                        pointHoverBorderWidth: 3
                    }];
                    tideTrendChart.update();

                    updateTrendsTable(data.rainfall_timestamps, data.rainfall_values, data.tide_values);

                    document.getElementById('active-filter-display').innerHTML = `${startFormatted} - ${endFormatted} (${year})`;
                    document.getElementById('selected-years-display').style.display = 'none';
                } else {
                    // Multi-year comparison view
                    updateChartsWithMultiYearData(data);

                    document.getElementById('selected-years-list').textContent = yearsText;
                    document.getElementById('selected-years-display').style.display = 'block';
                    document.getElementById('active-filter-display').innerHTML = `${startFormatted} - ${endFormatted} (${yearsText})`;
                }
            })
            .catch(error => {
                console.error('Custom Date Range - Error:', error);
                alert('Error loading data. Please try again.');
                document.getElementById('active-filter-display').innerHTML = 'Error loading data';
            });
    }

    function updateExportLinks(params) {
        const baseUrlPDF = "{% url 'export_trends' %}?type=pdf";
        
        let pdfUrl = baseUrlPDF;
        
        if (params.time_range) {
            pdfUrl += `&time_range=${params.time_range}`;
        } else if (params.start_date && params.end_date) {
            pdfUrl += `&start_date=${params.start_date}&end_date=${params.end_date}`;
        }
        
        // Add selected years for multi-year export
        if (params.compare_years) {
            pdfUrl += `&compare_years=${params.compare_years}`;
        } else if (params.year) {
            pdfUrl += `&year=${params.year}`;
        }
        
        document.getElementById('export-trends-pdf').href = pdfUrl;
    }

    function exportTrendsPDF() {
        // Capture the chart canvases as base64 images
        const rainfallCanvas = document.getElementById('rainfallTrendChart');
        const tideCanvas = document.getElementById('tideTrendChart');
        
        if (!rainfallCanvas || !tideCanvas) {
            alert('Charts not loaded yet. Please wait a moment and try again.');
            return;
        }
        
        // Convert canvases to base64 images
        const rainfallImage = rainfallCanvas.toDataURL('image/png');
        const tideImage = tideCanvas.toDataURL('image/png');
        
        // Get current export parameters from the button href (or build from current state)
        const exportBtn = document.getElementById('export-trends-pdf');
        let exportUrl = "{% url 'export_trends' %}?type=pdf";
        
        // Get current time range or custom dates
        const timeRange = document.querySelector('.time-range-btn.btn-primary')?.dataset.timeRange;
        const startMonth = document.getElementById('start-month')?.value;
        const startDay = document.getElementById('start-day')?.value;
        const endMonth = document.getElementById('end-month')?.value;
        const endDay = document.getElementById('end-day')?.value;
        
        if (timeRange && document.querySelector('[data-tab="quick-range"]').classList.contains('active')) {
            exportUrl += `&time_range=${timeRange}`;
        } else if (startMonth && startDay && endMonth && endDay) {
            const year = new Date().getFullYear();
            exportUrl += `&start_date=${year}-${startMonth}-${startDay}&end_date=${year}-${endMonth}-${endDay}`;
        }
        
        // Get selected years
        const selectedYears = Array.from(document.querySelectorAll('.year-comparison-checkbox:checked'))
            .map(cb => cb.value);
        
        console.log('Selected years:', selectedYears);
        
        if (selectedYears.length === 1) {
            exportUrl += `&year=${selectedYears[0]}`;
        } else if (selectedYears.length > 1) {
            exportUrl += `&compare_years=${selectedYears.join(',')}`;
        }
        
        console.log('Export URL:', exportUrl);
        
        // Create a form to POST the chart images
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = exportUrl;
        form.style.display = 'none';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }
        
        // Add chart images as hidden inputs
        const rainfallInput = document.createElement('input');
        rainfallInput.type = 'hidden';
        rainfallInput.name = 'rainfall_chart';
        rainfallInput.value = rainfallImage;
        form.appendChild(rainfallInput);
        
        const tideInput = document.createElement('input');
        tideInput.type = 'hidden';
        tideInput.name = 'tide_chart';
        tideInput.value = tideImage;
        form.appendChild(tideInput);
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }

    function resetCustomDateRange() {
        // Clear the month/day selects
        document.getElementById('start-month').value = new Date().getMonth() + 1 < 10 ? '0' + (new Date().getMonth() + 1) : (new Date().getMonth() + 1).toString();
        document.getElementById('end-month').value = new Date().getMonth() + 1 < 10 ? '0' + (new Date().getMonth() + 1) : (new Date().getMonth() + 1).toString();
        document.getElementById('start-day').value = '';
        document.getElementById('end-day').value = '';
        populateDays('start-month', 'start-day');
        populateDays('end-month', 'end-day');
        
        // Reset to default time range (24h)
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
        });
        document.querySelector('[data-time-range="24h"]').classList.add('btn-primary');
        
        updateTimeRange('24h');
    }

    function updateTrendsTable(timestamps, rainfallValues, tideValues) {
        const tableBody = document.getElementById('trendsTableBody');
        tableBody.innerHTML = '';
        if (timestamps.length === 0) { tableBody.innerHTML = '<tr><td colspan="3">No data available</td></tr>'; return; }
        // Reverse loop to show most recent records at the top
        for (let i = timestamps.length - 1; i >= 0; i--) {
            const row = document.createElement('tr');
            // Show 0 instead of N/A for zero values, but N/A for undefined/null
            const rainfallDisplay = rainfallValues[i] !== undefined && rainfallValues[i] !== null ? rainfallValues[i] : 'N/A';
            const tideDisplay = tideValues[i] !== undefined && tideValues[i] !== null ? tideValues[i] : 'N/A';
            row.innerHTML = `<td>${timestamps[i]}</td><td>${rainfallDisplay}</td><td>${tideDisplay}</td>`;
            tableBody.appendChild(row);
        }
    }

    function toggleView(type) {
        const chartContainer = document.getElementById(`${type}Chart-container`) || document.getElementById(`${type}Chart`);
        const table = document.getElementById(`${type}Table`);
        const isChecked = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
        if (isChecked) { chartContainer.classList.add('hidden'); table.classList.remove('hidden'); }
        else { chartContainer.classList.remove('hidden'); table.classList.add('hidden'); }
    }

    // Year Selection Functions
    function applyYearComparison() {
        // Get ALL checked years (including 2025)
        const checkedBoxes = document.querySelectorAll('.year-comparison-checkbox:checked');
        const selectedYears = Array.from(checkedBoxes).map(checkbox => parseInt(checkbox.value));
        
        // Must have at least one year selected
        if (selectedYears.length === 0) {
            // Re-check 2025 as default and trigger update
            document.querySelector('.year-comparison-checkbox[value="2025"]').checked = true;
            // Recursively call to update with 2025 data
            applyYearComparison();
            return;
        }

        // Sort years in descending order for consistent display
        selectedYears.sort((a, b) => b - a);

        // Color mapping for years
        const yearColors = {
       2025: { border: 'rgba(71, 52, 114, 1)', bg: 'rgba(71, 52, 114, 0.2)' }, // Purple
       2024: { border: 'rgba(83, 98, 158, 1)', bg: 'rgba(83, 98, 158, 0.2)' }, // Blue
       2023: { border: 'rgba(135, 186, 195, 1)', bg: 'rgba(135, 186, 195, 0.2)' }  // Light Blue
   };

        // Get current time range or custom dates
        const activeTimeRangeBtn = document.querySelector('.time-range-btn.btn-primary');
        const timeRange = activeTimeRangeBtn ? activeTimeRangeBtn.getAttribute('data-time-range') : '24h';
        
        // Get custom date range from month/day selects
        const startMonth = document.getElementById('start-month').value;
        const startDay = document.getElementById('start-day').value;
        const endMonth = document.getElementById('end-month').value;
        const endDay = document.getElementById('end-day').value;
        
        let startDate = null;
        let endDate = null;
        
        // Only construct dates if all fields are filled
        if (startMonth && startDay && endMonth && endDay) {
            // Use first selected year for custom dates
            const year = selectedYears[0];
            startDate = `${year}-${startMonth}-${startDay}`;
            endDate = `${year}-${endMonth}-${endDay}`;
        }

        // Build API URL - treat first year as "current" and rest as "compare_years"
        let apiUrl = '/monitoring/api/trends/?';
        if (startDate && endDate) {
            apiUrl += `start_date=${startDate}&end_date=${endDate}&`;
        } else {
            apiUrl += `time_range=${timeRange}&`;
        }

        // If only one year selected, just request that year's data
        if (selectedYears.length === 1) {
            apiUrl += `year=${selectedYears[0]}`;
        } else {
            // Multiple years: use compare_years parameter
            apiUrl += `compare_years=${selectedYears.join(',')}`;
        }

        // Show loading state
        const yearText = selectedYears.length === 1 ? `${selectedYears[0]}` : `${selectedYears.length} years`;
        document.getElementById('active-filter-display').innerHTML = `Loading ${yearText} data...`;

        console.log('Fetching from URL:', apiUrl); // Debug logging
        console.log('Selected years:', selectedYears); // Debug logging

        // Update export links with current parameters
        const exportParams = {};
        if (startDate && endDate) {
            exportParams.start_date = startDate;
            exportParams.end_date = endDate;
        } else {
            exportParams.time_range = timeRange;
        }
        if (selectedYears.length === 1) {
            exportParams.year = selectedYears[0];
        } else if (selectedYears.length > 1) {
            exportParams.compare_years = selectedYears.join(',');
        }
        updateExportLinks(exportParams);

        // Fetch data
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data); // Debug logging
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Update charts based on single or multi-year
                if (selectedYears.length === 1) {
                    // Single year view - use color mapping for both charts
                    const year = selectedYears[0];
                    const colors = yearColors[year] || { border: 'rgba(100, 116, 139, 1)', bg: 'rgba(100, 116, 139, 0.2)' };
                    rainfallTrendChart.data.labels = data.rainfall_timestamps;
                    rainfallTrendChart.data.datasets = [{
                        label: `Rainfall ${year} (mm)`,
                        data: data.rainfall_values,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.border,
                        pointHoverBorderWidth: 3
                    }];
                    rainfallTrendChart.update();

                    tideTrendChart.data.labels = data.tide_timestamps;
                    tideTrendChart.data.datasets = [{
                        label: `Tide Level ${year} (m)`,
                        data: data.tide_values,
                        backgroundColor: colors.bg, // Use same color as rainfall
                        borderColor: colors.border, // Use same color as rainfall
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.border,
                        pointHoverBorderWidth: 3
                    }];
                    tideTrendChart.update();

                    updateTrendsTable(data.rainfall_timestamps, data.rainfall_values, data.tide_values);

                    // Update display with simplified format
                    // Check if custom dates are being used
                    if (startDate && endDate) {
                        const startFormatted = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const endFormatted = new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        document.getElementById('active-filter-display').innerHTML = `${startFormatted} - ${endFormatted} (${year})`;
                    } else {
                        // Use original range label (e.g., "Last 24 Hours")
                        document.getElementById('active-filter-display').innerHTML = `${data.range_label} (${year})`;
                    }
                    document.getElementById('selected-years-display').style.display = 'none';
                } else {
                    // Multi-year comparison view
                    updateChartsWithMultiYearData(data);

                    // Update display with simplified format
                    const yearsList = selectedYears.join(', ');
                    document.getElementById('selected-years-list').textContent = yearsList;
                    document.getElementById('selected-years-display').style.display = 'block';

                    // Check if custom dates are being used
                    if (startDate && endDate) {
                        const startFormatted = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const endFormatted = new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        document.getElementById('active-filter-display').innerHTML = `${startFormatted} - ${endFormatted} (${yearsList})`;
                    } else {
                        // Use original range label (e.g., "Last 24 Hours")
                        document.getElementById('active-filter-display').innerHTML = `${data.range_label} (${yearsList})`;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching year data:', error);
                alert('Error loading data. Please try again.');
                document.getElementById('active-filter-display').innerHTML = 'Error loading data';
            });
    }
    
    
    function updateChartsWithMultiYearData(data) {
        console.log('updateChartsWithMultiYearData called with:', data); // Debug logging
        
        const datasets = data.datasets;
        const currentYear = data.current_year;
        
        console.log('Datasets:', datasets); // Debug logging
        console.log('Current Year:', currentYear); // Debug logging
        
        // Check if datasets exist and have data
        if (!datasets || !datasets.rainfall || !datasets.tide) {
            console.error('Missing datasets in response:', data);
            alert('Error: Invalid data format received from server');
            return;
        }
        
        console.log('Rainfall datasets keys:', Object.keys(datasets.rainfall)); // Debug logging
        console.log('Tide datasets keys:', Object.keys(datasets.tide)); // Debug logging
        
        // Define colors for different years
        const yearColors = {
       2025: { border: 'rgba(71, 52, 114, 1)', bg: 'rgba(71, 52, 114, 0.2)' },  // Purple
       2024: { border: 'rgba(83, 98, 158, 1)', bg: 'rgba(83, 98, 158, 0.2)' },  // Blue
       2023: { border: 'rgba(135, 186, 195, 1)', bg: 'rgba(135, 186, 195, 0.2)' },  // Light Blue
       2022: { border: 'rgba(16, 185, 129, 1)', bg: 'rgba(16, 185, 129, 0.2)' }   // Green
   };
        
        // Update Rainfall Chart
        const rainfallDatasets = [];
        const allTimestamps = new Set();
        
        // Collect all unique timestamps
        Object.keys(datasets.rainfall).forEach(year => {
            console.log(`Processing rainfall for year ${year}:`, datasets.rainfall[year]); // Debug logging
            datasets.rainfall[year].timestamps.forEach(ts => allTimestamps.add(ts));
        });
        
        console.log('Total unique timestamps:', allTimestamps.size); // Debug logging
        const sortedTimestamps = Array.from(allTimestamps).sort();
        
        // Create dataset for each year
        Object.keys(datasets.rainfall).forEach(year => {
            const yearInt = parseInt(year);
            const yearData = datasets.rainfall[year];
            const colors = yearColors[yearInt] || { border: 'rgba(100, 116, 139, 1)', bg: 'rgba(100, 116, 139, 0.2)' };
            
            console.log(`Creating rainfall dataset for ${year} with ${yearData.values.length} points`); // Debug logging
            
            // Map data to sorted timestamps
            const timestampMap = {};
            yearData.timestamps.forEach((ts, idx) => {
                timestampMap[ts] = yearData.values[idx];
            });
            
            const mappedValues = sortedTimestamps.map(ts => timestampMap[ts] !== undefined ? timestampMap[ts] : null);
            
            rainfallDatasets.push({
                label: `${yearData.label} - Rainfall (mm)`,
                data: mappedValues,
                borderColor: colors.border,
                backgroundColor: colors.bg,
                borderWidth: yearInt === currentYear ? 3 : 2,
                tension: 0.4,
                fill: yearInt === currentYear,
                pointRadius: yearInt === currentYear ? 4 : 3,
                pointHoverRadius: 6,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: colors.border,
                pointBorderWidth: 2,
                spanGaps: true  // Connect lines even if there are null values
            });
        });
        
        rainfallTrendChart.data.labels = sortedTimestamps;
        rainfallTrendChart.data.datasets = rainfallDatasets;
        rainfallTrendChart.update();
        
        console.log('Rainfall chart updated with', rainfallDatasets.length, 'datasets'); // Debug logging
        
        // Update Tide Chart
        const tideDatasets = [];
        const allTideTimestamps = new Set();
        
        // Collect all unique timestamps for tide
        Object.keys(datasets.tide).forEach(year => {
            console.log(`Processing tide for year ${year}:`, datasets.tide[year]); // Debug logging
            datasets.tide[year].timestamps.forEach(ts => allTideTimestamps.add(ts));
        });
        
        console.log('Total unique tide timestamps:', allTideTimestamps.size); // Debug logging
        const sortedTideTimestamps = Array.from(allTideTimestamps).sort();
        
        // Create dataset for each year
        Object.keys(datasets.tide).forEach(year => {
            const yearInt = parseInt(year);
            const yearData = datasets.tide[year];
            const colors = yearColors[yearInt] || { border: 'rgba(100, 116, 139, 1)', bg: 'rgba(100, 116, 139, 0.2)' };
            
            console.log(`Creating tide dataset for ${year} with ${yearData.values.length} points`); // Debug logging
            
            // Map data to sorted timestamps
            const timestampMap = {};
            yearData.timestamps.forEach((ts, idx) => {
                timestampMap[ts] = yearData.values[idx];
            });
            
            const mappedValues = sortedTideTimestamps.map(ts => timestampMap[ts] !== undefined ? timestampMap[ts] : null);
            
            tideDatasets.push({
                label: `${yearData.label} - Tide (m)`,
                data: mappedValues,
                borderColor: colors.border,
                backgroundColor: colors.bg,
                borderWidth: yearInt === currentYear ? 3 : 2,
                tension: 0.4,
                fill: yearInt === currentYear,
                pointRadius: yearInt === currentYear ? 4 : 3,
                pointHoverRadius: 6,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: colors.border,
                pointBorderWidth: 2,
                spanGaps: true
            });
        });
        
        tideTrendChart.data.labels = sortedTideTimestamps;
        tideTrendChart.data.datasets = tideDatasets;
        tideTrendChart.update();
        
        console.log('Tide chart updated with', tideDatasets.length, 'datasets'); // Debug logging
    }

    function toggleSection(headerElement) {
        const card = headerElement.closest('.card');
        const content = card.querySelector('.card-content');
        const icon = headerElement.querySelector('.collapse-icon');
        
        content.classList.toggle('collapsed');
        icon.classList.toggle('collapsed');
    }

    function switchTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('.flood-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.flood-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabId).classList.add('active');
        
        // Add active class to clicked tab
        event.target.classList.add('active');
    }

    // Smooth scroll for quick navigation
    document.querySelectorAll('.quick-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            
            // Skip if it's a javascript: void(0) link (like Records button)
            if (!href || href.startsWith('javascript:')) {
                return;
            }
            
            e.preventDefault();
            const targetId = href.substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // Expand section if collapsed
                const content = targetElement.querySelector('.card-content');
                if (content && content.classList.contains('collapsed')) {
                    const header = targetElement.querySelector('.card-header');
                    if (header) toggleSection(header);
                }
                
                // Calculate navbar height + extra padding
                const navbar = document.querySelector('.navbar');
                const navbarHeight = navbar ? navbar.offsetHeight : 80;
                const offset = navbarHeight + 20; // 20px extra padding
                
                // Get element position and scroll with offset
                const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                const offsetPosition = elementPosition - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Add highlight effect
                targetElement.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.3)';
                setTimeout(() => {
                    targetElement.style.boxShadow = '';
                }, 2000);
            }
        });
    });

    // Initialize all charts
    const barangayDataByDate = {{ barangay_data_by_date|safe }};
    
    const ctxCasualties = document.getElementById('casualtiesChart').getContext('2d');
    window.casualtiesChart = new Chart(ctxCasualties, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Dead', 
                    data: {{ casualties_data.dead|safe }}, 
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(239, 68, 68, 1)'
                },
                { 
                    label: 'Injured', 
                    data: {{ casualties_data.injured|safe }}, 
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(59, 130, 246, 1)'
                },
                { 
                    label: 'Missing', 
                    data: {{ casualties_data.missing|safe }}, 
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(245, 158, 11, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const date = context.label;
                            const fieldMap = {'Dead': 'casualties_dead', 'Injured': 'casualties_injured', 'Missing': 'casualties_missing'};
                            const field = fieldMap[context.dataset.label];
                            
                            let label = context.dataset.label + ': ' + value + ' person(s)';
                            
                            // Add barangay breakdown if available
                            const barangayData = barangayDataByDate[date];
                            if (barangayData && barangayData[field]) {
                                const breakdown = barangayData[field];
                                const items = Object.entries(breakdown).map(([brgy, val]) => `  • ${brgy}: ${val}`);
                                if (items.length > 0) {
                                    return [label, ...items];
                                }
                            }
                            
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxAffected = document.getElementById('affectedChart').getContext('2d');
    window.affectedChart = new Chart(ctxAffected, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Persons', 
                    data: {{ affected_data.persons|safe }}, 
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(16, 185, 129, 1)'
                },
                { 
                    label: 'Families', 
                    data: {{ affected_data.families|safe }}, 
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(139, 92, 246, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const date = context.label;
                            const fieldMap = {'Persons': 'affected_persons', 'Families': 'affected_families'};
                            const field = fieldMap[context.dataset.label];
                            
                            let label = context.dataset.label + ': ' + value.toLocaleString();
                            
                            // Add barangay breakdown if available
                            const barangayData = barangayDataByDate[date];
                            if (barangayData && barangayData[field]) {
                                const breakdown = barangayData[field];
                                const items = Object.entries(breakdown).map(([brgy, val]) => `  • ${brgy}: ${val.toLocaleString()}`);
                                if (items.length > 0) {
                                    return [label, ...items];
                                }
                            }
                            
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxHouses = document.getElementById('housesChart').getContext('2d');
    window.housesChart = new Chart(ctxHouses, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Partially Damaged', 
                    data: {{ houses_data.partially|safe }}, 
                    backgroundColor: 'rgba(251, 146, 60, 0.8)',
                    borderColor: 'rgba(251, 146, 60, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(251, 146, 60, 1)'
                },
                { 
                    label: 'Totally Damaged', 
                    data: {{ houses_data.totally|safe }}, 
                    backgroundColor: 'rgba(107, 114, 128, 0.8)',
                    borderColor: 'rgba(107, 114, 128, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(107, 114, 128, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const date = context.label;
                            const fieldMap = {'Partially Damaged': 'houses_damaged_partially', 'Totally Damaged': 'houses_damaged_totally'};
                            const field = fieldMap[context.dataset.label];
                            
                            let label = context.dataset.label + ': ' + value + ' house(s)';
                            
                            // Add barangay breakdown if available
                            const barangayData = barangayDataByDate[date];
                            if (barangayData && barangayData[field]) {
                                const breakdown = barangayData[field];
                                const items = Object.entries(breakdown).map(([brgy, val]) => `  \u2022 ${brgy}: ${val}`);
                                if (items.length > 0) {
                                    return [label, ...items];
                                }
                            }
                            
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxDamage = document.getElementById('damageChart').getContext('2d');
    window.damageChart = new Chart(ctxDamage, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Infrastructure', 
                    data: {{ damage_data.infrastructure|safe }}, 
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(239, 68, 68, 1)'
                },
                { 
                    label: 'Agriculture', 
                    data: {{ damage_data.agriculture|safe }}, 
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(34, 197, 94, 1)'
                },
                { 
                    label: 'Institutions', 
                    data: {{ damage_data.institutions|safe }}, 
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(245, 158, 11, 1)'
                },
                { 
                    label: 'Private Commercial', 
                    data: {{ damage_data.private_commercial|safe }}, 
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(59, 130, 246, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const date = context.label;
                            const fieldMap = {
                                'Infrastructure': 'damage_infrastructure_php', 
                                'Agriculture': 'damage_agriculture_php',
                                'Institutions': 'damage_institutions_php',
                                'Private Commercial': 'damage_private_commercial_php'
                            };
                            const field = fieldMap[context.dataset.label];
                            
                            let label = context.dataset.label + ': ₱' + value.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            
                            // Add barangay breakdown if available
                            const barangayData = barangayDataByDate[date];
                            if (barangayData && barangayData[field]) {
                                const breakdown = barangayData[field];
                                const items = Object.entries(breakdown).map(([brgy, val]) => 
                                    `  \u2022 ${brgy}: ₱${val.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                );
                                if (items.length > 0) {
                                    return [label, ...items];
                                }
                            }
                            
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return '₱' + (value / 1000).toLocaleString() + 'K';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Generate Impact Analysis Insights
    generateImpactInsights();

    function generateImpactInsights() {
        // Get flood records data from Django template
        const floodRecords = [
            {% for record in flood_records %}
            {
                date: "{{ record.date|date:'Y-m-d' }}",
                event: "{{ record.event|escapejs }}",
                casualties_dead: {{ record.casualties_dead|default:0 }},
                casualties_injured: {{ record.casualties_injured|default:0 }},
                casualties_missing: {{ record.casualties_missing|default:0 }},
                affected_persons: {{ record.affected_persons|default:0 }},
                affected_families: {{ record.affected_families|default:0 }},
                houses_partially: {{ record.houses_damaged_partially|default:0 }},
                houses_totally: {{ record.houses_damaged_totally|default:0 }},
                damage_infrastructure: {{ record.damage_infrastructure_php|default:0 }},
                damage_agriculture: {{ record.damage_agriculture_php|default:0 }},
                damage_institutions: {{ record.damage_institutions_php|default:0 }},
                damage_private: {{ record.damage_private_commercial_php|default:0 }},
                damage_total: {{ record.damage_total_php|default:0 }}
            },
            {% endfor %}
        ];

        if (floodRecords.length === 0) {
            document.getElementById('casualties-insight').querySelector('span').textContent = 'No flood records available for analysis.';
            document.getElementById('affected-insight').querySelector('span').textContent = 'No flood records available for analysis.';
            document.getElementById('houses-insight').querySelector('span').textContent = 'No flood records available for analysis.';
            document.getElementById('damage-insight').querySelector('span').textContent = 'No flood records available for analysis.';
            return;
        }

        // Calculate Casualties Insight
        const totalDead = floodRecords.reduce((sum, r) => sum + r.casualties_dead, 0);
        const totalInjured = floodRecords.reduce((sum, r) => sum + r.casualties_injured, 0);
        const totalMissing = floodRecords.reduce((sum, r) => sum + r.casualties_missing, 0);
        const deadlyEvents = floodRecords.filter(r => r.casualties_dead > 0);
        const worstCasualty = floodRecords.reduce((max, r) => 
            (r.casualties_dead + r.casualties_injured + r.casualties_missing) > 
            (max.casualties_dead + max.casualties_injured + max.casualties_missing) ? r : max
        , floodRecords[0]);

        let casualtiesInsight = '';
        if (totalDead === 0 && totalInjured === 0 && totalMissing === 0) {
            casualtiesInsight = `✅ <strong>No casualties recorded</strong> across all ${floodRecords.length} flood events. Safety measures are effective.`;
        } else {
            casualtiesInsight = `📊 <strong>Total casualties:</strong> ${totalDead} deaths, ${totalInjured} injured, ${totalMissing} missing across ${floodRecords.length} events. `;
            if (deadlyEvents.length > 0) {
                casualtiesInsight += `⚠️ ${deadlyEvents.length} event(s) resulted in fatalities. `;
            }
            casualtiesInsight += `Most severe: <strong>${worstCasualty.event || worstCasualty.date}</strong>.`;
        }
        document.getElementById('casualties-insight').querySelector('span').innerHTML = casualtiesInsight;

        // Calculate Affected Individuals Insight
        const totalPersons = floodRecords.reduce((sum, r) => sum + r.affected_persons, 0);
        const totalFamilies = floodRecords.reduce((sum, r) => sum + r.affected_families, 0);
        const avgPersonsPerEvent = Math.round(totalPersons / floodRecords.length);
        const avgFamiliesPerEvent = Math.round(totalFamilies / floodRecords.length);
        const worstAffected = floodRecords.reduce((max, r) => r.affected_persons > max.affected_persons ? r : max, floodRecords[0]);

        let affectedInsight = `👥 <strong>${totalPersons.toLocaleString()} persons</strong> and <strong>${totalFamilies.toLocaleString()} families</strong> affected across all events. `;
        affectedInsight += `Average: ${avgPersonsPerEvent.toLocaleString()} persons per event. `;
        if (worstAffected.affected_persons > avgPersonsPerEvent * 2) {
            affectedInsight += `⚠️ Peak impact: <strong>${worstAffected.event || worstAffected.date}</strong> with ${worstAffected.affected_persons.toLocaleString()} persons.`;
        }
        document.getElementById('affected-insight').querySelector('span').innerHTML = affectedInsight;

        // Calculate Houses Damaged Insight
        const totalPartially = floodRecords.reduce((sum, r) => sum + r.houses_partially, 0);
        const totalTotally = floodRecords.reduce((sum, r) => sum + r.houses_totally, 0);
        const totalHouses = totalPartially + totalTotally;
        const worstHouses = floodRecords.reduce((max, r) => 
            (r.houses_partially + r.houses_totally) > (max.houses_partially + max.houses_totally) ? r : max
        , floodRecords[0]);

        let housesInsight = `🏠 <strong>${totalHouses.toLocaleString()} houses damaged</strong> in total: ${totalPartially.toLocaleString()} partially, ${totalTotally.toLocaleString()} totally destroyed. `;
        if (totalTotally > 0) {
            const destructionRate = ((totalTotally / totalHouses) * 100).toFixed(1);
            housesInsight += `⚠️ ${destructionRate}% of damaged houses were totally destroyed. `;
        }
        if (worstHouses.houses_partially + worstHouses.houses_totally > 0) {
            housesInsight += `Most destructive: <strong>${worstHouses.event || worstHouses.date}</strong>.`;
        }
        document.getElementById('houses-insight').querySelector('span').innerHTML = housesInsight;

        // Calculate Property Damage Insight
        const totalDamage = floodRecords.reduce((sum, r) => sum + r.damage_total, 0);
        const totalInfrastructure = floodRecords.reduce((sum, r) => sum + r.damage_infrastructure, 0);
        const totalAgriculture = floodRecords.reduce((sum, r) => sum + r.damage_agriculture, 0);
        const worstDamage = floodRecords.reduce((max, r) => r.damage_total > max.damage_total ? r : max, floodRecords[0]);
        
        const formatCurrency = (val) => '₱' + val.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        // Determine highest damage category
        const categories = [
            { name: 'Infrastructure', value: totalInfrastructure },
            { name: 'Agriculture', value: totalAgriculture },
            { name: 'Institutions', value: floodRecords.reduce((sum, r) => sum + r.damage_institutions, 0) },
            { name: 'Private/Commercial', value: floodRecords.reduce((sum, r) => sum + r.damage_private, 0) }
        ];
        const highestCategory = categories.reduce((max, c) => c.value > max.value ? c : max, categories[0]);

        let damageInsight = `💰 <strong>Total economic damage:</strong> ${formatCurrency(totalDamage)} across ${floodRecords.length} events. `;
        if (highestCategory.value > 0) {
            const percentage = ((highestCategory.value / totalDamage) * 100).toFixed(0);
            damageInsight += `${highestCategory.name} sector most affected (${percentage}%). `;
        }
        damageInsight += `Costliest event: <strong>${worstDamage.event || worstDamage.date}</strong> (${formatCurrency(worstDamage.damage_total)}).`;
        document.getElementById('damage-insight').querySelector('span').innerHTML = damageInsight;
    }

    const ctxTempForecast = document.getElementById('temperatureForecastChart').getContext('2d');
    const gradientMaxTemp = ctxTempForecast.createLinearGradient(0, 0, 0, 400);
    gradientMaxTemp.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
    gradientMaxTemp.addColorStop(1, 'rgba(239, 68, 68, 0.01)');
    
    const gradientMinTemp = ctxTempForecast.createLinearGradient(0, 0, 0, 400);
    gradientMinTemp.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
    gradientMinTemp.addColorStop(1, 'rgba(59, 130, 246, 0.01)');

    new Chart(ctxTempForecast, {
        type: 'line',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [
                { 
                    label: 'Max Temp', 
                    data: {{ forecast_temp_max|safe }}, 
                    borderColor: 'rgba(239, 68, 68, 1)', 
                    backgroundColor: gradientMaxTemp,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(239, 68, 68, 1)',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: 'rgba(239, 68, 68, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                },
                { 
                    label: 'Min Temp', 
                    data: {{ forecast_temp_min|safe }}, 
                    borderColor: 'rgba(59, 130, 246, 1)', 
                    backgroundColor: gradientMinTemp,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(59, 130, 246, 1)',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '°C';
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + '°C';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxPrecip = document.getElementById('precipitationForecastChart').getContext('2d');
    new Chart(ctxPrecip, {
        type: 'bar',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [{ 
                label: 'Precipitation', 
                data: {{ forecast_precipitation|safe }}, 
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 2,
                borderRadius: 6,
                hoverBackgroundColor: 'rgba(16, 185, 129, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' mm';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + ' mm';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxHumidity = document.getElementById('humidityForecastChart').getContext('2d');
    const gradientHumidity = ctxHumidity.createLinearGradient(0, 0, 0, 400);
    gradientHumidity.addColorStop(0, 'rgba(139, 92, 246, 0.3)');
    gradientHumidity.addColorStop(1, 'rgba(139, 92, 246, 0.01)');

    new Chart(ctxHumidity, {
        type: 'line',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [{ 
                label: 'Humidity', 
                data: {{ forecast_humidity|safe }}, 
                borderColor: 'rgba(139, 92, 246, 1)', 
                backgroundColor: gradientHumidity,
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: 'rgba(139, 92, 246, 1)',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: 'rgba(139, 92, 246, 1)',
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxWind = document.getElementById('windSpeedForecastChart').getContext('2d');
    const gradientWind = ctxWind.createLinearGradient(0, 0, 0, 400);
    gradientWind.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
    gradientWind.addColorStop(1, 'rgba(245, 158, 11, 0.01)');

    new Chart(ctxWind, {
        type: 'line',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [{ 
                label: 'Wind Speed', 
                data: {{ forecast_wind_speed|safe }}, 
                borderColor: 'rgba(245, 158, 11, 1)', 
                backgroundColor: gradientWind,
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: 'rgba(245, 158, 11, 1)',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: 'rgba(245, 158, 11, 1)',
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' km/h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + ' km/h';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Generate data-driven weather insights
    function generateWeatherInsights() {
        // Get forecast data from Django template
        const tempMax = {{ forecast_temp_max|safe }};
        const tempMin = {{ forecast_temp_min|safe }};
        const precipitation = {{ forecast_precipitation|safe }};
        const humidity = {{ forecast_humidity|safe }};
        const windSpeed = {{ forecast_wind_speed|safe }};
        const dates = {{ forecast_dates|safe }};

        // Temperature Insights
        const avgTempMax = (tempMax.reduce((a, b) => a + b, 0) / tempMax.length).toFixed(1);
        const avgTempMin = (tempMin.reduce((a, b) => a + b, 0) / tempMin.length).toFixed(1);
        const peakTemp = Math.max(...tempMax);
        const lowestTemp = Math.min(...tempMin);
        const tempRange = (peakTemp - lowestTemp).toFixed(1);
        
        let tempInsight = `Average high: ${avgTempMax}°C, low: ${avgTempMin}°C. `;
        if (peakTemp > 34) {
            tempInsight += `Peak of ${peakTemp}°C expected - heat may increase evaporation rates.`;
        } else if (lowestTemp < 22) {
            tempInsight += `Lowest temperature ${lowestTemp}°C - cooler conditions expected.`;
        } else {
            tempInsight += `Temperature range of ${tempRange}°C indicates moderate conditions.`;
        }
        
        // Precipitation Insights
        const totalRain = precipitation.reduce((a, b) => a + b, 0).toFixed(1);
        const heavyRainDays = precipitation.filter(p => p > 50).length;
        const maxRain = Math.max(...precipitation);
        const maxRainDay = precipitation.indexOf(maxRain);
        
        let precipInsight = `Total expected: ${totalRain}mm over 7 days. `;
        if (heavyRainDays > 0) {
            precipInsight += `⚠️ ${heavyRainDays} day(s) with heavy rain (>50mm). Peak: ${maxRain}mm on ${dates[maxRainDay]} - High flood risk.`;
        } else if (totalRain > 100) {
            precipInsight += `Moderate rainfall expected - monitor drainage systems.`;
        } else if (totalRain < 30) {
            precipInsight += `Low rainfall expected - minimal flood risk from precipitation.`;
        } else {
            precipInsight += `Moderate rainfall levels - normal monitoring advised.`;
        }
        
        // Humidity Insights
        const avgHumidity = (humidity.reduce((a, b) => a + b, 0) / humidity.length).toFixed(1);
        const highHumidityDays = humidity.filter(h => h > 80).length;
        const maxHumidity = Math.max(...humidity);
        
        let humidityInsight = `Average: ${avgHumidity}%. `;
        if (highHumidityDays >= 4) {
            humidityInsight += `${highHumidityDays} days with high humidity (>80%) - saturated conditions may reduce soil absorption.`;
        } else if (maxHumidity > 85) {
            humidityInsight += `Peak humidity ${maxHumidity}% - near-saturation conditions expected.`;
        } else if (avgHumidity < 65) {
            humidityInsight += `Relatively dry conditions - better soil absorption capacity.`;
        } else {
            humidityInsight += `Moderate humidity levels - normal atmospheric conditions.`;
        }
        
        // Wind Speed Insights
        const avgWind = (windSpeed.reduce((a, b) => a + b, 0) / windSpeed.length).toFixed(1);
        const maxWind = Math.max(...windSpeed);
        const maxWindDay = windSpeed.indexOf(maxWind);
        const stormDays = windSpeed.filter(w => w > 40).length;
        
        let windInsight = `Average: ${avgWind} km/h. `;
        if (stormDays > 0) {
            windInsight += `⚠️ ${stormDays} day(s) with strong winds (>40 km/h). Peak: ${maxWind} km/h on ${dates[maxWindDay]} - Storm warning.`;
        } else if (maxWind > 35) {
            windInsight += `Peak wind ${maxWind} km/h on ${dates[maxWindDay]} - moderate wind conditions.`;
        } else if (avgWind < 15) {
            windInsight += `Light winds expected - calm weather conditions.`;
        } else {
            windInsight += `Moderate wind speeds - normal conditions.`;
        }
        
        // Update insight divs
        document.getElementById('temp-insight').querySelector('span').textContent = tempInsight;
        document.getElementById('precip-insight').querySelector('span').textContent = precipInsight;
        document.getElementById('humidity-insight').querySelector('span').textContent = humidityInsight;
        document.getElementById('wind-insight').querySelector('span').textContent = windInsight;
    }

    // Call the function after DOM is ready
    generateWeatherInsights();

    // Update metric card icons dynamically based on values
    function updateMetricIcons() {
        const metricItems = document.querySelectorAll('.metric-item');
        
        // Rainfall Icon (index 0)
        const rainfallValue = parseFloat(document.querySelector('[data-rainfall]').textContent);
        if (rainfallValue >= 50) {
            // Heavy rain - multiple large drops
            metricItems[0].classList.add('heavy-rain');
        } else if (rainfallValue >= 30) {
            // Moderate rain
            metricItems[0].classList.add('moderate-rain');
        } else {
            // Light rain - default
            metricItems[0].classList.add('light-rain');
        }
        
        // Temperature Icon (index 1)
        const tempValue = parseFloat(document.querySelector('[data-temperature]').textContent);
        if (tempValue >= 32) {
            // Hot - show sun
            metricItems[1].classList.add('hot-temp');
        } else if (tempValue <= 24) {
            // Cool - show cloud/rain
            metricItems[1].classList.add('cool-temp');
        } else {
            // Moderate - thermometer
            metricItems[1].classList.add('moderate-temp');
        }
        
        // Humidity Icon (index 2)
        const humidityValue = parseFloat(document.querySelector('.metric-item:nth-child(3) .metric-value').textContent);
        if (humidityValue >= 85) {
            // Very high humidity - large droplet
            metricItems[2].classList.add('high-humidity');
        } else if (humidityValue >= 70) {
            // Moderate humidity
            metricItems[2].classList.add('moderate-humidity');
        } else {
            // Low humidity
            metricItems[2].classList.add('low-humidity');
        }
        
        // Wind Speed Icon (index 3)
        const windValue = parseFloat(document.querySelector('.metric-item:nth-child(4) .metric-value').textContent);
        if (windValue >= 40) {
            // Strong wind - storm
            metricItems[3].classList.add('strong-wind');
        } else if (windValue >= 25) {
            // Moderate wind
            metricItems[3].classList.add('moderate-wind');
        } else {
            // Light wind
            metricItems[3].classList.add('light-wind');
        }
        
        // Tide Level Icon (index 4)
        const tideValue = parseFloat(document.querySelector('.metric-item:nth-child(5) .metric-value').textContent);
        if (tideValue >= 1.5) {
            // High tide - large waves
            metricItems[4].classList.add('high-tide');
        } else if (tideValue >= 1.0) {
            // Moderate tide
            metricItems[4].classList.add('moderate-tide');
        } else {
            // Low tide
            metricItems[4].classList.add('low-tide');
        }
    }

    // Call the function after DOM is ready
    updateMetricIcons();

    // Refresh countdown timer
    let refreshSeconds = 300; // 5 minutes = 300 seconds
    const refreshTimerElement = document.getElementById('refresh-timer');

    function updateRefreshTimer() {
        if (!refreshTimerElement) return; // Safety check
        
        const minutes = Math.floor(refreshSeconds / 60);
        const seconds = refreshSeconds % 60;
        refreshTimerElement.textContent = `Refreshing in ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (refreshSeconds > 0) {
            refreshSeconds--;
        } else {
            refreshSeconds = 300; // Reset to 5 minutes
        }
    }

    // Update countdown every second
    setInterval(updateRefreshTimer, 1000);
    updateRefreshTimer(); // Initial call

    // Store previous values for trend calculation (parse numbers only, removing units)
    let previousValues = {
        rainfall: parseFloat(document.querySelector('[data-rainfall]').textContent.replace(/[^0-9.-]/g, '')) || 0,
        temperature: parseFloat(document.querySelector('[data-temperature]').textContent.replace(/[^0-9.-]/g, '')) || 0,
        humidity: parseFloat(document.querySelector('[data-humidity]').textContent.replace(/[^0-9.-]/g, '')) || 0,
        wind: parseFloat(document.querySelector('[data-wind]').textContent.replace(/[^0-9.-]/g, '')) || 0,
        tide: parseFloat(document.querySelector('[data-tide]').textContent.replace(/[^0-9.-]/g, '')) || 0
    };

    // Function to update metric with trend
    function updateMetricTrend(metric, currentValue, previousValue, isIncreaseBad = true) {
        const trendElement = document.querySelector(`[data-trend-${metric}]`);
        if (!trendElement) return;

        const difference = currentValue - previousValue;
        const percentChange = previousValue !== 0 ? Math.abs((difference / previousValue) * 100) : 0;

        if (Math.abs(difference) < 0.01) {
            // No significant change
            trendElement.className = 'trend-indicator trend-neutral';
            trendElement.innerHTML = '<i class="fas fa-minus"></i> 0%';
            trendElement.style.display = 'inline-flex';
        } else if (difference > 0) {
            // Increasing
            trendElement.className = isIncreaseBad ? 'trend-indicator trend-up' : 'trend-indicator trend-down';
            trendElement.innerHTML = `<i class="fas fa-arrow-up"></i> ${percentChange.toFixed(1)}%`;
            trendElement.style.display = 'inline-flex';
        } else {
            // Decreasing
            trendElement.className = isIncreaseBad ? 'trend-indicator trend-down' : 'trend-indicator trend-up';
            trendElement.innerHTML = `<i class="fas fa-arrow-down"></i> ${percentChange.toFixed(1)}%`;
            trendElement.style.display = 'inline-flex';
        }
    }

    // Auto-refresh every 5 minutes
    setInterval(function() {
        fetch('{% url "fetch_data" %}')
            .then(response => response.json())
            .then(data => {
                // Get current values
                const currentRainfall = parseFloat(data.rainfall);
                const currentTemperature = parseFloat(data.temperature);
                const currentHumidity = parseFloat(data.humidity);
                const currentWind = parseFloat(data.wind_speed);
                const currentTide = parseFloat(data.tide);

                // Update trends (true = increase is bad, false = increase is good)
                updateMetricTrend('rainfall', currentRainfall, previousValues.rainfall, true);
                updateMetricTrend('temperature', currentTemperature, previousValues.temperature, true);
                updateMetricTrend('humidity', currentHumidity, previousValues.humidity, true);
                updateMetricTrend('wind', currentWind, previousValues.wind, true);
                updateMetricTrend('tide', currentTide, previousValues.tide, true);

                // Update metric values in DOM (find text node and update it, preserving trend indicators)
                const rainfallEl = document.querySelector('[data-rainfall]');
                const tempEl = document.querySelector('[data-temperature]');
                const humidityEl = document.querySelector('[data-humidity]');
                const windEl = document.querySelector('[data-wind]');
                const tideEl = document.querySelector('[data-tide]');

                // Helper function to update text node only
                function updateMetricValue(element, value) {
                    if (!element) return;
                    // Get the first text node or create one
                    let textNode = null;
                    for (let node of element.childNodes) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            textNode = node;
                            break;
                        }
                    }
                    if (textNode) {
                        textNode.textContent = value;
                    } else {
                        element.insertBefore(document.createTextNode(value), element.firstChild);
                    }
                }

                updateMetricValue(rainfallEl, currentRainfall + ' mm');
                updateMetricValue(tempEl, currentTemperature + '°C');
                updateMetricValue(humidityEl, currentHumidity + '%');
                updateMetricValue(windEl, currentWind + ' km/h');
                updateMetricValue(tideEl, currentTide + ' m');

                // Update timestamps in tooltips if available
                if (data.timestamps) {
                    // Update rainfall tooltip timestamp
                    const rainfallTooltip = rainfallEl.parentElement.querySelector('.metric-tooltip');
                    if (rainfallTooltip && data.timestamps.rainfall) {
                        const timestampDiv = rainfallTooltip.querySelector('div:has(strong:contains("⏱️"))');
                        if (timestampDiv) {
                            timestampDiv.innerHTML = '<strong>⏱️ Last Updated:</strong> ' + data.timestamps.rainfall;
                        }
                    }
                    
                    // Update weather tooltips (temperature, humidity, wind) - they share same timestamp
                    if (data.timestamps.weather) {
                        [tempEl, humidityEl, windEl].forEach(el => {
                            if (!el) return;
                            const tooltip = el.parentElement.querySelector('.metric-tooltip');
                            if (tooltip) {
                                // Find all divs with "Last Updated" text and update them
                                const allDivs = tooltip.querySelectorAll('div');
                                allDivs.forEach(div => {
                                    if (div.innerHTML.includes('⏱️ Last Updated:')) {
                                        div.innerHTML = '<strong>⏱️ Last Updated:</strong> ' + data.timestamps.weather;
                                    }
                                });
                            }
                        });
                    }
                    
                    // Update tide tooltip timestamp
                    if (data.timestamps.tide) {
                        const tideTooltip = tideEl.parentElement.querySelector('.metric-tooltip');
                        if (tideTooltip) {
                            const allDivs = tideTooltip.querySelectorAll('div');
                            allDivs.forEach(div => {
                                if (div.innerHTML.includes('⏱️ Last Updated:')) {
                                    div.innerHTML = '<strong>⏱️ Last Updated:</strong> ' + data.timestamps.tide;
                                }
                            });
                        }
                    }
                }

                // Store current as previous for next comparison
                previousValues = {
                    rainfall: currentRainfall,
                    temperature: currentTemperature,
                    humidity: currentHumidity,
                    wind: currentWind,
                    tide: currentTide
                };
                
                // Reset countdown
                refreshSeconds = 300;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }, 300000);

    // Keyboard Navigation
    document.addEventListener('keydown', function(e) {
        // Ignore if user is typing in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        const keyboardHint = document.getElementById('keyboard-hint');
        
        // Show/hide keyboard shortcuts help with '?'
        if (e.key === '?') {
            keyboardHint.classList.toggle('show');
            return;
        }

        // Navigate to sections with number keys
        const sectionMap = {
            '1': 'current-conditions',
            '2': 'weather-forecast',
            '3': 'insights',
            '4': 'trends',
            '5': 'analysis',
            '6': 'flood-records'
        };

        if (sectionMap[e.key]) {
            e.preventDefault();
            const targetElement = document.getElementById(sectionMap[e.key]);
            if (targetElement) {
                // Expand section if collapsed
                const content = targetElement.querySelector('.card-content');
                if (content && content.classList.contains('collapsed')) {
                    const header = targetElement.querySelector('.card-header');
                    if (header) toggleSection(header);
                }
                
                // Smooth scroll to element
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Add highlight effect
                targetElement.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.3)';
                setTimeout(() => {
                    targetElement.style.boxShadow = '';
                }, 2000);
            }
        }
    });

    // Show keyboard hint on page load briefly
    window.addEventListener('load', function() {
        const keyboardHint = document.getElementById('keyboard-hint');
        setTimeout(() => {
            keyboardHint.classList.add('show');
        }, 1000);
        setTimeout(() => {
            keyboardHint.classList.remove('show');
        }, 5000);
    });

    // Function to update metrics with trend indicators
    function updateMetricWithTrend(selector, newValue) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        const oldValue = parseFloat(element.textContent);
        const currentValue = parseFloat(newValue);
        
        // Remove existing trend indicator
        const existingTrend = element.parentElement.querySelector('.trend-indicator');
        if (existingTrend) existingTrend.remove();
        
        // Update value
        element.textContent = newValue;
        
        // Add trend indicator
        if (!isNaN(oldValue) && !isNaN(currentValue)) {
            const trendSpan = document.createElement('span');
            trendSpan.className = 'trend-indicator';
            
            if (currentValue > oldValue) {
                trendSpan.classList.add('trend-up');
                trendSpan.innerHTML = '<i class="fas fa-arrow-up"></i>';
            } else if (currentValue < oldValue) {
                trendSpan.classList.add('trend-down');
                trendSpan.innerHTML = '<i class="fas fa-arrow-down"></i>';
            } else {
                trendSpan.classList.add('trend-stable');
                trendSpan.innerHTML = '<i class="fas fa-minus"></i>';
            }
            
            element.parentElement.appendChild(trendSpan);
        }
    }

    // Event Records Modal Functions
    function openEventRecordsModal() {
        const modal = document.getElementById('eventRecordsModal');
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            // Add event listeners for automatic filtering
            const startYearSelect = document.getElementById('filter-start-year');
            const endYearSelect = document.getElementById('filter-end-year');
            
            if (startYearSelect && endYearSelect) {
                // Remove existing listeners to avoid duplicates
                startYearSelect.removeEventListener('change', handleStartYearChange);
                endYearSelect.removeEventListener('change', handleEndYearChange);
                
                // Add new listeners for year constraint logic
                startYearSelect.addEventListener('change', handleStartYearChange);
                endYearSelect.addEventListener('change', handleEndYearChange);
            }
        }
    }

    function handleStartYearChange() {
        const startYearSelect = document.getElementById('filter-start-year');
        const endYearSelect = document.getElementById('filter-end-year');
        const selectedStartYear = startYearSelect.value;
        
        if (selectedStartYear) {
            // Filter "To Year" options to show only years >= selected start year
            filterYearOptions(endYearSelect, parseInt(selectedStartYear), 'min');
        } else {
            // If start year is cleared, reset "To Year" options
            resetYearOptions(endYearSelect);
        }
        
        // Apply the filter to the table
        applyFloodRecordFilter();
    }

    function handleEndYearChange() {
        const startYearSelect = document.getElementById('filter-start-year');
        const endYearSelect = document.getElementById('filter-end-year');
        const selectedEndYear = endYearSelect.value;
        
        if (selectedEndYear) {
            // Filter "From Year" options to show only years <= selected end year
            filterYearOptions(startYearSelect, parseInt(selectedEndYear), 'max');
        } else {
            // If end year is cleared, reset "From Year" options
            resetYearOptions(startYearSelect);
        }
        
        // Apply the filter to the table
        applyFloodRecordFilter();
    }

    function filterYearOptions(selectElement, constraintYear, type) {
        const options = selectElement.getElementsByTagName('option');
        
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            const optionValue = option.value;
            
            // Skip the "-- All Years --" option
            if (optionValue === '') {
                continue;
            }
            
            const year = parseInt(optionValue);
            
            if (type === 'min') {
                // For "To Year": hide years < constraintYear
                option.style.display = year < constraintYear ? 'none' : '';
                option.disabled = year < constraintYear;
            } else if (type === 'max') {
                // For "From Year": hide years > constraintYear
                option.style.display = year > constraintYear ? 'none' : '';
                option.disabled = year > constraintYear;
            }
        }
        
        // If the currently selected value is now hidden, reset to default
        const currentValue = selectElement.value;
        if (currentValue) {
            const currentYear = parseInt(currentValue);
            if ((type === 'min' && currentYear < constraintYear) || 
                (type === 'max' && currentYear > constraintYear)) {
                selectElement.value = '';
            }
        }
    }

    function resetYearOptions(selectElement) {
        const options = selectElement.getElementsByTagName('option');
        
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            option.style.display = '';
            option.disabled = false;
        }
    }

    function closeEventRecordsModal() {
        const modal = document.getElementById('eventRecordsModal');
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }
    }

    // Fullscreen Chart Functions
    let fullscreenChartInstance = null;

    function openFullscreenChart(chartType) {
        const modal = document.getElementById('fullscreenChartModal');
        const canvas = document.getElementById('fullscreenChart');
        const titleElement = document.getElementById('fullscreen-chart-title');
        const iconElement = document.getElementById('fullscreen-chart-icon');
        
        // Set title and icon based on chart type
        const chartConfig = {
            casualties: {
                title: 'Casualties',
                icon: 'fas fa-user-injured',
                sourceChart: window.casualtiesChart
            },
            affected: {
                title: 'Affected Individuals',
                icon: 'fas fa-users',
                sourceChart: window.affectedChart
            },
            houses: {
                title: 'Houses Damaged',
                icon: 'fas fa-home',
                sourceChart: window.housesChart
            },
            damage: {
                title: 'Property Damage',
                icon: 'fas fa-dollar-sign',
                sourceChart: window.damageChart
            }
        };

        const config = chartConfig[chartType];
        if (!config || !config.sourceChart) {
            console.error('Chart not found:', chartType);
            return;
        }

        titleElement.textContent = config.title;
        iconElement.className = config.icon;

        // Destroy existing fullscreen chart if any
        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
        }

        // Get source chart data
        const sourceChart = config.sourceChart;
        
        // Create new chart configuration with copied data
        const newConfig = {
            type: sourceChart.config.type,
            data: {
                labels: [...sourceChart.data.labels],
                datasets: sourceChart.data.datasets.map(dataset => ({
                    label: dataset.label,
                    data: [...dataset.data],
                    backgroundColor: dataset.backgroundColor,
                    borderColor: dataset.borderColor,
                    borderWidth: dataset.borderWidth,
                    borderRadius: dataset.borderRadius,
                    hoverBackgroundColor: dataset.hoverBackgroundColor
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 14, weight: '600' },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#e2e8f0',
                        padding: 16,
                        titleFont: { size: 14, weight: '700' },
                        bodyFont: { size: 13, weight: '500' },
                        cornerRadius: 8,
                        callbacks: {
                            afterBody: function(tooltipItems) {
                                const date = tooltipItems[0].label;
                                const barangayInfo = barangayDataByDate[date];
                                if (barangayInfo && barangayInfo.length > 0) {
                                    return '\\n📍 Affected Barangays:\\n' + barangayInfo.join('\\n');
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: { size: 12, weight: '600' },
                            color: '#64748b'
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 12, weight: '600' },
                            color: '#64748b',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        };

        // Create new chart in fullscreen
        const ctx = canvas.getContext('2d');
        fullscreenChartInstance = new Chart(ctx, newConfig);

        // Show modal
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeFullscreenChart() {
        const modal = document.getElementById('fullscreenChartModal');
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // Destroy chart instance
        if (fullscreenChartInstance) {
            fullscreenChartInstance.destroy();
            fullscreenChartInstance = null;
        }
    }

    // Close modal when clicking on backdrop or pressing Escape
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('eventRecordsModal');
        if (modal) {
            // Close on backdrop click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeEventRecordsModal();
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (modal.classList.contains('show')) {
                        closeEventRecordsModal();
                    }
                    // Also close fullscreen chart if open
                    const fullscreenModal = document.getElementById('fullscreenChartModal');
                    if (fullscreenModal && fullscreenModal.classList.contains('show')) {
                        closeFullscreenChart();
                    }
                }
            });
        }

        // Close fullscreen modal on backdrop click
        const fullscreenModal = document.getElementById('fullscreenChartModal');
        if (fullscreenModal) {
            fullscreenModal.addEventListener('click', function(e) {
                if (e.target === fullscreenModal) {
                    closeFullscreenChart();
                }
            });
        }
    });

    // Flood Records Filter Functions
    function applyFloodRecordFilter() {
        const startYear = document.getElementById('filter-start-year').value;
        const endYear = document.getElementById('filter-end-year').value;
        
        // Remove validation - allow empty values
        if (startYear && endYear && parseInt(startYear) > parseInt(endYear)) {
            return; // Silently fail for invalid range
        }
        
        const table = document.querySelector('.flood-records-table tbody');
        const rows = table.getElementsByTagName('tr');
        let visibleCount = 0;
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const dateCell = row.getElementsByTagName('td')[0];
            
            if (dateCell) {
                const dateText = dateCell.textContent.trim();
                const year = parseInt(dateText.split('-')[0]);
                
                let shouldShow = true;
                
                if (startYear && year < parseInt(startYear)) {
                    shouldShow = false;
                }
                if (endYear && year > parseInt(endYear)) {
                    shouldShow = false;
                }
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        // Update count badges (both modal and button)
        const modalCountBadge = document.getElementById('modal-record-count');
        if (modalCountBadge) {
            modalCountBadge.textContent = visibleCount;
        }
        const countBadge = document.querySelector('.records-count-badge span');
        if (countBadge) {
            countBadge.textContent = visibleCount;
        }

        // Show/hide empty state and table
        const emptyState = document.getElementById('flood-records-empty-state');
        const tableContainer = document.querySelector('.flood-records-table-container');
        
        if (visibleCount === 0) {
            tableContainer.style.display = 'none';
            emptyState.classList.add('show');
        } else {
            tableContainer.style.display = 'block';
            emptyState.classList.remove('show');
        }
        
        // Update export link to include filter parameters
        const exportBtn = document.getElementById('export-pdf-btn');
        let exportUrl = '{% url "export_flood_records" %}?type=pdf';
        if (startYear) exportUrl += `&start_year=${startYear}`;
        if (endYear) exportUrl += `&end_year=${endYear}`;
        exportBtn.href = exportUrl;
        
        console.log(`Filter applied: ${visibleCount} records shown`);
    }

    function resetFloodRecordFilter() {
        // Clear input fields
        document.getElementById('filter-start-year').value = '';
        document.getElementById('filter-end-year').value = '';
        
        // Show all rows
        const table = document.querySelector('.flood-records-table tbody');
        const rows = table.getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            rows[i].style.display = '';
        }

        // Hide empty state and show table
        const emptyState = document.getElementById('flood-records-empty-state');
        const tableContainer = document.querySelector('.flood-records-table-container');
        tableContainer.style.display = 'block';
        emptyState.classList.remove('show');
        
        // Reset count badges (both modal and button)
        const modalCountBadge = document.getElementById('modal-record-count');
        if (modalCountBadge) {
            modalCountBadge.textContent = {{ flood_records|length }};
        }
        const countBadge = document.querySelector('.records-count-badge span');
        if (countBadge) {
            countBadge.textContent = {{ flood_records|length }};
        }
        
        // Reset export link
        const exportBtn = document.getElementById('export-pdf-btn');
        exportBtn.href = '{% url "export_flood_records" %}?type=pdf';
        
        console.log('Filter reset: All records shown');
    }
</script>

{% endblock %}