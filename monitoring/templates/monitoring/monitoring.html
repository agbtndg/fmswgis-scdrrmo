{% extends 'users/base.html' %}
{% load static %}

{% block title %}Silay City DRRMO Monitoring Dashboard{% endblock %}

{% block header_title %}SCDRRMO - FMSWGIS{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
<style>
        :root {
            --primary-blue: #1e3a5f;
            --secondary-blue: #2563eb;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
            --text-dark: #1e293b;
            --text-muted: #64748b;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu;
            margin: 0;
            padding-top: 64px !important;
            background-color: white;
        }

        .main-content {
            padding: 0 !important;
            max-width: none !important;
            margin: 0 !important;
        }

        html, body {
            overflow-x: hidden !important;
            width: 100% !important;
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation Bar */
        .nav-bar {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            flex-wrap: wrap;
            gap: 12px;
        }

        .page-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            padding: 40px 36px;
            border-radius: 16px;
            border: none;
            margin-bottom: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3), 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .page-header::after {
            content: '🌊';
            position: absolute;
            bottom: -20px;
            left: -10px;
            font-size: 120px;
            opacity: 0.08;
            pointer-events: none;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 900;
            color: white;
            margin-bottom: 8px;
            letter-spacing: -0.03em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .page-header h1::before {
            content: '📡';
            margin-right: 12px;
            font-size: 28px;
        }

        .page-header p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid var(--secondary-blue);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            text-decoration: none;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .back-to-dashboard {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
            font-size: 14px;
            font-weight: 700;
            padding: 12px 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            cursor: pointer;
        }

        .back-to-dashboard:hover {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(37, 99, 235, 0.35);
        }

        .back-to-dashboard i {
            font-size: 12px;
        }

        .nav-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-title i {
            color: var(--secondary-blue);
            font-size: 18px;
        }

        .print-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .print-button:hover {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(37, 99, 235, 0.35);
        }

        .card {
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        /* Increase z-index when card contains active tooltips */
        .card:has(.metric-item:hover),
        .card:has(.help-icon:hover) {
            z-index: 200;
        }

        .card.collapsible {
            overflow: visible;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        .card-header:hover {
            z-index: 1000;
        }

        .card-header:hover h2 {
            color: var(--secondary-blue);
        }

        .card h2 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 18px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.01em;
            transition: color 0.2s;
        }

        .card h2 i {
            color: var(--secondary-blue);
            font-size: 20px;
        }

        .collapse-icon {
            font-size: 20px;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .card-content {
            max-height: 10000px;
            overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .card-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .refresh-info {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
            position: relative;
        }

        .metric-item {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            padding: 24px;
            border-radius: 20px;
            border: 2px solid transparent;
            position: relative;
            cursor: help;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.08),
                0 3px 8px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.95),
                inset 0 -2px 0 rgba(0, 0, 0, 0.03);
            transform: translateZ(0);
            transform-style: preserve-3d;
            background-clip: padding-box;
        }

        .metric-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: 120px;
            opacity: 0.08;
            transition: all 0.3s ease;
            transform: translateZ(-1px);
        }

        .metric-item:hover {
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.18),
                0 8px 16px rgba(0, 0, 0, 0.12),
                inset 0 2px 0 rgba(255, 255, 255, 1),
                inset 0 -2px 0 rgba(0, 0, 0, 0.05);
            transform: translateY(-8px) translateZ(12px) scale(1.02);
        }

        .metric-item:hover::before {
            opacity: 0.12;
            transform: scale(1.1) rotate(10deg) translateZ(-1px);
        }

        /* Rainfall Card Design - Rain Drops Pattern */
        .metric-item:nth-child(1) {
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 50%, #ffffff 100%);
            border-image: linear-gradient(135deg, #93c5fd, #3b82f6) 1;
            box-shadow: 
                0 6px 16px rgba(59, 130, 246, 0.2),
                0 3px 8px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.95),
                inset 0 -2px 4px rgba(59, 130, 246, 0.1);
        }

        .metric-item:nth-child(1)::before {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            width: 100px;
            height: 100px;
            background: 
                radial-gradient(circle at 30% 20%, #3b82f6 0%, #3b82f6 8%, transparent 8%),
                radial-gradient(circle at 65% 35%, #60a5fa 0%, #60a5fa 6%, transparent 6%),
                radial-gradient(circle at 45% 50%, #93c5fd 0%, #93c5fd 10%, transparent 10%),
                radial-gradient(circle at 75% 65%, #3b82f6 0%, #3b82f6 7%, transparent 7%),
                radial-gradient(circle at 25% 70%, #60a5fa 0%, #60a5fa 5%, transparent 5%);
            opacity: 0.15;
            animation: rain-fall 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes rain-fall {
            0%, 100% { transform: translateY(0); opacity: 0.15; }
            50% { transform: translateY(10px); opacity: 0.25; }
        }

        .metric-item:nth-child(1):hover {
            border-image: linear-gradient(135deg, #60a5fa, #2563eb) 1;
            box-shadow: 
                0 16px 48px rgba(59, 130, 246, 0.25),
                0 8px 16px rgba(59, 130, 246, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 1),
                0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Temperature Card Design - Sun/Thermometer */
        .metric-item:nth-child(2) {
            background: linear-gradient(135deg, #fed7aa 0%, #fef3c7 50%, #fffbeb 100%);
            border-image: linear-gradient(135deg, #fbbf24, #f59e0b) 1;
            box-shadow: 
                0 6px 16px rgba(245, 158, 11, 0.2),
                0 3px 8px rgba(245, 158, 11, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.95),
                inset 0 -2px 4px rgba(245, 158, 11, 0.1);
        }

        .metric-item:nth-child(2)::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 15px;
            width: 80px;
            height: 80px;
            background: 
                radial-gradient(circle at center, #f59e0b 0%, #f59e0b 25%, transparent 25%),
                conic-gradient(from 0deg, transparent 0deg, transparent 40deg, #fbbf24 40deg, #fbbf24 50deg, transparent 50deg, transparent 90deg, #fbbf24 90deg, #fbbf24 100deg, transparent 100deg, transparent 140deg, #fbbf24 140deg, #fbbf24 150deg, transparent 150deg, transparent 190deg, #fbbf24 190deg, #fbbf24 200deg, transparent 200deg, transparent 240deg, #fbbf24 240deg, #fbbf24 250deg, transparent 250deg, transparent 290deg, #fbbf24 290deg, #fbbf24 300deg, transparent 300deg, transparent 340deg, #fbbf24 340deg, #fbbf24 350deg, transparent 350deg);
            opacity: 0.12;
            animation: sun-pulse 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes sun-pulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.12; }
            50% { transform: scale(1.1) rotate(45deg); opacity: 0.18; }
        }

        .metric-item:nth-child(2):hover {
            border-image: linear-gradient(135deg, #f59e0b, #d97706) 1;
            box-shadow: 
                0 16px 48px rgba(245, 158, 11, 0.25),
                0 8px 16px rgba(245, 158, 11, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 1),
                0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        /* Humidity Card Design - Water Droplet */
        .metric-item:nth-child(3) {
            background: linear-gradient(135deg, #ddd6fe 0%, #ede9fe 50%, #faf5ff 100%);
            border-image: linear-gradient(135deg, #a78bfa, #8b5cf6) 1;
            box-shadow: 
                0 6px 16px rgba(139, 92, 246, 0.2),
                0 3px 8px rgba(139, 92, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.95),
                inset 0 -2px 4px rgba(139, 92, 246, 0.1);
        }

        .metric-item:nth-child(3)::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 90px;
            height: 90px;
            background: 
                radial-gradient(ellipse 12px 16px at 25% 25%, #8b5cf6 0%, #8b5cf6 100%, transparent 100%),
                radial-gradient(ellipse 8px 12px at 70% 20%, #a78bfa 0%, #a78bfa 100%, transparent 100%),
                radial-gradient(ellipse 10px 14px at 50% 60%, #8b5cf6 0%, #8b5cf6 100%, transparent 100%),
                radial-gradient(ellipse 6px 10px at 80% 70%, #c4b5fd 0%, #c4b5fd 100%, transparent 100%);
            opacity: 0.15;
            animation: droplet-fall 3.5s ease-in-out infinite;
            pointer-events: none;
            filter: blur(0.5px);
        }

        @keyframes droplet-fall {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.15; }
            50% { transform: translateY(15px) scale(1.05); opacity: 0.25; }
        }

        .metric-item:nth-child(3):hover {
            border-image: linear-gradient(135deg, #8b5cf6, #7c3aed) 1;
            box-shadow: 
                0 16px 48px rgba(139, 92, 246, 0.25),
                0 8px 16px rgba(139, 92, 246, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 1),
                0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Wind Speed Card Design - Wind Waves */
        .metric-item:nth-child(4) {
            background: linear-gradient(135deg, #ccfbf1 0%, #d1fae5 50%, #ecfdf5 100%);
            border-image: linear-gradient(135deg, #6ee7b7, #10b981) 1;
            box-shadow: 
                0 6px 16px rgba(16, 185, 129, 0.2),
                0 3px 8px rgba(16, 185, 129, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.95),
                inset 0 -2px 4px rgba(16, 185, 129, 0.1);
        }

        .metric-item:nth-child(4)::before {
            content: '';
            position: absolute;
            top: 15px;
            right: 10px;
            width: 100px;
            height: 80px;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 8px,
                    #10b981 8px,
                    #10b981 10px,
                    transparent 10px,
                    transparent 15px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 5px,
                    #34d399 5px,
                    #34d399 7px,
                    transparent 7px,
                    transparent 18px
                );
            background-position: 0 20px, 0 45px;
            background-repeat: no-repeat;
            opacity: 0.15;
            animation: wind-blow 3s ease-in-out infinite;
            pointer-events: none;
            mask-image: linear-gradient(to left, transparent, black 20%, black 80%, transparent);
        }

        @keyframes wind-blow {
            0%, 100% { transform: translateX(0); opacity: 0.15; }
            50% { transform: translateX(-10px); opacity: 0.25; }
        }

        .metric-item:nth-child(4):hover {
            border-image: linear-gradient(135deg, #34d399, #059669) 1;
            box-shadow: 
                0 16px 48px rgba(16, 185, 129, 0.25),
                0 8px 16px rgba(16, 185, 129, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 1),
                0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Tide Level Card Design - Ocean Waves */
        .metric-item:nth-child(5) {
            background: linear-gradient(135deg, #cffafe 0%, #e0f2fe 50%, #f0f9ff 100%);
            border-image: linear-gradient(135deg, #67e8f9, #06b6d4) 1;
            box-shadow: 
                0 6px 16px rgba(6, 182, 212, 0.2),
                0 3px 8px rgba(6, 182, 212, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.95),
                inset 0 -2px 4px rgba(6, 182, 212, 0.1);
        }

        .metric-item:nth-child(5)::before {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 0;
            width: 110px;
            height: 70px;
            background: 
                radial-gradient(ellipse 50px 15px at 25% 30%, #06b6d4 0%, #06b6d4 100%, transparent 100%),
                radial-gradient(ellipse 45px 12px at 65% 50%, #22d3ee 0%, #22d3ee 100%, transparent 100%),
                radial-gradient(ellipse 40px 10px at 40% 70%, #67e8f9 0%, #67e8f9 100%, transparent 100%);
            opacity: 0.15;
            animation: wave-motion 4s ease-in-out infinite;
            pointer-events: none;
            filter: blur(1px);
        }

        @keyframes wave-motion {
            0%, 100% { transform: translateX(0) translateY(0); opacity: 0.15; }
            50% { transform: translateX(-8px) translateY(-5px); opacity: 0.25; }
        }

        .metric-item:nth-child(5):hover {
            border-image: linear-gradient(135deg, #22d3ee, #0891b2) 1;
            box-shadow: 
                0 16px 48px rgba(6, 182, 212, 0.25),
                0 8px 16px rgba(6, 182, 212, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 1),
                0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .metric-item:hover .metric-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .metric-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.98));
            color: white;
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            white-space: normal;
            width: 320px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            margin-top: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .metric-item:hover .metric-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .metric-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: rgba(17, 24, 39, 0.98);
        }

        .metric-item i {
            font-size: 18px;
            margin-right: 8px;
            position: relative;
            z-index: 2;
        }

        .metric-item:nth-child(1) i { color: #3b82f6; text-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
        .metric-item:nth-child(2) i { color: #f59e0b; text-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }
        .metric-item:nth-child(3) i { color: #8b5cf6; text-shadow: 0 2px 4px rgba(139, 92, 246, 0.3); }
        .metric-item:nth-child(4) i { color: #10b981; text-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }
        .metric-item:nth-child(5) i { color: #06b6d4; text-shadow: 0 2px 4px rgba(6, 182, 212, 0.3); }

        .metric-label {
            display: flex;
            align-items: center;
            color: var(--text-dark);
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 2;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 900;
            position: relative;
            z-index: 2;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .trend-indicator.trend-up {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .trend-indicator.trend-down {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .trend-indicator.trend-neutral {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        .trend-indicator i {
            font-size: 10px;
        }

        .metric-label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
            opacity: 0.75;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.2;
            margin: 8px 0;
        }

        .metric-item:nth-child(1) .metric-label { color: #2563eb; }
        .metric-item:nth-child(1) .metric-value { color: #1e40af; text-shadow: 0 2px 4px rgba(59, 130, 246, 0.15); }
        
        .metric-item:nth-child(2) .metric-label { color: #f59e0b; }
        .metric-item:nth-child(2) .metric-value { color: #d97706; text-shadow: 0 2px 4px rgba(245, 158, 11, 0.15); }
        
        .metric-item:nth-child(3) .metric-label { color: #8b5cf6; }
        .metric-item:nth-child(3) .metric-value { color: #6d28d9; text-shadow: 0 2px 4px rgba(139, 92, 246, 0.15); }
        
        .metric-item:nth-child(4) .metric-label { color: #10b981; }
        .metric-item:nth-child(4) .metric-value { color: #047857; text-shadow: 0 2px 4px rgba(16, 185, 129, 0.15); }
        
        .metric-item:nth-child(5) .metric-label { color: #06b6d4; }
        .metric-item:nth-child(5) .metric-value { color: #0e7490; text-shadow: 0 2px 4px rgba(6, 182, 212, 0.15); }

        .risk-banner {
            width: 100%;
            padding: 28px 32px;
            margin-bottom: 24px;
            border-radius: 16px;
            color: whitesmoke;
            text-align: center;
            font-size: 22px;
            font-weight: 900;
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.2),
                0 4px 10px rgba(0, 0, 0, 0.15),
                inset 0 2px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.4);
            position: relative;
            cursor: help;
            letter-spacing: 0.02em;
            z-index: 150;
            transition: all 0.3s ease;
            overflow: visible;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .risk-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
            border-radius: 16px;
            overflow: hidden;
        }

        .risk-banner:hover::before {
            left: 100%;
        }
        
        .risk-banner:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.25),
                0 6px 16px rgba(0, 0, 0, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.25);
            z-index: 250;
        }

        .risk-banner:hover .risk-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .risk-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.98));
            color: white;
            padding: 18px 22px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 400;
            white-space: normal;
            width: 380px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            margin-top: 10px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            line-height: 1.6;
        }

        .risk-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-bottom-color: rgba(17, 24, 39, 0.98);
        }

        .risk-tooltip strong {
            color: #fbbf24;
            font-weight: 600;
        }

        .risk-banner.low-risk { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: rgba(254, 243, 199, 0.6);
        }

        .risk-banner.low-risk::after {
            content: '✓';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 32px;
            opacity: 0.3;
            font-weight: bold;
        }

        .risk-banner.moderate-risk { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-color: rgba(254, 215, 170, 0.6);
            animation: moderate-pulse 3s ease-in-out infinite;
        }

        .risk-banner.moderate-risk::after {
            content: '⚠';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 36px;
            opacity: 0.4;
            animation: warning-pulse 2s ease-in-out infinite;
        }

        @keyframes moderate-pulse {
            0%, 100% { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 4px 10px rgba(0, 0, 0, 0.15), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.2); }
            50% { box-shadow: 0 8px 20px rgba(249, 115, 22, 0.4), 0 4px 10px rgba(249, 115, 22, 0.3), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.2); }
        }

        @keyframes warning-pulse {
            0%, 100% { opacity: 0.4; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
        }

        .risk-banner.high-risk { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: rgba(254, 202, 202, 0.6);
            animation: high-risk-pulse 2s ease-in-out infinite;
        }

        .risk-banner.high-risk::after {
            content: '⚠';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            opacity: 0.5;
            animation: critical-warning 1.5s ease-in-out infinite;
        }

        @keyframes high-risk-pulse {
            0%, 100% { 
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), 0 4px 10px rgba(0, 0, 0, 0.15), inset 0 2px 0 rgba(255, 255, 255, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.2);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 8px 24px rgba(239, 68, 68, 0.6), 0 4px 12px rgba(239, 68, 68, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.4), inset 0 -2px 4px rgba(0, 0, 0, 0.25);
                transform: scale(1.005);
            }
        }

        @keyframes critical-warning {
            0%, 100% { opacity: 0.5; transform: translateY(-50%) scale(1) rotate(0deg); }
            25% { opacity: 0.8; transform: translateY(-50%) scale(1.15) rotate(-10deg); }
            75% { opacity: 0.8; transform: translateY(-50%) scale(1.15) rotate(10deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        .graph-section {
            margin-bottom: 28px;
            padding: 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 14px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .graph-section canvas {
            max-height: 350px;
        }

        .graph-title {
            font-size: 18px;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .toggle-switch {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            width: fit-content;
            transition: all 0.3s ease;
        }
        
        .toggle-switch:hover {
            border-color: #c7d2fe;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        
        .toggle-switch input[type="checkbox"] {
            width: 44px;
            height: 24px;
            appearance: none;
            background: #d1d5db;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .toggle-switch input[type="checkbox"]:checked::before {
            left: 23px;
        }

        .toggle-switch label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 600;
            user-select: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        table th, table td {
            border: 1px solid var(--border-gray);
            padding: 16px 18px;
            text-align: left;
        }

        table th {
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.6px;
        }

        table td {
            color: var(--text-dark);
            font-weight: 500;
        }

        table tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.06);
        }

        table tbody tr:nth-child(odd) {
            background-color: rgba(248, 250, 252, 0.5);
        }

        /* Year-over-year comparison styles */
        table td span[class^="year-"] {
            display: inline-block;
            margin-right: 12px;
            padding: 2px 0;
            font-size: 13px;
        }

        table td span[class^="year-"]:last-child {
            margin-right: 0;
        }

        .hidden {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            color: white;
            text-decoration: none;
            border-radius: 10px;
            margin-top: 16px;
            margin-right: 8px;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(37, 99, 235, 0.35);
        }

        .btn-apply {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 13px;
            margin-top: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-apply::before {
            content: '✓';
            font-size: 14px;
        }

        .btn-apply:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }
        
        .btn-apply:active {
            transform: translateY(0);
        }

        .btn-reset {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 13px;
            margin-top: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.25);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-reset::before {
            content: '↻';
            font-size: 14px;
        }

        .btn-reset:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.35);
        }
        
        .btn-reset:active {
            transform: translateY(0);
        }

        .btn-edit {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2);
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.2);
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        /* Charts Grid - Responsive 2-column layout */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-color: rgba(37, 99, 235, 0.2);
            transform: translateY(-2px);
        }

        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: -0.01em;
        }

        .chart-container canvas {
            max-height: 220px;
        }

        /* Chart Insight Box */
        .chart-insight {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 12px;
            line-height: 1.5;
            color: #1e40af;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);
            animation: slideIn 0.4s ease;
        }

        .chart-insight i {
            color: #3b82f6;
            font-size: 14px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .chart-insight span {
            flex: 1;
            font-weight: 500;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Insights Section */
        .insights-section {
            margin-bottom: 28px;
        }

        .insights-section h3 {
            font-size: 17px;
            font-weight: 900;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e7ff;
        }
        
        .insights-section h3 i {
            background: none;
            -webkit-text-fill-color: currentColor;
            font-size: 18px;
        }

        .alerts-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .alert-card {
            padding: 20px 24px;
            border-radius: 14px;
            border-left: 6px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .alert-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.05;
            transition: all 0.3s ease;
        }

        .alert-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transform: translateX(4px);
        }
        
        .alert-card:hover::before {
            transform: scale(1.2);
            opacity: 0.08;
        }

        .alert-high { 
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
            border-left-color: #ef4444;
            color: #991b1b;
        }
        .alert-high::before { background: #ef4444; }
        
        .alert-medium { 
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
            border-left-color: #f59e0b;
            color: #92400e;
        }
        .alert-medium::before { background: #f59e0b; }
        
        .alert-low { 
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border-left-color: #10b981;
            color: #065f46;
        }
        .alert-low::before { background: #10b981; }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            margin-bottom: 10px;
            font-size: 15px;
            position: relative;
            z-index: 1;
        }
        
        .alert-header i {
            font-size: 16px;
        }

        .alert-message {
            font-size: 13px;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .analysis-card {
            padding: 18px 20px;
            border-radius: 12px;
            border-left: 5px solid;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            opacity: 0.03;
            transition: all 0.4s ease;
        }
        
        .analysis-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .analysis-card:hover::before {
            transform: scale(1.5);
            opacity: 0.05;
        }

        .impact-high { 
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }
        .impact-high::before { background: #ef4444; }
        
        .impact-moderate,
        .impact-medium { 
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
        }
        .impact-moderate::before,
        .impact-medium::before { background: #f59e0b; }
        
        .impact-low { 
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }
        .impact-low::before { background: #10b981; }

        .analysis-title {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 13px;
            position: relative;
            z-index: 1;
        }

        .analysis-content {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 18px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-gray);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .recommendation-item:hover {
            transform: translateX(6px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-color: #c7d2fe;
        }

        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            flex-shrink: 0;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .priority-high { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .priority-medium { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .priority-low { 
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-action {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 6px;
            font-size: 13px;
        }

        .recommendation-reason {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .trends-container {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .trend-card {
            padding: 18px 20px;
            border-radius: 12px;
            border: 2px solid #e9d5ff;
            background: linear-gradient(135deg, #faf5ff 0%, #ffffff 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.08);
            position: relative;
            overflow: hidden;
        }
        
        .trend-card::before {
            content: '📈';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 40px;
            opacity: 0.06;
            pointer-events: none;
        }
        
        .trend-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.15);
            border-color: #c4b5fd;
        }

        .trend-title {
            font-weight: 700;
            color: #5b21b6;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .trend-title::before {
            content: '●';
            color: #8b5cf6;
            font-size: 10px;
        }

        .trend-analysis {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .trend-recommendation {
            font-size: 12px;
            color: #7c3aed;
            font-weight: 600;
            font-style: italic;
            padding: 8px 12px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 6px;
            border-left: 3px solid #8b5cf6;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            color: var(--border-gray);
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .empty-state h3 {
            color: var(--text-dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 13px;
            line-height: 1.5;
        }

        /* Time Range Selector */
        .time-range-selector {
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 2px solid #e0e7ff;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.08);
        }
        
        .time-range-selector > label {
            display: block;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 14px;
            color: #1e40af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .range-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .time-range-btn {
            padding: 10px 18px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .time-range-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .time-range-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .time-range-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .time-range-btn.btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .time-range-btn.btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .export-btn {
            padding: 12px 24px;
            background: white;
            color: var(--text-dark);
            border: 2px solid;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        
        .export-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .export-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            text-decoration: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .export-btn:active {
            transform: translateY(-1px);
        }

        .export-btn i {
            font-size: 16px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }
        
        .export-btn:hover i {
            transform: scale(1.15) rotate(5deg);
        }
        
        .export-btn span {
            position: relative;
            z-index: 1;
        }

        .export-btn.csv {
            border-color: #10b981;
            color: #10b981;
        }
        
        .export-btn.csv::before {
            background: #d1fae5;
        }

        .export-btn.csv:hover {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #047857;
            border-color: #059669;
        }

        .export-btn.pdf {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .export-btn.pdf::before {
            background: #fee2e2;
        }

        .export-btn.pdf:hover {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #b91c1c;
            border-color: #dc2626;
        }

        .custom-date-picker {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 16px;
            padding: 16px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #e0e7ff;
        }
        
        .custom-date-picker label {
            font-weight: 600;
            color: #1e40af;
        }

        .custom-date-picker input {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .custom-date-picker input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .custom-date-picker span {
            font-weight: 600;
            color: #6b7280;
        }

        #range-label {
            font-size: 13px;
            font-weight: 600;
            color: #1e40af;
            margin-top: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        #range-label strong {
            color: #1e3a8a;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 16px;
            }

            .nav-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .nav-left {
                width: 100%;
            }

            .print-button {
                width: 100%;
                justify-content: center;
            }

            .export-buttons {
                width: 100%;
            }

            .export-btn {
                flex: 1;
                justify-content: center;
                min-width: 140px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .card {
                padding: 16px;
            }

            table {
                font-size: 11px;
            }

            table th, table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .content-wrapper {
                padding: 12px;
            }

            .risk-banner {
                font-size: 16px;
                padding: 16px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 16px;
            }

            .card h2 {
                font-size: 16px;
            }

            .metric-value {
                font-size: 16px;
            }

            .nav-bar {
                padding: 12px;
            }

            .nav-title {
                font-size: 14px;
            }

            .quick-nav {
                display: none;
            }
        }

        /* Quick Navigation */
        .quick-nav {
            position: sticky;
            top: 80px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e0e7ff;
            border-radius: 14px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .quick-nav:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08);
            border-color: #c7d2fe;
        }

        .quick-nav h3 {
            margin: 0 0 16px 0;
            font-size: 15px;
            font-weight: 800;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-nav h3 i {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 16px;
        }

        .quick-nav-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-nav-link {
            padding: 10px 16px;
            background: white;
            color: var(--text-dark);
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .quick-nav-link i {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .quick-nav-link:hover {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            border-color: transparent;
        }
        
        .quick-nav-link:hover i {
            transform: scale(1.15) rotate(5deg);
        }
        
        .quick-nav-link:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        /* Flood Records Tabs */
        .flood-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            padding: 8px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 14px;
            border: 2px solid #e0e7ff;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.08);
        }

        .flood-tab {
            padding: 14px 24px;
            background: white;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .flood-tab::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.15);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .flood-tab:hover::before {
            width: 200px;
            height: 200px;
        }
        
        .flood-tab i {
            font-size: 16px;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .flood-tab:hover {
            color: #3b82f6;
            background: #eff6ff;
            border-color: #93c5fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .flood-tab:hover i {
            transform: scale(1.1) rotate(5deg);
        }

        .flood-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.35);
        }
        
        .flood-tab.active:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-2px);
        }

        .flood-tab-content {
            display: none;
        }

        .flood-tab-content.active {
            display: block;
        }

        /* Flood Records Section */
        .flood-records-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e5e7eb;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .flood-records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, #3b82f6, #60a5fa, transparent) 1;
            flex-wrap: wrap;
            gap: 16px;
        }

        .flood-records-title {
            font-size: 24px;
            font-weight: 900;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }

        .flood-records-title i {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
        }

        .flood-records-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin: 0;
            font-weight: 500;
        }

        .records-count-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid #93c5fd;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #1e40af;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .records-count-badge i {
            font-size: 16px;
        }

        .records-count-badge span {
            font-size: 18px;
            color: #3b82f6;
        }

        .records-export {
            margin-bottom: 24px;
        }

        .flood-records-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            margin-bottom: 24px;
        }

        .flood-records-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .flood-records-table thead {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .flood-records-table thead th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .flood-records-table thead th:last-child {
            border-right: none;
        }

        .flood-records-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .flood-records-table tbody tr:hover {
            background: linear-gradient(90deg, #eff6ff, #ffffff);
            box-shadow: inset 4px 0 0 #3b82f6;
        }

        .flood-records-table tbody td {
            padding: 12px;
            color: #374151;
            white-space: nowrap;
            border-right: 1px solid #f3f4f6;
        }

        .flood-records-table tbody td:last-child {
            border-right: none;
        }

        .flood-records-table tbody tr:last-child {
            border-bottom: none;
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 12px;
            border: 2px dashed #cbd5e0;
            margin: 20px 0;
        }

        .empty-state.show {
            display: block;
        }

        .empty-state-icon {
            font-size: 64px;
            color: #cbd5e0;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: #718096;
            max-width: 400px;
            margin: 0 auto;
        }

        .add-record-container {
            text-align: center;
            padding-top: 12px;
        }

        .add-record-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 32px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
        }

        .add-record-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .add-record-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .add-record-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            text-decoration: none;
        }

        .add-record-btn:active {
            transform: translateY(-1px);
        }

        .add-record-btn i {
            font-size: 18px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .add-record-btn:hover i {
            transform: scale(1.2) rotate(90deg);
        }

        .add-record-btn span {
            position: relative;
            z-index: 1;
        }

        /* Flood Records Filter */
        .flood-records-filter {
            margin-bottom: 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .filter-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-controls {
            padding: 20px;
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .filter-group input,
        .filter-group select,
        .year-select {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            width: 160px;
            transition: all 0.3s ease;
            background: white;
            cursor: pointer;
        }

        .filter-group input:focus,
        .filter-group select:focus,
        .year-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .year-select option {
            padding: 8px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .filter-apply-btn,
        .filter-reset-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-apply-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .filter-apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .filter-reset-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }

        .filter-reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
        }

        .filter-apply-btn:active,
        .filter-reset-btn:active {
            transform: translateY(0);
        }

        /* Compact spacing */
        .page-header {
            padding: 24px;
            margin-bottom: 20px;
        }

        .page-header h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .page-header p {
            font-size: 13px;
        }

        .risk-banner {
            padding: 20px 24px;
            margin-bottom: 20px;
            font-size: 18px;
        }

        /* Responsive charts */
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container canvas {
                max-height: 200px;
            }
        }

        /* Trend Indicators */
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            font-size: 14px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            animation: slideIn 0.3s ease;
        }

        .trend-up {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .trend-down {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .trend-stable {
            color: #64748b;
            background: rgba(100, 116, 139, 0.1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* At-a-Glance Summary */
        .summary-dashboard {
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.2);
            color: white;
        }

        .summary-dashboard h2 {
            color: white;
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 16px;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .summary-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 4px;
        }

        .summary-status {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Contextual Help */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secondary-blue);
            color: white;
            font-size: 11px;
            font-weight: 700;
            cursor: help;
            margin-left: 6px;
            transition: all 0.2s;
            position: relative;
            z-index: 1001;
        }

        .help-icon:hover {
            background: var(--primary-blue);
            transform: scale(1.1);
            z-index: 1002;
        }

        .help-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: normal;
            width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            line-height: 1.5;
        }

        .help-icon:hover .help-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .help-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 20px;
            margin-bottom: 10px;
        }

        .skeleton-chart {
            height: 220px;
            width: 100%;
        }

        /* Live Update Indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .live-pulse {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-live 2s ease-in-out infinite;
        }

        @keyframes pulse-live {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Refresh Countdown Badge */
        .refresh-countdown {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .refresh-icon {
            width: 8px;
            height: 8px;
            border: 2px solid #3b82f6;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        .badge-realtime {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge-updated {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .badge-historical {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        /* Keyboard Shortcuts Hint */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 11px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        .keyboard-hint kbd {
            background: var(--light-gray);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-weight: 600;
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-to-top::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .back-to-top:hover::before {
            opacity: 1;
        }

        .back-to-top i {
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .back-to-top:hover i {
            transform: translateY(-3px);
            animation: bounce 0.6s ease infinite;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .back-to-top:active {
            transform: scale(0.95);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(-3px);
            }
            50% {
                transform: translateY(-6px);
            }
        }

        /* Enhanced Mobile Touch Targets */
        @media (max-width: 768px) {
            .quick-nav-link {
                padding: 12px 16px;
                font-size: 13px;
            }

            .flood-tab {
                padding: 14px 18px;
                font-size: 13px;
            }

            .time-range-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .btn {
                padding: 14px 22px;
                font-size: 15px;
            }

            .flood-records-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .flood-records-title {
                font-size: 20px;
            }

            .records-count-badge {
                padding: 8px 16px;
                font-size: 13px;
            }

            .flood-records-table {
                font-size: 11px;
            }

            .flood-records-table thead th {
                padding: 10px 8px;
                font-size: 10px;
            }

            .flood-records-table tbody td {
                padding: 8px 6px;
            }

            .add-record-btn {
                padding: 12px 24px;
                font-size: 14px;
            }

            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1>Monitoring Dashboard</h1>
            <p>📊 Real-time flood risk monitoring and data analysis for Silay City, Negros Occidental</p>
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="quick-nav">
        <h3><i class="fas fa-compass"></i> Quick Navigation</h3>
        <div class="quick-nav-links">
            <a href="#weather-forecast" class="quick-nav-link"><i class="fas fa-cloud-sun"></i> Weather Forecast</a>
            <a href="#insights" class="quick-nav-link"><i class="fas fa-brain"></i> Insights</a>
            <a href="#trends" class="quick-nav-link"><i class="fas fa-water"></i> Trends</a>
            <a href="#analysis" class="quick-nav-link"><i class="fas fa-chart-bar"></i> Analysis</a>
            <a href="#flood-records" class="quick-nav-link"><i class="fas fa-list"></i> Records</a>
        </div>
    </div>

    <!-- Flood Risk Alert Banner -->
    <div class="risk-banner {% if 'Low Risk' in combined_risk_level %}low-risk{% elif 'Moderate Risk' in combined_risk_level %}moderate-risk{% elif 'High Risk' in combined_risk_level %}high-risk{% endif %}">
        <i class="fas fa-exclamation-triangle" style="margin-right: 12px;"></i>
        Current Flood Risk: {{ combined_risk_level }}
        <div class="risk-tooltip">
            <div style="font-weight: 700; margin-bottom: 12px; font-size: 14px; color: #60a5fa; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 8px;">
                <i class="fas fa-shield-alt"></i> Risk Assessment Breakdown
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div><strong>☔ Rainfall:</strong> {{ rainfall_data.value_mm }} mm</div>
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; {% if 'High' in rain_risk_level %}background: #ef4444; color: white;{% elif 'Moderate' in rain_risk_level %}background: #f97316; color: white;{% else %}background: #10b981; color: white;{% endif %}">{{ rain_risk_level }}</span>
                </div>
                <div style="font-size: 11px; color: #d1d5db; margin-left: 4px;">
                    {% if 'High' in rain_risk_level %}⚠️ Heavy rainfall detected - Immediate flood risk{% elif 'Moderate' in rain_risk_level %}⚡ Significant precipitation - Monitor closely{% else %}✓ Normal rainfall levels - Low flood threat{% endif %}
                </div>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div><strong>🌊 Tide Level:</strong> {{ tide_data.height_m }} m</div>
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; {% if 'High' in tide_risk_level %}background: #ef4444; color: white;{% elif 'Moderate' in tide_risk_level %}background: #f97316; color: white;{% else %}background: #10b981; color: white;{% endif %}">{{ tide_risk_level }}</span>
                </div>
                <div style="font-size: 11px; color: #d1d5db; margin-left: 4px;">
                    {% if 'High' in tide_risk_level %}⚠️ Very high tide - Coastal flooding probable{% elif 'Moderate' in tide_risk_level %}⚡ Elevated tide - Reduced drainage capacity{% else %}✓ Normal tide levels - Adequate drainage{% endif %}
                </div>
            </div>
            
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.15); font-size: 12px;">
                <strong>📊 Overall Risk:</strong>
                <div style="margin-top: 6px; color: #d1d5db;">
                    {% if 'High Risk' in combined_risk_level %}
                    <span style="color: #fca5a5;">🔴 CRITICAL:</span> Combined rainfall and tide levels create immediate flood threat. Emergency protocols should be activated. Monitor vulnerable areas closely.
                    {% elif 'Moderate Risk' in combined_risk_level %}
                    <span style="color: #fdba74;">🟡 ELEVATED:</span> Weather conditions indicate increased flood potential. Enhanced monitoring recommended. Prepare contingency measures.
                    {% else %}
                    <span style="color: #86efac;">🟢 NORMAL:</span> Current conditions within safe parameters. Continue routine monitoring. Standard flood preparedness protocols apply.
                    {% endif %}
                </div>
            </div>
            
            <div style="margin-top: 10px; padding: 8px; background: rgba(59, 130, 246, 0.15); border-radius: 6px; font-size: 11px; color: #bfdbfe;">
                <i class="fas fa-info-circle"></i> <strong>Note:</strong> Risk calculated using benchmark thresholds. Data updates hourly (rainfall/weather) and every 3 hours (tides).
            </div>
        </div>
    </div>

    <!-- Current Data Cards -->
    <div class="card" id="current-conditions">
        <h2>
            <i class="fas fa-gauge-high"></i> Current Conditions
            <span class="status-badge badge-realtime"><span class="live-pulse"></span> Real-time</span>
            <span class="refresh-countdown"><span class="refresh-icon"></span> <span id="refresh-timer">Refreshing in 5:00</span></span>
            <span class="help-icon">?
                <span class="help-tooltip">This section displays live environmental data from Open-Meteo API for Silay City, Negros Occidental. Current conditions (rainfall, temperature, humidity, wind) are updated hourly to provide accurate flood risk assessments.</span>
            </span>
        </h2>
        <div class="metrics-grid">
            <div class="metric-item">
                <div class="metric-label"><i class="fas fa-cloud-rain"></i> Rainfall</div>
                <div class="metric-value" data-rainfall>{{ rainfall_data.value_mm }} mm<span class="trend-indicator" data-trend-rainfall style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #60a5fa;"><i class="fas fa-cloud-rain"></i> Rainfall Measurement</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ rainfall_data.value_mm }} mm</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Accumulated precipitation in the last hour</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ rainfall_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Risk Assessment:</strong>
                            <div style="margin-top: 4px;">{% if rainfall_data.value_mm >= 50 %}<span style="color: #ef4444; font-weight: 600;">⚠️ HIGH RISK</span> - Heavy rainfall (≥50mm). Flood threat imminent. Activate emergency protocols.{% elif rainfall_data.value_mm >= 30 %}<span style="color: #f97316; font-weight: 600;">⚡ MODERATE RISK</span> - Significant rainfall (30-50mm). Increased flood potential. Monitor closely.{% else %}<span style="color: #10b981; font-weight: 600;">✓ LOW RISK</span> - Light rainfall (<30mm). Normal conditions. Continue routine monitoring.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label"><i class="fas fa-thermometer-half"></i> Temperature</div>
                <div class="metric-value" data-temperature>{{ weather_data.temperature_c }}°C<span class="trend-indicator" data-trend-temperature style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #f87171;"><i class="fas fa-thermometer-half"></i> Air Temperature</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ weather_data.temperature_c }}°C</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Measured at 2 meters above ground level</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ weather_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Flood Impact:</strong>
                            <div style="margin-top: 4px;">{% if weather_data.temperature_c > 32 %}<span style="color: #ef4444; font-weight: 600;">🔥 HIGH IMPACT</span> - Elevated temperatures (>32°C) increase atmospheric moisture and evaporation, potentially intensifying rainfall events.{% elif weather_data.temperature_c > 28 %}<span style="color: #f97316; font-weight: 600;">🌡️ MODERATE</span> - Warm conditions (28-32°C). Normal tropical climate parameters.{% else %}<span style="color: #10b981; font-weight: 600;">✓ NORMAL</span> - Temperature within typical range (<28°C). Standard conditions for the region.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label"><i class="fas fa-tint"></i> Humidity</div>
                <div class="metric-value" data-humidity>{{ weather_data.humidity_percent }}%<span class="trend-indicator" data-trend-humidity style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #8b5cf6;"><i class="fas fa-tint"></i> Relative Humidity</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ weather_data.humidity_percent }}%</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Atmospheric moisture content at 2m height</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ weather_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Flood Impact:</strong>
                            <div style="margin-top: 4px;">{% if weather_data.humidity_percent > 85 %}<span style="color: #ef4444; font-weight: 600;">💧 CRITICAL</span> - Very high humidity (>85%). Air is saturated with moisture, reducing evaporation capacity. Rainfall will accumulate rapidly, increasing flood risk significantly.{% elif weather_data.humidity_percent > 70 %}<span style="color: #f97316; font-weight: 600;">⚡ ELEVATED</span> - High humidity (70-85%). Moisture-laden air increases precipitation potential and reduces natural drainage.{% else %}<span style="color: #10b981; font-weight: 600;">✓ NORMAL</span> - Moderate humidity (<70%). Adequate evaporation capacity. Standard atmospheric conditions.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label"><i class="fas fa-wind"></i> Wind Speed</div>
                <div class="metric-value" data-wind>{{ weather_data.wind_speed_kph }} km/h<span class="trend-indicator" data-trend-wind style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #fbbf24;"><i class="fas fa-wind"></i> Wind Speed</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ weather_data.wind_speed_kph }} km/h</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Measured at 10 meters above ground level</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Location:</strong> Silay City, Negros Occidental</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.7959°N, 122.9749°E</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> Open-Meteo API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ weather_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 1 hour</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Weather Impact:</strong>
                            <div style="margin-top: 4px;">{% if weather_data.wind_speed_kph > 60 %}<span style="color: #ef4444; font-weight: 600;">🌪️ STORM WARNING</span> - Strong winds (>60 km/h). Potential tropical storm or typhoon. Severe weather alert. Compound flood risk.{% elif weather_data.wind_speed_kph > 40 %}<span style="color: #f97316; font-weight: 600;">💨 HIGH WINDS</span> - Strong breeze (40-60 km/h). Associated with weather systems. Monitor for storm development.{% elif weather_data.wind_speed_kph > 20 %}<span style="color: #fbbf24; font-weight: 600;">🍃 MODERATE</span> - Moderate winds (20-40 km/h). Fresh breeze conditions. Normal weather variability.{% else %}<span style="color: #10b981; font-weight: 600;">✓ CALM</span> - Light winds (<20 km/h). Gentle breeze or calm conditions. Stable weather pattern.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="metric-item">
                <div class="metric-label"><i class="fas fa-water"></i> Tide Level</div>
                <div class="metric-value" data-tide>{{ tide_data.height_m }} m<span class="trend-indicator" data-trend-tide style="display:none;"></span></div>
                <div class="metric-tooltip">
                    <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #10b981;"><i class="fas fa-water"></i> Tidal Height</div>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                            <div><strong>Current:</strong> {{ tide_data.height_m }} m</div>
                            <div style="margin-top: 4px; color: #d1d5db;"><em>Height relative to Mean Sea Level (MSL)</em></div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>📍 Monitoring Station:</strong> Cebu City</div>
                            <div style="color: #9ca3af; font-size: 10px;">Coordinates: 10.3157°N, 123.8854°E</div>
                            <div style="color: #9ca3af; font-size: 10px; margin-top: 2px;">Data applicable to coastal areas of Negros Occidental</div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div><strong>🔄 Data Source:</strong> WorldTides API</div>
                            <div><strong>⏱️ Last Updated:</strong> {{ tide_data.timestamp|date:"M d, Y H:i" }}</div>
                            <div style="color: #9ca3af; font-size: 10px;">Updates every 3 hours</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.15);">
                            <strong>Flood Impact:</strong>
                            <div style="margin-top: 4px;">{% if tide_data.height_m >= 1.5 %}<span style="color: #ef4444; font-weight: 600;">🌊 HIGH TIDE ALERT</span> - Very high tide (≥1.5m). Combined with rainfall, creates critical flood conditions in low-lying coastal areas. Storm surge potential.{% elif tide_data.height_m >= 1.0 %}<span style="color: #f97316; font-weight: 600;">⚠️ ELEVATED TIDE</span> - High tide (1.0-1.5m). Increased coastal flood risk. Drainage systems may be impeded. Monitor vulnerable areas.{% elif tide_data.height_m >= 0 %}<span style="color: #10b981; font-weight: 600;">✓ NORMAL TIDE</span> - Moderate tide level (0-1.0m). Standard tidal conditions. Natural drainage functioning normally.{% else %}<span style="color: #3b82f6; font-weight: 600;">🌑 LOW TIDE</span> - Below mean sea level (<0m). Optimal drainage conditions. Reduced coastal flood risk.{% endif %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Forecast Section -->
    <div class="card collapsible" id="weather-forecast">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-cloud-sun"></i> 7-Day Weather Forecast
                <span class="status-badge badge-updated">Open-Meteo - Silay City</span>
                <span class="help-icon">?
                    <span class="help-tooltip">7-day weather predictions from Open-Meteo API for Silay City, Negros Occidental (10.7959°N, 122.9749°E). Includes temperature, precipitation, humidity, and wind speed to help anticipate flood conditions. Updates hourly.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">
        <div class="toggle-switch" style="margin-bottom: 16px;">
            <input type="checkbox" id="toggleForecast" onchange="toggleView('forecast')">
            <label for="toggleForecast">Show Table View</label>
        </div>
        
        <!-- Forecast Chart View -->
        <div id="forecastChart">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Temperature Forecast (°C)</h3>
                    <canvas id="temperatureForecastChart"></canvas>
                    <div class="chart-insight" id="temp-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading temperature analysis...</span>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Precipitation Forecast (mm)</h3>
                    <canvas id="precipitationForecastChart"></canvas>
                    <div class="chart-insight" id="precip-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading precipitation analysis...</span>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Humidity Forecast (%)</h3>
                    <canvas id="humidityForecastChart"></canvas>
                    <div class="chart-insight" id="humidity-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading humidity analysis...</span>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Wind Speed Forecast (km/h)</h3>
                    <canvas id="windSpeedForecastChart"></canvas>
                    <div class="chart-insight" id="wind-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Loading wind analysis...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Forecast Table View -->
        <div id="forecastTable" class="hidden">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Min Temp</th>
                        <th>Max Temp</th>
                        <th>Precipitation</th>
                        <th>Humidity</th>
                        <th>Wind Speed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in weather_forecast %}
                    <tr>
                        <td>{{ day.formatted_date }}</td>
                        <td>{{ day.temp_min|floatformat:1 }}°C</td>
                        <td>{{ day.temp_max|floatformat:1 }}°C</td>
                        <td>{{ day.precipitation|floatformat:1 }} mm</td>
                        <td>{{ day.humidity|floatformat:0 }}%</td>
                        <td>{{ day.wind_speed|floatformat:1 }} km/h</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6">No forecast data available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- Flood Prediction Insights -->
    <div class="card collapsible" id="insights">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-brain"></i> Flood Prediction Insights
                <span class="help-icon">?
                    <span class="help-tooltip">Intelligent analysis combining forecast data with historical patterns to generate risk alerts, recommendations, and actionable insights for flood preparedness.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">

        {% if insights.risk_alerts %}
        <div class="insights-section">
            <h3><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Risk Alerts</h3>
            <div class="alerts-container">
                {% for alert in insights.risk_alerts %}
                <div class="alert-card alert-{{ alert.severity }}">
                    <div class="alert-header">{% if alert.type == 'warning' %}<i class="fas fa-exclamation-triangle"></i>{% else %}<i class="fas fa-info-circle"></i>{% endif %} {{ alert.title }}</div>
                    <div class="alert-message">{{ alert.message }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if insights.forecast_analysis %}
        <div class="insights-section">
            <h3><i class="fas fa-chart-line" style="color: var(--secondary-blue);"></i> Forecast Analysis</h3>
            <div class="analysis-grid">
                {% for analysis in insights.forecast_analysis %}
                <div class="analysis-card impact-{{ analysis.impact }}">
                    <div class="analysis-title">{{ analysis.title }}</div>
                    <div class="analysis-content">{{ analysis.analysis }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if insights.recommendations %}
        <div class="insights-section">
            <h3><i class="fas fa-lightbulb" style="color: #10b981;"></i> Recommended Actions</h3>
            <div class="recommendations-list">
                {% for rec in insights.recommendations %}
                <div class="recommendation-item">
                    <span class="priority-badge {{ rec.priority }}">{{ rec.priority }}</span>
                    <div class="recommendation-content">
                        <div class="recommendation-action">{{ rec.action }}</div>
                        <div class="recommendation-reason">{{ rec.reason }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if insights.trends %}
        <div class="insights-section">
            <h3><i class="fas fa-history" style="color: #8b5cf6;"></i> Historical Context</h3>
            <div class="trends-container">
                {% for trend in insights.trends %}
                <div class="trend-card">
                    <div class="trend-title">{{ trend.title }}</div>
                    <div class="trend-analysis">{{ trend.analysis }}</div>
                    {% if trend.recommendation %}<div class="trend-recommendation">{{ trend.recommendation }}</div>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    <!-- Rainfall and Tide Trends -->
    <div class="card collapsible" id="trends">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-water"></i> Rainfall & Tide Trends
                <span class="status-badge badge-historical">Historical</span>
                <span class="help-icon">?
                    <span class="help-tooltip">Visual representation of rainfall (Open-Meteo, Silay City, hourly) and tide levels (WorldTides, Cebu City, 3-hourly) changes over time. Use time range controls to analyze patterns from 24 hours to all available data. Export as PDF for reports.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">
        
        <div class="export-buttons">
            <a href="{% url 'export_trends' %}?type=pdf&time_range=24h" id="export-trends-pdf" class="export-btn pdf">
                <i class="fas fa-file-pdf"></i> Export PDF
            </a>
        </div>
        
        <div class="time-range-selector">
            <label style="font-weight: 600; font-size: 13px;">Time Range:</label>
            <div class="range-buttons">
                <button data-time-range="24h" class="time-range-btn {% if time_range == '24h' or not time_range %}btn-primary{% endif %}">24 Hours</button>
                <button data-time-range="7d" class="time-range-btn {% if time_range == '7d' %}btn-primary{% endif %}">7 Days</button>
                <button data-time-range="30d" class="time-range-btn {% if time_range == '30d' %}btn-primary{% endif %}">30 Days</button>
                <button data-time-range="90d" class="time-range-btn {% if time_range == '90d' %}btn-primary{% endif %}">90 Days</button>
                <button data-time-range="all" class="time-range-btn {% if time_range == 'all' %}btn-primary{% endif %}">All Time</button>
            </div>
            
            <div class="custom-date-picker">
                <label style="font-size: 12px; color: var(--text-muted);">Custom Range:</label>
                <input type="date" id="start-date" {% if min_date %}min="{{ min_date }}"{% endif %} {% if max_date %}max="{{ max_date }}"{% endif %}>
                <span style="font-size: 12px; color: var(--text-muted);">to</span>
                <input type="date" id="end-date" {% if min_date %}min="{{ min_date }}"{% endif %} {% if max_date %}max="{{ max_date }}"{% endif %}>
                <button id="apply-custom-range" class="btn-apply">Apply</button>
                <button id="reset-custom-range" class="btn-reset">Reset</button>
            </div>
            
            <div id="range-label">Showing data for: <strong>{{ range_label }}</strong></div>
        </div>
        
        <div class="toggle-switch" style="margin-bottom: 16px;">
            <input type="checkbox" id="toggleTrends" onchange="toggleView('trends')">
            <label for="toggleTrends">Show Table View</label>
        </div>
        
        <!-- Chart View -->
        <div id="trendsChart">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Rainfall Trend</h3>
                    <canvas id="rainfallTrendChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Tide Level Trend</h3>
                    <canvas id="tideTrendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Table View -->
        <div id="trendsTable" class="hidden">
            <table>
                <thead>
                    <tr><th>Timestamp</th><th>Rainfall (mm)</th><th>Tide Level (m)</th></tr>
                </thead>
                <tbody id="trendsTableBody"></tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- Flood Records Analysis -->
    <div class="card collapsible" id="analysis">
        <div class="card-header" onclick="toggleSection(this)">
            <h2>
                <i class="fas fa-chart-bar"></i> Flood Records Analysis
                <span class="status-badge badge-historical">Historical</span>
                <span class="help-icon">?
                    <span class="help-tooltip">Statistical analysis of past flood events including casualties, affected populations, property damage, and economic impact. Use tabs to switch between different metrics.</span>
                </span>
            </h2>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="card-content">
        
        <div class="flood-tabs">
            <button class="flood-tab active" onclick="switchTab('casualties-tab')"><i class="fas fa-user-injured"></i> Casualties</button>
            <button class="flood-tab" onclick="switchTab('affected-tab')"><i class="fas fa-users"></i> Affected Individuals</button>
            <button class="flood-tab" onclick="switchTab('houses-tab')"><i class="fas fa-home"></i> Houses Damaged</button>
            <button class="flood-tab" onclick="switchTab('damage-tab')"><i class="fas fa-dollar-sign"></i> Property Damage</button>
        </div>

        <div class="flood-tab-content active" id="casualties-tab">
            <div class="graph-section">
                <div class="toggle-switch">
                    <input type="checkbox" id="toggleCasualties" onchange="toggleView('casualties')">
                    <label for="toggleCasualties">Show Table View</label>
                </div>
                <div id="casualtiesChart-container">
                    <canvas id="casualtiesChart"></canvas>
                    <div class="chart-insight" id="casualties-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Analyzing casualties data...</span>
                    </div>
                </div>
                <table id="casualtiesTable" class="hidden">
                    <thead><tr><th>Date</th><th>Dead</th><th>Injured</th><th>Missing</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>{{ record.casualties_dead }}</td><td>{{ record.casualties_injured }}</td><td>{{ record.casualties_missing }}</td></tr>{% empty %}<tr><td colspan="4">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="flood-tab-content" id="affected-tab">
            <div class="graph-section">
                <div class="toggle-switch">
                    <input type="checkbox" id="toggleAffected" onchange="toggleView('affected')">
                    <label for="toggleAffected">Show Table View</label>
                </div>
                <div id="affectedChart-container">
                    <canvas id="affectedChart"></canvas>
                    <div class="chart-insight" id="affected-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Analyzing affected population data...</span>
                    </div>
                </div>
                <table id="affectedTable" class="hidden">
                    <thead><tr><th>Date</th><th>Persons</th><th>Families</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>{{ record.affected_persons }}</td><td>{{ record.affected_families }}</td></tr>{% empty %}<tr><td colspan="3">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="flood-tab-content" id="houses-tab">
            <div class="graph-section">
                <div class="toggle-switch">
                    <input type="checkbox" id="toggleHouses" onchange="toggleView('houses')">
                    <label for="toggleHouses">Show Table View</label>
                </div>
                <div id="housesChart-container">
                    <canvas id="housesChart"></canvas>
                    <div class="chart-insight" id="houses-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Analyzing housing damage data...</span>
                    </div>
                </div>
                <table id="housesTable" class="hidden">
                    <thead><tr><th>Date</th><th>Partially</th><th>Totally</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>{{ record.houses_damaged_partially }}</td><td>{{ record.houses_damaged_totally }}</td></tr>{% empty %}<tr><td colspan="3">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="flood-tab-content" id="damage-tab">
            <div class="graph-section">
                <div class="toggle-switch">
                    <input type="checkbox" id="toggleDamage" onchange="toggleView('damage')">
                    <label for="toggleDamage">Show Table View</label>
                </div>
                <div id="damageChart-container">
                    <canvas id="damageChart"></canvas>
                    <div class="chart-insight" id="damage-insight">
                        <i class="fas fa-lightbulb"></i>
                        <span>Analyzing property damage data...</span>
                    </div>
                </div>
                <table id="damageTable" class="hidden">
                    <thead><tr><th>Date</th><th>Infrastructure</th><th>Agriculture</th><th>Institutions</th><th>Private</th><th>Total</th></tr></thead>
                    <tbody>
                        {% for record in flood_records %}<tr><td>{{ record.date|date:"Y-m-d" }}</td><td>₱{{ record.damage_infrastructure_php|floatformat:0 }}</td><td>₱{{ record.damage_agriculture_php|floatformat:0 }}</td><td>₱{{ record.damage_institutions_php|floatformat:0 }}</td><td>₱{{ record.damage_private_commercial_php|floatformat:0 }}</td><td>₱{{ record.damage_total_php|floatformat:0 }}</td></tr>{% empty %}<tr><td colspan="6">No records</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <!-- Flood Records -->
    <div class="card flood-records-section" id="flood-records">
        <div class="flood-records-header">
            <div>
                <h2 class="flood-records-title">
                    <i class="fas fa-list"></i> Flood Records
                </h2>
                <p class="flood-records-subtitle">Comprehensive historical flood event database</p>
            </div>
            <div class="records-count-badge">
                <i class="fas fa-database"></i>
                <span>{{ flood_records|length }}</span> Records
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="flood-records-filter">
            <div class="filter-header">
                <i class="fas fa-filter"></i> Filter Records by Year
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filter-start-year">From Year:</label>
                    <select id="filter-start-year" class="year-select">
                        <option value="">-- All Years --</option>
                        {% for year in available_years %}
                        <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-end-year">To Year:</label>
                    <select id="filter-end-year" class="year-select">
                        <option value="">-- All Years --</option>
                        {% for year in available_years %}
                        <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-actions">
                    <button onclick="applyFloodRecordFilter()" class="filter-apply-btn">
                        <i class="fas fa-check"></i> Apply Filter
                    </button>
                    <button onclick="resetFloodRecordFilter()" class="filter-reset-btn">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        
        <div class="export-buttons records-export">
            <a href="{% url 'export_flood_records' %}?type=pdf" class="export-btn pdf" id="export-pdf-btn">
                <i class="fas fa-file-pdf"></i> Export PDF
            </a>
        </div>
        
        <div class="flood-records-table-container">
            <table class="flood-records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Event</th>
                        <th>Barangays</th>
                        <th>Dead</th>
                        <th>Injured</th>
                        <th>Missing</th>
                        <th>Affected Persons</th>
                        <th>Affected Families</th>
                        <th>Houses (Partial/Total)</th>
                        <th>Infrastructure Damage</th>
                        <th>Agriculture Damage</th>
                        <th>Institutions Damage</th>
                        <th>Private/Commercial Damage</th>
                        <th>Total Damage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in flood_records %}
                    <tr>
                        <td>{{ record.date|date:"Y-m-d" }}</td>
                        <td>{{ record.event }}</td>
                        <td>{{ record.affected_barangays }}</td>
                        <td>{{ record.casualties_dead_fmt }}</td>
                        <td>{{ record.casualties_injured_fmt }}</td>
                        <td>{{ record.casualties_missing_fmt }}</td>
                        <td>{{ record.affected_persons_fmt }}</td>
                        <td>{{ record.affected_families_fmt }}</td>
                        <td>{{ record.houses_damaged_partially_fmt }}/{{ record.houses_damaged_totally_fmt }}</td>
                        <td>₱{{ record.damage_infrastructure_php_fmt }}</td>
                        <td>₱{{ record.damage_agriculture_php_fmt }}</td>
                        <td>₱{{ record.damage_institutions_php_fmt }}</td>
                        <td>₱{{ record.damage_private_commercial_php_fmt }}</td>
                        <td>₱{{ record.damage_total_php_fmt }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'flood_record_edit' record.id %}" class="btn btn-edit"><i class="fas fa-edit"></i></a>
                                <a href="{% url 'flood_record_delete' record.id %}" class="btn btn-delete"><i class="fas fa-trash"></i></a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="15">No flood records available</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Empty State for Filtered Results -->
        <div class="empty-state" id="flood-records-empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-filter"></i>
            </div>
            <div class="empty-state-title">No Flood Records Found</div>
            <div class="empty-state-text">
                No flood records match the selected year range. Try adjusting your filters or reset to view all records.
            </div>
        </div>

        <div class="add-record-container">
            <a href="{% url 'flood_record_form' %}" class="add-record-btn">
                <i class="fas fa-plus-circle"></i> Add New Flood Record
            </a>
        </div>
    </div>
</div>

<!-- Back to Top Button -->
<button id="back-to-top" class="back-to-top" title="Back to top">
    <i class="fas fa-chevron-up"></i>
</button>



<!-- Keyboard Shortcuts Hint -->
<div class="keyboard-hint" id="keyboard-hint">
    <strong>Keyboard Shortcuts:</strong><br>
    Press <kbd>1-6</kbd> to jump to sections | <kbd>?</kbd> to show/hide this help
</div>

<script src="{% static 'js/chart.js' %}"></script>
<script>
    let rainfallTrendChart, tideTrendChart;

    document.addEventListener('DOMContentLoaded', function() {
        // Back to Top Button Functionality
        const backToTopButton = document.getElementById('back-to-top');
        
        console.log('Back to Top Button:', backToTopButton);
        
        if (backToTopButton) {
            console.log('Button found! Setting up event listeners...');
            
            // Show/hide button based on scroll position
            function toggleBackToTop() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                console.log('Scroll position:', scrollTop);
                if (scrollTop > 300) {
                    backToTopButton.classList.add('show');
                    console.log('Button should be visible');
                } else {
                    backToTopButton.classList.remove('show');
                    console.log('Button should be hidden');
                }
            }
            
            // Check on scroll
            window.addEventListener('scroll', toggleBackToTop);
            
            // Smooth scroll to top when clicked
            backToTopButton.addEventListener('click', function(e) {
                console.log('Button clicked!');
                e.preventDefault();
                e.stopPropagation();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // Initial check
            toggleBackToTop();
        } else {
            console.error('Back to top button not found in DOM!');
        }
        
        // Smooth scroll to flood records if hash is present
        if (window.location.hash === '#flood-records') {
            setTimeout(() => {
                const element = document.getElementById('flood-records');
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        // Initialize rainfall trend chart with year-over-year comparison support
        const ctxRainfallTrend = document.getElementById('rainfallTrendChart').getContext('2d');

        rainfallTrendChart = new Chart(ctxRainfallTrend, {
            type: 'line',
            data: {
                labels: {{ rainfall_timestamps|safe }},
                datasets: [{
                    label: 'Rainfall (mm)',
                    data: {{ rainfall_values|safe }},
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(59, 130, 246, 1)',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: 'bold' },
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        padding: 12,
                        displayColors: true,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' mm';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            font: { size: 11 },
                            padding: 8,
                            callback: function(value) {
                                return value + ' mm';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: { size: 11 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });

        // Initialize tide trend chart with year-over-year comparison support
        const ctxTideTrend = document.getElementById('tideTrendChart').getContext('2d');

        tideTrendChart = new Chart(ctxTideTrend, {
            type: 'line',
            data: {
                labels: {{ tide_timestamps|safe }},
                datasets: [{
                    label: 'Tide Level (m)',
                    data: {{ tide_values|safe }},
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(16, 185, 129, 1)',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: 'rgba(16, 185, 129, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: 'bold' },
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        padding: 12,
                        displayColors: true,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(3) + ' m';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            font: { size: 11 },
                            padding: 8,
                            callback: function(value) {
                                return value.toFixed(2) + ' m';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: { size: 11 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });

        // Time range buttons
        document.querySelectorAll('.time-range-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const timeRange = this.getAttribute('data-time-range');
                
                // Remove active class from all buttons
                document.querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                });
                
                // Add active class to clicked button
                this.classList.add('btn-primary');
                
                updateTimeRange(timeRange);
            });
        });

        document.getElementById('apply-custom-range').addEventListener('click', applyCustomDateRange);
        document.getElementById('reset-custom-range').addEventListener('click', resetCustomDateRange);
        updateTrendsTable({{ rainfall_timestamps|safe }}, {{ rainfall_values|safe }}, {{ tide_values|safe }});
    });

    function updateTimeRange(timeRange) {
        document.getElementById('range-label').innerHTML = 'Loading...';

        // Update export button links with current time range
        updateExportLinks({ time_range: timeRange });

        fetch(`/monitoring/api/trends/?time_range=${timeRange}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('range-label').innerHTML = `Showing data for: <strong>${data.range_label}</strong>`;
                
                // Update rainfall chart with year-over-year datasets
                if (data.rainfall_datasets && data.rainfall_datasets.length > 0) {
                    updateChartWithYearlyData(rainfallTrendChart, data.rainfall_datasets, 'mm');
                } else {
                    // Fallback to old format (single dataset)
                    rainfallTrendChart.data.labels = data.rainfall_timestamps || [];
                    rainfallTrendChart.data.datasets[0].data = data.rainfall_values || [];
                    rainfallTrendChart.update();
                }
                
                // Update tide chart with year-over-year datasets
                if (data.tide_datasets && data.tide_datasets.length > 0) {
                    updateChartWithYearlyData(tideTrendChart, data.tide_datasets, 'm');
                } else {
                    // Fallback to old format (single dataset)
                    tideTrendChart.data.labels = data.tide_timestamps || [];
                    tideTrendChart.data.datasets[0].data = data.tide_values || [];
                    tideTrendChart.update();
                }
                
                // Update the table view
                updateTrendsTableWithYears(data);
            });
    }

    function applyCustomDateRange() {
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        if (!startDate || !endDate) { 
            alert('Please select both start and end dates'); 
            return; 
        }
        
        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);
        
        // Get min and max dates from input attributes
        const minDate = startDateInput.min ? new Date(startDateInput.min) : null;
        const maxDate = startDateInput.max ? new Date(startDateInput.max) : null;
        
        // Validate against min date (earliest data)
        if (minDate && startDateObj < minDate) {
            alert(`Start date cannot be before ${minDate.toLocaleDateString()}. Please select a date within the available data range.`);
            return;
        }
        
        if (minDate && endDateObj < minDate) {
            alert(`End date cannot be before ${minDate.toLocaleDateString()}. Please select a date within the available data range.`);
            return;
        }
        
        // Validate against max date (today)
        if (maxDate && startDateObj > maxDate) {
            alert(`Start date cannot be after ${maxDate.toLocaleDateString()}. Please select a date on or before today.`);
            return;
        }
        
        if (maxDate && endDateObj > maxDate) {
            alert(`End date cannot be after ${maxDate.toLocaleDateString()}. Please select a date on or before today.`);
            return;
        }
        
        if (endDateObj < startDateObj) { 
            alert('End date must be after start date'); 
            return; 
        }
        
        // Remove active class from all time range buttons when custom range is applied
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
        });

        // Update export button links with custom date range
        updateExportLinks({ start_date: startDate, end_date: endDate });

        document.getElementById('range-label').innerHTML = 'Loading...';
        fetch(`/monitoring/api/trends/?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('range-label').innerHTML = `Showing data for: <strong>${data.range_label}</strong>`;
                
                // Update rainfall chart with year-over-year datasets
                if (data.rainfall_datasets && data.rainfall_datasets.length > 0) {
                    updateChartWithYearlyData(rainfallTrendChart, data.rainfall_datasets, 'mm');
                } else {
                    // Fallback to old format (single dataset)
                    rainfallTrendChart.data.labels = data.rainfall_timestamps || [];
                    rainfallTrendChart.data.datasets[0].data = data.rainfall_values || [];
                    rainfallTrendChart.update();
                }
                
                // Update tide chart with year-over-year datasets
                if (data.tide_datasets && data.tide_datasets.length > 0) {
                    updateChartWithYearlyData(tideTrendChart, data.tide_datasets, 'm');
                } else {
                    // Fallback to old format (single dataset)
                    tideTrendChart.data.labels = data.tide_timestamps || [];
                    tideTrendChart.data.datasets[0].data = data.tide_values || [];
                    tideTrendChart.update();
                }
                
                // Update the table view
                updateTrendsTableWithYears(data);
            })
            .catch(error => {
                alert('Error loading data. Please try again.');
                document.getElementById('range-label').innerHTML = 'Error loading data';
            });
    }

    function updateExportLinks(params) {
        const baseUrlPDF = "{% url 'export_trends' %}?type=pdf";
        
        let pdfUrl = baseUrlPDF;
        
        if (params.time_range) {
            pdfUrl += `&time_range=${params.time_range}`;
        } else if (params.start_date && params.end_date) {
            pdfUrl += `&start_date=${params.start_date}&end_date=${params.end_date}`;
        }
        
        document.getElementById('export-trends-pdf').href = pdfUrl;
    }

    function resetCustomDateRange() {
        // Clear the date inputs
        document.getElementById('start-date').value = '';
        document.getElementById('end-date').value = '';
        
        // Reset to default time range (24h)
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
        });
        document.querySelector('[data-time-range="24h"]').classList.add('btn-primary');
        
        updateTimeRange('24h');
    }

    // Helper function to update charts with year-over-year data
    function updateChartWithYearlyData(chart, datasets, unit) {
        // Clear existing datasets
        chart.data.datasets = [];
        
        // Find all unique timestamps across all years
        let allTimestamps = [];
        datasets.forEach(dataset => {
            allTimestamps = allTimestamps.concat(dataset.timestamps);
        });
        allTimestamps = [...new Set(allTimestamps)].sort();
        
        // Update labels
        chart.data.labels = allTimestamps;
        
        // Add a dataset for each year
        datasets.forEach(yearDataset => {
            // Create a map for quick lookup
            const timestampValueMap = {};
            yearDataset.timestamps.forEach((ts, idx) => {
                timestampValueMap[ts] = yearDataset.data[idx];
            });
            
            // Fill data array with values aligned to all timestamps
            const alignedData = allTimestamps.map(ts => timestampValueMap[ts] || null);
            
            chart.data.datasets.push({
                label: yearDataset.label,
                data: alignedData,
                backgroundColor: yearDataset.backgroundColor,
                borderColor: yearDataset.borderColor,
                borderWidth: 3,
                tension: 0.4,
                fill: false,  // Don't fill for year comparison (makes it clearer)
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: yearDataset.borderColor,
                pointBorderWidth: 2,
                pointHoverBackgroundColor: yearDataset.borderColor,
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 3,
                spanGaps: true  // Connect lines even if there are null values
            });
        });
        
        // Update tooltip to show year in the label
        chart.options.plugins.tooltip.callbacks = {
            label: function(context) {
                const year = context.dataset.label;
                const value = context.parsed.y;
                if (value === null) return null;
                return year + ': ' + value.toFixed(unit === 'm' ? 3 : 2) + ' ' + unit;
            }
        };
        
        chart.update();
    }

    // Helper function to update table with year-over-year data
    function updateTrendsTableWithYears(data) {
        const tableBody = document.getElementById('trendsTableBody');
        tableBody.innerHTML = '';
        
        // Check if we have year-based datasets
        if (data.rainfall_datasets && data.rainfall_datasets.length > 0) {
            // Collect all unique timestamps
            let allTimestamps = new Set();
            data.rainfall_datasets.forEach(ds => {
                ds.timestamps.forEach(ts => allTimestamps.add(ts));
            });
            data.tide_datasets.forEach(ds => {
                ds.timestamps.forEach(ts => allTimestamps.add(ts));
            });
            
            allTimestamps = Array.from(allTimestamps).sort().reverse(); // Most recent first
            
            if (allTimestamps.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">No data available</td></tr>';
                return;
            }
            
            // Create maps for quick lookup
            const rainfallMap = {};
            data.rainfall_datasets.forEach(ds => {
                ds.timestamps.forEach((ts, idx) => {
                    if (!rainfallMap[ts]) rainfallMap[ts] = {};
                    rainfallMap[ts][ds.label] = ds.data[idx];
                });
            });
            
            const tideMap = {};
            data.tide_datasets.forEach(ds => {
                ds.timestamps.forEach((ts, idx) => {
                    if (!tideMap[ts]) tideMap[ts] = {};
                    tideMap[ts][ds.label] = ds.data[idx];
                });
            });
            
            // Get all years
            const years = data.years || [];
            
            // Build table rows
            allTimestamps.forEach(ts => {
                const row = document.createElement('tr');
                let rainfallCell = '';
                let tideCell = '';
                
                // Show values for each year
                years.forEach(year => {
                    const rainfall = rainfallMap[ts] && rainfallMap[ts][year] !== undefined ? 
                        rainfallMap[ts][year].toFixed(2) + ' mm' : '-';
                    const tide = tideMap[ts] && tideMap[ts][year] !== undefined ? 
                        tideMap[ts][year].toFixed(3) + ' m' : '-';
                    
                    rainfallCell += `<span class="year-${year}">${year}: ${rainfall}</span><br>`;
                    tideCell += `<span class="year-${year}">${year}: ${tide}</span><br>`;
                });
                
                row.innerHTML = `<td>${ts}</td><td>${rainfallCell}</td><td>${tideCell}</td>`;
                tableBody.appendChild(row);
            });
        } else {
            // Fallback to old format
            updateTrendsTable(
                data.rainfall_timestamps || [],
                data.rainfall_values || [],
                data.tide_values || []
            );
        }
    }

    function updateTrendsTable(timestamps, rainfallValues, tideValues) {
        const tableBody = document.getElementById('trendsTableBody');
        tableBody.innerHTML = '';
        if (timestamps.length === 0) { tableBody.innerHTML = '<tr><td colspan="3">No data available</td></tr>'; return; }
        // Reverse loop to show most recent records at the top
        for (let i = timestamps.length - 1; i >= 0; i--) {
            const row = document.createElement('tr');
            // Show 0 instead of N/A for zero values, but N/A for undefined/null
            const rainfallDisplay = rainfallValues[i] !== undefined && rainfallValues[i] !== null ? rainfallValues[i] : 'N/A';
            const tideDisplay = tideValues[i] !== undefined && tideValues[i] !== null ? tideValues[i] : 'N/A';
            row.innerHTML = `<td>${timestamps[i]}</td><td>${rainfallDisplay}</td><td>${tideDisplay}</td>`;
            tableBody.appendChild(row);
        }
    }

    function toggleView(type) {
        const chartContainer = document.getElementById(`${type}Chart-container`) || document.getElementById(`${type}Chart`);
        const table = document.getElementById(`${type}Table`);
        const isChecked = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
        if (isChecked) { chartContainer.classList.add('hidden'); table.classList.remove('hidden'); }
        else { chartContainer.classList.remove('hidden'); table.classList.add('hidden'); }
    }

    function toggleSection(headerElement) {
        const card = headerElement.closest('.card');
        const content = card.querySelector('.card-content');
        const icon = headerElement.querySelector('.collapse-icon');
        
        content.classList.toggle('collapsed');
        icon.classList.toggle('collapsed');
    }

    function switchTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('.flood-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.flood-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabId).classList.add('active');
        
        // Add active class to clicked tab
        event.target.classList.add('active');
    }

    // Smooth scroll for quick navigation
    document.querySelectorAll('.quick-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // Expand section if collapsed
                const content = targetElement.querySelector('.card-content');
                if (content && content.classList.contains('collapsed')) {
                    const header = targetElement.querySelector('.card-header');
                    if (header) toggleSection(header);
                }
                
                // Smooth scroll to element
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Add highlight effect
                targetElement.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.3)';
                setTimeout(() => {
                    targetElement.style.boxShadow = '';
                }, 2000);
            }
        });
    });

    // Initialize all charts
    const ctxCasualties = document.getElementById('casualtiesChart').getContext('2d');
    new Chart(ctxCasualties, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Dead', 
                    data: {{ casualties_data.dead|safe }}, 
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(239, 68, 68, 1)'
                },
                { 
                    label: 'Injured', 
                    data: {{ casualties_data.injured|safe }}, 
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(59, 130, 246, 1)'
                },
                { 
                    label: 'Missing', 
                    data: {{ casualties_data.missing|safe }}, 
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(245, 158, 11, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' person(s)';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxAffected = document.getElementById('affectedChart').getContext('2d');
    new Chart(ctxAffected, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Persons', 
                    data: {{ affected_data.persons|safe }}, 
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(16, 185, 129, 1)'
                },
                { 
                    label: 'Families', 
                    data: {{ affected_data.families|safe }}, 
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(139, 92, 246, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxHouses = document.getElementById('housesChart').getContext('2d');
    new Chart(ctxHouses, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Partially Damaged', 
                    data: {{ houses_data.partially|safe }}, 
                    backgroundColor: 'rgba(251, 146, 60, 0.8)',
                    borderColor: 'rgba(251, 146, 60, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(251, 146, 60, 1)'
                },
                { 
                    label: 'Totally Damaged', 
                    data: {{ houses_data.totally|safe }}, 
                    backgroundColor: 'rgba(107, 114, 128, 0.8)',
                    borderColor: 'rgba(107, 114, 128, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(107, 114, 128, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' house(s)';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxDamage = document.getElementById('damageChart').getContext('2d');
    new Chart(ctxDamage, {
        type: 'bar',
        data: {
            labels: {{ graph_dates|safe }},
            datasets: [
                { 
                    label: 'Infrastructure', 
                    data: {{ damage_data.infrastructure|safe }}, 
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(239, 68, 68, 1)'
                },
                { 
                    label: 'Agriculture', 
                    data: {{ damage_data.agriculture|safe }}, 
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(34, 197, 94, 1)'
                },
                { 
                    label: 'Institutions', 
                    data: {{ damage_data.institutions|safe }}, 
                    backgroundColor: 'rgba(245, 158, 11, 0.8)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(245, 158, 11, 1)'
                },
                { 
                    label: 'Private Commercial', 
                    data: {{ damage_data.private_commercial|safe }}, 
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: 'rgba(59, 130, 246, 1)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ₱' + context.parsed.y.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return '₱' + (value / 1000).toLocaleString() + 'K';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxTempForecast = document.getElementById('temperatureForecastChart').getContext('2d');
    const gradientMaxTemp = ctxTempForecast.createLinearGradient(0, 0, 0, 400);
    gradientMaxTemp.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
    gradientMaxTemp.addColorStop(1, 'rgba(239, 68, 68, 0.01)');
    
    const gradientMinTemp = ctxTempForecast.createLinearGradient(0, 0, 0, 400);
    gradientMinTemp.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
    gradientMinTemp.addColorStop(1, 'rgba(59, 130, 246, 0.01)');

    new Chart(ctxTempForecast, {
        type: 'line',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [
                { 
                    label: 'Max Temp', 
                    data: {{ forecast_temp_max|safe }}, 
                    borderColor: 'rgba(239, 68, 68, 1)', 
                    backgroundColor: gradientMaxTemp,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(239, 68, 68, 1)',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: 'rgba(239, 68, 68, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                },
                { 
                    label: 'Min Temp', 
                    data: {{ forecast_temp_min|safe }}, 
                    borderColor: 'rgba(59, 130, 246, 1)', 
                    backgroundColor: gradientMinTemp,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: 'rgba(59, 130, 246, 1)',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '°C';
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + '°C';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxPrecip = document.getElementById('precipitationForecastChart').getContext('2d');
    new Chart(ctxPrecip, {
        type: 'bar',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [{ 
                label: 'Precipitation', 
                data: {{ forecast_precipitation|safe }}, 
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 2,
                borderRadius: 6,
                hoverBackgroundColor: 'rgba(16, 185, 129, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' mm';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + ' mm';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxHumidity = document.getElementById('humidityForecastChart').getContext('2d');
    const gradientHumidity = ctxHumidity.createLinearGradient(0, 0, 0, 400);
    gradientHumidity.addColorStop(0, 'rgba(139, 92, 246, 0.3)');
    gradientHumidity.addColorStop(1, 'rgba(139, 92, 246, 0.01)');

    new Chart(ctxHumidity, {
        type: 'line',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [{ 
                label: 'Humidity', 
                data: {{ forecast_humidity|safe }}, 
                borderColor: 'rgba(139, 92, 246, 1)', 
                backgroundColor: gradientHumidity,
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: 'rgba(139, 92, 246, 1)',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: 'rgba(139, 92, 246, 1)',
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(139, 92, 246, 1)',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    const ctxWind = document.getElementById('windSpeedForecastChart').getContext('2d');
    const gradientWind = ctxWind.createLinearGradient(0, 0, 0, 400);
    gradientWind.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
    gradientWind.addColorStop(1, 'rgba(245, 158, 11, 0.01)');

    new Chart(ctxWind, {
        type: 'line',
        data: {
            labels: {{ forecast_dates|safe }},
            datasets: [{ 
                label: 'Wind Speed', 
                data: {{ forecast_wind_speed|safe }}, 
                borderColor: 'rgba(245, 158, 11, 1)', 
                backgroundColor: gradientWind,
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: 'rgba(245, 158, 11, 1)',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: 'rgba(245, 158, 11, 1)',
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 2,
                    padding: 12,
                    displayColors: true,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + ' km/h';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + ' km/h';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Generate data-driven weather insights
    function generateWeatherInsights() {
        // Get forecast data from Django template
        const tempMax = {{ forecast_temp_max|safe }};
        const tempMin = {{ forecast_temp_min|safe }};
        const precipitation = {{ forecast_precipitation|safe }};
        const humidity = {{ forecast_humidity|safe }};
        const windSpeed = {{ forecast_wind_speed|safe }};
        const dates = {{ forecast_dates|safe }};

        // Temperature Insights
        const avgTempMax = (tempMax.reduce((a, b) => a + b, 0) / tempMax.length).toFixed(1);
        const avgTempMin = (tempMin.reduce((a, b) => a + b, 0) / tempMin.length).toFixed(1);
        const peakTemp = Math.max(...tempMax);
        const lowestTemp = Math.min(...tempMin);
        const tempRange = (peakTemp - lowestTemp).toFixed(1);
        
        let tempInsight = `Average high: ${avgTempMax}°C, low: ${avgTempMin}°C. `;
        if (peakTemp > 34) {
            tempInsight += `Peak of ${peakTemp}°C expected - heat may increase evaporation rates.`;
        } else if (lowestTemp < 22) {
            tempInsight += `Lowest temperature ${lowestTemp}°C - cooler conditions expected.`;
        } else {
            tempInsight += `Temperature range of ${tempRange}°C indicates moderate conditions.`;
        }
        
        // Precipitation Insights
        const totalRain = precipitation.reduce((a, b) => a + b, 0).toFixed(1);
        const heavyRainDays = precipitation.filter(p => p > 50).length;
        const maxRain = Math.max(...precipitation);
        const maxRainDay = precipitation.indexOf(maxRain);
        
        let precipInsight = `Total expected: ${totalRain}mm over 7 days. `;
        if (heavyRainDays > 0) {
            precipInsight += `⚠️ ${heavyRainDays} day(s) with heavy rain (>50mm). Peak: ${maxRain}mm on ${dates[maxRainDay]} - High flood risk.`;
        } else if (totalRain > 100) {
            precipInsight += `Moderate rainfall expected - monitor drainage systems.`;
        } else if (totalRain < 30) {
            precipInsight += `Low rainfall expected - minimal flood risk from precipitation.`;
        } else {
            precipInsight += `Moderate rainfall levels - normal monitoring advised.`;
        }
        
        // Humidity Insights
        const avgHumidity = (humidity.reduce((a, b) => a + b, 0) / humidity.length).toFixed(1);
        const highHumidityDays = humidity.filter(h => h > 80).length;
        const maxHumidity = Math.max(...humidity);
        
        let humidityInsight = `Average: ${avgHumidity}%. `;
        if (highHumidityDays >= 4) {
            humidityInsight += `${highHumidityDays} days with high humidity (>80%) - saturated conditions may reduce soil absorption.`;
        } else if (maxHumidity > 85) {
            humidityInsight += `Peak humidity ${maxHumidity}% - near-saturation conditions expected.`;
        } else if (avgHumidity < 65) {
            humidityInsight += `Relatively dry conditions - better soil absorption capacity.`;
        } else {
            humidityInsight += `Moderate humidity levels - normal atmospheric conditions.`;
        }
        
        // Wind Speed Insights
        const avgWind = (windSpeed.reduce((a, b) => a + b, 0) / windSpeed.length).toFixed(1);
        const maxWind = Math.max(...windSpeed);
        const maxWindDay = windSpeed.indexOf(maxWind);
        const stormDays = windSpeed.filter(w => w > 40).length;
        
        let windInsight = `Average: ${avgWind} km/h. `;
        if (stormDays > 0) {
            windInsight += `⚠️ ${stormDays} day(s) with strong winds (>40 km/h). Peak: ${maxWind} km/h on ${dates[maxWindDay]} - Storm warning.`;
        } else if (maxWind > 35) {
            windInsight += `Peak wind ${maxWind} km/h on ${dates[maxWindDay]} - moderate wind conditions.`;
        } else if (avgWind < 15) {
            windInsight += `Light winds expected - calm weather conditions.`;
        } else {
            windInsight += `Moderate wind speeds - normal conditions.`;
        }
        
        // Update insight divs
        document.getElementById('temp-insight').querySelector('span').textContent = tempInsight;
        document.getElementById('precip-insight').querySelector('span').textContent = precipInsight;
        document.getElementById('humidity-insight').querySelector('span').textContent = humidityInsight;
        document.getElementById('wind-insight').querySelector('span').textContent = windInsight;
    }

    // Call the function after DOM is ready
    generateWeatherInsights();

    // Generate flood records analysis insights
    function generateFloodAnalysisInsights() {
        // Get data from Django template with safe defaults
        const dates = {{ graph_dates|safe|default:"[]" }};
        const deadData = {{ casualties_data.dead|safe|default:"[]" }};
        const injuredData = {{ casualties_data.injured|safe|default:"[]" }};
        const missingData = {{ casualties_data.missing|safe|default:"[]" }};
        const personsData = {{ affected_data.persons|safe|default:"[]" }};
        const familiesData = {{ affected_data.families|safe|default:"[]" }};
        const partiallyData = {{ houses_data.partially|safe|default:"[]" }};
        const totallyData = {{ houses_data.totally|safe|default:"[]" }};
        const infraData = {{ damage_data.infrastructure|safe|default:"[]" }};
        const agriData = {{ damage_data.agriculture|safe|default:"[]" }};
        const instData = {{ damage_data.institutions|safe|default:"[]" }};
        const privateData = {{ damage_data.private|safe|default:"[]" }};

        // Safety check - exit if no data
        if (!dates || dates.length === 0) {
            console.log('No flood records data available for analysis');
            return;
        }

        // Casualties Analysis
        const totalDead = deadData.reduce((a, b) => a + b, 0);
        const totalInjured = injuredData.reduce((a, b) => a + b, 0);
        const totalMissing = missingData.reduce((a, b) => a + b, 0);
        const totalCasualties = totalDead + totalInjured + totalMissing;
        const eventsWithCasualties = deadData.filter((v, i) => deadData[i] > 0 || injuredData[i] > 0 || missingData[i] > 0).length;
        const maxDeadIndex = deadData.indexOf(Math.max(...deadData));
        const maxDead = deadData[maxDeadIndex];

        let casualtiesInsight = `<strong>Total Records:</strong> ${dates.length} flood events analyzed. `;
        if (totalCasualties === 0) {
            casualtiesInsight += `✓ <strong>No casualties reported</strong> across all recorded events - excellent emergency response and preparedness.`;
        } else {
            casualtiesInsight += `<strong>${totalCasualties} total casualties</strong> (${totalDead} dead, ${totalInjured} injured, ${totalMissing} missing) across ${eventsWithCasualties} event(s). `;
            if (maxDead > 0) {
                casualtiesInsight += `⚠️ Most severe: <strong>${maxDead} death(s)</strong> on ${dates[maxDeadIndex]}. `;
            }
            if (totalDead > 5) {
                casualtiesInsight += `<span style="color: #ef4444;">Critical impact on human life - enhanced evacuation protocols recommended.</span>`;
            } else if (totalCasualties > 0) {
                casualtiesInsight += `Monitor high-risk areas and strengthen early warning systems.`;
            }
        }

        // Affected Individuals Analysis
        const totalPersons = personsData.reduce((a, b) => a + b, 0);
        const totalFamilies = familiesData.reduce((a, b) => a + b, 0);
        const avgPersonsPerEvent = (totalPersons / dates.length).toFixed(0);
        const avgFamiliesPerEvent = (totalFamilies / dates.length).toFixed(0);
        const maxPersonsIndex = personsData.indexOf(Math.max(...personsData));
        const maxPersons = personsData[maxPersonsIndex];

        let affectedInsight = `<strong>Total Impact:</strong> ${totalPersons.toLocaleString()} persons and ${totalFamilies.toLocaleString()} families affected. `;
        if (totalPersons === 0) {
            affectedInsight += `No affected population recorded - limited flood impact on residential areas.`;
        } else {
            affectedInsight += `<strong>Average per event:</strong> ${avgPersonsPerEvent} persons, ${avgFamiliesPerEvent} families. `;
            if (maxPersons > 0) {
                affectedInsight += `Largest impact: <strong>${maxPersons.toLocaleString()} persons</strong> on ${dates[maxPersonsIndex]}. `;
            }
            if (maxPersons > 1000) {
                affectedInsight += `<span style="color: #f97316;">⚠️ Major displacement event - evacuation center capacity critical.</span>`;
            } else if (maxPersons > 500) {
                affectedInsight += `Significant community impact - adequate relief supplies essential.`;
            } else {
                affectedInsight += `Localized impact - targeted assistance to affected barangays needed.`;
            }
        }

        // Houses Damaged Analysis
        const totalPartially = partiallyData.reduce((a, b) => a + b, 0);
        const totalTotally = totallyData.reduce((a, b) => a + b, 0);
        const totalHouses = totalPartially + totalTotally;
        const partiallyPercent = totalHouses > 0 ? ((totalPartially / totalHouses) * 100).toFixed(1) : 0;
        const totallyPercent = totalHouses > 0 ? ((totalTotally / totalHouses) * 100).toFixed(1) : 0;
        const maxTotallyIndex = totallyData.indexOf(Math.max(...totallyData));
        const maxTotally = totallyData[maxTotallyIndex];

        let housesInsight = `<strong>Total Housing Damage:</strong> ${totalHouses.toLocaleString()} houses (${totalPartially.toLocaleString()} partially, ${totalTotally.toLocaleString()} totally damaged). `;
        if (totalHouses === 0) {
            housesInsight += `No structural damage to residences recorded.`;
        } else {
            housesInsight += `<strong>Damage ratio:</strong> ${partiallyPercent}% partially damaged, ${totallyPercent}% totally destroyed. `;
            if (maxTotally > 0) {
                housesInsight += `Worst event: <strong>${maxTotally} houses totally destroyed</strong> on ${dates[maxTotallyIndex]}. `;
            }
            if (totalTotally > 100) {
                housesInsight += `<span style="color: #ef4444;">⚠️ Severe housing crisis - massive reconstruction needed. Priority: temporary shelters and housing assistance.</span>`;
            } else if (totalTotally > 50) {
                housesInsight += `<span style="color: #f97316;">Major reconstruction required - coordinate with housing agencies.</span>`;
            } else if (totalPartially > totalTotally) {
                housesInsight += `Majority repairable - focus on rehabilitation support and building materials assistance.`;
            } else {
                housesInsight += `Moderate impact - provide repair assistance to affected families.`;
            }
        }

        // Property Damage Analysis
        const totalInfra = infraData.reduce((a, b) => a + b, 0);
        const totalAgri = agriData.reduce((a, b) => a + b, 0);
        const totalInst = instData.reduce((a, b) => a + b, 0);
        const totalPrivate = privateData.reduce((a, b) => a + b, 0);
        const totalDamage = totalInfra + totalAgri + totalInst + totalPrivate;
        const maxDamageIndex = infraData.map((v, i) => v + agriData[i] + instData[i] + privateData[i]).indexOf(Math.max(...infraData.map((v, i) => v + agriData[i] + instData[i] + privateData[i])));
        const maxDamageValue = infraData[maxDamageIndex] + agriData[maxDamageIndex] + instData[maxDamageIndex] + privateData[maxDamageIndex];

        let damageInsight = `<strong>Total Economic Impact:</strong> ₱${(totalDamage / 1000000).toFixed(2)}M. `;
        if (totalDamage === 0) {
            damageInsight += `No economic damage recorded.`;
        } else {
            damageInsight += `<strong>Breakdown:</strong> Infrastructure ₱${(totalInfra / 1000000).toFixed(2)}M (${((totalInfra / totalDamage) * 100).toFixed(0)}%), Agriculture ₱${(totalAgri / 1000000).toFixed(2)}M (${((totalAgri / totalDamage) * 100).toFixed(0)}%), Institutions ₱${(totalInst / 1000000).toFixed(2)}M (${((totalInst / totalDamage) * 100).toFixed(0)}%), Private ₱${(totalPrivate / 1000000).toFixed(2)}M (${((totalPrivate / totalDamage) * 100).toFixed(0)}%). `;
            if (maxDamageValue > 0) {
                damageInsight += `Costliest event: <strong>₱${(maxDamageValue / 1000000).toFixed(2)}M</strong> on ${dates[maxDamageIndex]}. `;
            }
            
            // Identify primary damage sector
            const sectors = [
                { name: 'Infrastructure', value: totalInfra },
                { name: 'Agriculture', value: totalAgri },
                { name: 'Institutions', value: totalInst },
                { name: 'Private/Commercial', value: totalPrivate }
            ];
            const primarySector = sectors.reduce((max, sector) => sector.value > max.value ? sector : max);
            
            if (totalDamage > 50000000) {
                damageInsight += `<span style="color: #ef4444;">⚠️ Catastrophic economic impact. Primary sector affected: <strong>${primarySector.name}</strong>. Coordinate with national disaster relief and reconstruction funding.</span>`;
            } else if (totalDamage > 10000000) {
                damageInsight += `<span style="color: #f97316;">Significant economic burden. Primary sector: <strong>${primarySector.name}</strong>. Prioritize rehabilitation of critical infrastructure and livelihood support.</span>`;
            } else {
                damageInsight += `Moderate economic impact. Focus recovery efforts on <strong>${primarySector.name}</strong> sector.`;
            }
        }

        // Update insight elements
        const casualtiesInsightEl = document.getElementById('casualties-insight');
        const affectedInsightEl = document.getElementById('affected-insight');
        const housesInsightEl = document.getElementById('houses-insight');
        const damageInsightEl = document.getElementById('damage-insight');

        if (casualtiesInsightEl) {
            casualtiesInsightEl.querySelector('span').innerHTML = casualtiesInsight;
        }
        if (affectedInsightEl) {
            affectedInsightEl.querySelector('span').innerHTML = affectedInsight;
        }
        if (housesInsightEl) {
            housesInsightEl.querySelector('span').innerHTML = housesInsight;
        }
        if (damageInsightEl) {
            damageInsightEl.querySelector('span').innerHTML = damageInsight;
        }
    }

    // Call flood analysis insights after DOM is ready
    generateFloodAnalysisInsights();

    // Update metric card icons dynamically based on values
    function updateMetricIcons() {
        const metricItems = document.querySelectorAll('.metric-item');
        
        // Rainfall Icon (index 0)
        const rainfallValue = parseFloat(document.querySelector('[data-rainfall]').textContent);
        if (rainfallValue >= 50) {
            // Heavy rain - multiple large drops
            metricItems[0].classList.add('heavy-rain');
        } else if (rainfallValue >= 30) {
            // Moderate rain
            metricItems[0].classList.add('moderate-rain');
        } else {
            // Light rain - default
            metricItems[0].classList.add('light-rain');
        }
        
        // Temperature Icon (index 1)
        const tempValue = parseFloat(document.querySelector('[data-temperature]').textContent);
        if (tempValue >= 32) {
            // Hot - show sun
            metricItems[1].classList.add('hot-temp');
        } else if (tempValue <= 24) {
            // Cool - show cloud/rain
            metricItems[1].classList.add('cool-temp');
        } else {
            // Moderate - thermometer
            metricItems[1].classList.add('moderate-temp');
        }
        
        // Humidity Icon (index 2)
        const humidityValue = parseFloat(document.querySelector('.metric-item:nth-child(3) .metric-value').textContent);
        if (humidityValue >= 85) {
            // Very high humidity - large droplet
            metricItems[2].classList.add('high-humidity');
        } else if (humidityValue >= 70) {
            // Moderate humidity
            metricItems[2].classList.add('moderate-humidity');
        } else {
            // Low humidity
            metricItems[2].classList.add('low-humidity');
        }
        
        // Wind Speed Icon (index 3)
        const windValue = parseFloat(document.querySelector('.metric-item:nth-child(4) .metric-value').textContent);
        if (windValue >= 40) {
            // Strong wind - storm
            metricItems[3].classList.add('strong-wind');
        } else if (windValue >= 25) {
            // Moderate wind
            metricItems[3].classList.add('moderate-wind');
        } else {
            // Light wind
            metricItems[3].classList.add('light-wind');
        }
        
        // Tide Level Icon (index 4)
        const tideValue = parseFloat(document.querySelector('.metric-item:nth-child(5) .metric-value').textContent);
        if (tideValue >= 1.5) {
            // High tide - large waves
            metricItems[4].classList.add('high-tide');
        } else if (tideValue >= 1.0) {
            // Moderate tide
            metricItems[4].classList.add('moderate-tide');
        } else {
            // Low tide
            metricItems[4].classList.add('low-tide');
        }
    }

    // Call the function after DOM is ready
    updateMetricIcons();

    // Refresh countdown timer - 5 minute automatic refresh
    const refreshTimerElement = document.getElementById('refresh-timer');
    let refreshSeconds = 300; // 5 minutes = 300 seconds

    function updateRefreshTimer() {
        const minutes = Math.floor(refreshSeconds / 60);
        const seconds = refreshSeconds % 60;
        refreshTimerElement.textContent = `Refreshing in ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (refreshSeconds > 0) {
            refreshSeconds--;
        } else {
            // Reload page when countdown reaches 0
            window.location.reload();
        }
    }

    // Update countdown every second
    setInterval(updateRefreshTimer, 1000);
    updateRefreshTimer(); // Initial call

    // Store previous values for trend calculation (parse numbers only, removing units)
    let previousValues = {
        rainfall: parseFloat(document.querySelector('[data-rainfall]')?.textContent?.replace(/[^0-9.-]/g, '') || '0') || 0,
        temperature: parseFloat(document.querySelector('[data-temperature]')?.textContent?.replace(/[^0-9.-]/g, '') || '0') || 0,
        humidity: parseFloat(document.querySelector('[data-humidity]')?.textContent?.replace(/[^0-9.-]/g, '') || '0') || 0,
        wind: parseFloat(document.querySelector('[data-wind]')?.textContent?.replace(/[^0-9.-]/g, '') || '0') || 0,
        tide: parseFloat(document.querySelector('[data-tide]')?.textContent?.replace(/[^0-9.-]/g, '') || '0') || 0
    };

    // Function to update metric with trend
    function updateMetricTrend(metric, currentValue, previousValue, isIncreaseBad = true) {
        const trendElement = document.querySelector(`[data-trend-${metric}]`);
        if (!trendElement) return;

        const difference = currentValue - previousValue;
        const percentChange = previousValue !== 0 ? Math.abs((difference / previousValue) * 100) : 0;

        if (Math.abs(difference) < 0.01) {
            // No significant change
            trendElement.className = 'trend-indicator trend-neutral';
            trendElement.innerHTML = '<i class="fas fa-minus"></i> 0%';
            trendElement.style.display = 'inline-flex';
        } else if (difference > 0) {
            // Increasing
            trendElement.className = isIncreaseBad ? 'trend-indicator trend-up' : 'trend-indicator trend-down';
            trendElement.innerHTML = `<i class="fas fa-arrow-up"></i> ${percentChange.toFixed(1)}%`;
            trendElement.style.display = 'inline-flex';
        } else {
            // Decreasing
            trendElement.className = isIncreaseBad ? 'trend-indicator trend-down' : 'trend-indicator trend-up';
            trendElement.innerHTML = `<i class="fas fa-arrow-down"></i> ${percentChange.toFixed(1)}%`;
            trendElement.style.display = 'inline-flex';
        }
    }

    // Auto-refresh every 5 minutes
    setInterval(function() {
        fetch('{% url "fetch_data" %}')
            .then(response => response.json())
            .then(data => {
                // Get current values with validation to prevent NaN
                const currentRainfall = parseFloat(data.rainfall) || 0;
                const currentTemperature = parseFloat(data.temperature) || 0;
                const currentHumidity = parseFloat(data.humidity) || 0;
                const currentWind = parseFloat(data.wind_speed) || 0;
                const currentTide = parseFloat(data.tide) || 0;

                // Skip update if values are invalid
                if (isNaN(currentHumidity) || isNaN(currentWind)) {
                    console.warn('Invalid data received, skipping update');
                    return;
                }

                // Update trends (true = increase is bad, false = increase is good)
                updateMetricTrend('rainfall', currentRainfall, previousValues.rainfall, true);
                updateMetricTrend('temperature', currentTemperature, previousValues.temperature, true);
                updateMetricTrend('humidity', currentHumidity, previousValues.humidity, true);
                updateMetricTrend('wind', currentWind, previousValues.wind, true);
                updateMetricTrend('tide', currentTide, previousValues.tide, true);

                // Update metric values in DOM (find text node and update it, preserving trend indicators)
                const rainfallEl = document.querySelector('[data-rainfall]');
                const tempEl = document.querySelector('[data-temperature]');
                const humidityEl = document.querySelector('[data-humidity]');
                const windEl = document.querySelector('[data-wind]');
                const tideEl = document.querySelector('[data-tide]');

                // Helper function to update text node only
                function updateMetricValue(element, value) {
                    if (!element || isNaN(value)) return;
                    // Get the first text node or create one
                    let textNode = null;
                    for (let node of element.childNodes) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            textNode = node;
                            break;
                        }
                    }
                    if (textNode) {
                        textNode.textContent = value;
                    } else {
                        element.insertBefore(document.createTextNode(value), element.firstChild);
                    }
                }

                updateMetricValue(rainfallEl, currentRainfall + ' mm');
                updateMetricValue(tempEl, currentTemperature + '°C');
                updateMetricValue(humidityEl, currentHumidity + '%');
                updateMetricValue(windEl, currentWind + ' km/h');
                updateMetricValue(tideEl, currentTide + ' m');

                // Store current as previous for next comparison
                previousValues = {
                    rainfall: currentRainfall,
                    temperature: currentTemperature,
                    humidity: currentHumidity,
                    wind: currentWind,
                    tide: currentTide
                };
                
                // Reset countdown
                refreshSeconds = 300;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }, 300000);

    // Keyboard Navigation
    document.addEventListener('keydown', function(e) {
        // Ignore if user is typing in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        const keyboardHint = document.getElementById('keyboard-hint');
        
        // Show/hide keyboard shortcuts help with '?'
        if (e.key === '?') {
            keyboardHint.classList.toggle('show');
            return;
        }

        // Navigate to sections with number keys
        const sectionMap = {
            '1': 'current-conditions',
            '2': 'weather-forecast',
            '3': 'insights',
            '4': 'trends',
            '5': 'analysis',
            '6': 'flood-records'
        };

        if (sectionMap[e.key]) {
            e.preventDefault();
            const targetElement = document.getElementById(sectionMap[e.key]);
            if (targetElement) {
                // Expand section if collapsed
                const content = targetElement.querySelector('.card-content');
                if (content && content.classList.contains('collapsed')) {
                    const header = targetElement.querySelector('.card-header');
                    if (header) toggleSection(header);
                }
                
                // Smooth scroll to element
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Add highlight effect
                targetElement.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.3)';
                setTimeout(() => {
                    targetElement.style.boxShadow = '';
                }, 2000);
            }
        }
    });

    // Show keyboard hint on page load briefly
    window.addEventListener('load', function() {
        const keyboardHint = document.getElementById('keyboard-hint');
        setTimeout(() => {
            keyboardHint.classList.add('show');
        }, 1000);
        setTimeout(() => {
            keyboardHint.classList.remove('show');
        }, 5000);
    });

    // Function to update metrics with trend indicators
    function updateMetricWithTrend(selector, newValue) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        const oldValue = parseFloat(element.textContent);
        const currentValue = parseFloat(newValue);
        
        // Remove existing trend indicator
        const existingTrend = element.parentElement.querySelector('.trend-indicator');
        if (existingTrend) existingTrend.remove();
        
        // Update value
        element.textContent = newValue;
        
        // Add trend indicator
        if (!isNaN(oldValue) && !isNaN(currentValue)) {
            const trendSpan = document.createElement('span');
            trendSpan.className = 'trend-indicator';
            
            if (currentValue > oldValue) {
                trendSpan.classList.add('trend-up');
                trendSpan.innerHTML = '<i class="fas fa-arrow-up"></i>';
            } else if (currentValue < oldValue) {
                trendSpan.classList.add('trend-down');
                trendSpan.innerHTML = '<i class="fas fa-arrow-down"></i>';
            } else {
                trendSpan.classList.add('trend-stable');
                trendSpan.innerHTML = '<i class="fas fa-minus"></i>';
            }
            
            element.parentElement.appendChild(trendSpan);
        }
    }

    // Flood Records Filter Functions
    function applyFloodRecordFilter() {
        const startYear = document.getElementById('filter-start-year').value;
        const endYear = document.getElementById('filter-end-year').value;
        
        if (!startYear && !endYear) {
            alert('Please enter at least one year to filter');
            return;
        }
        
        if (startYear && endYear && parseInt(startYear) > parseInt(endYear)) {
            alert('Start year cannot be greater than end year');
            return;
        }
        
        const table = document.querySelector('.flood-records-table tbody');
        const rows = table.getElementsByTagName('tr');
        let visibleCount = 0;
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const dateCell = row.getElementsByTagName('td')[0];
            
            if (dateCell) {
                const dateText = dateCell.textContent.trim();
                const year = parseInt(dateText.split('-')[0]);
                
                let shouldShow = true;
                
                if (startYear && year < parseInt(startYear)) {
                    shouldShow = false;
                }
                if (endYear && year > parseInt(endYear)) {
                    shouldShow = false;
                }
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        // Update count badge
        const countBadge = document.querySelector('.records-count-badge span');
        if (countBadge) {
            countBadge.textContent = visibleCount;
        }

        // Show/hide empty state and table
        const emptyState = document.getElementById('flood-records-empty-state');
        const tableContainer = document.querySelector('.flood-records-table-container');
        
        if (visibleCount === 0) {
            tableContainer.style.display = 'none';
            emptyState.classList.add('show');
        } else {
            tableContainer.style.display = 'block';
            emptyState.classList.remove('show');
        }
        
        // Update export link to include filter parameters
        const exportBtn = document.getElementById('export-pdf-btn');
        let exportUrl = '{% url "export_flood_records" %}?type=pdf';
        if (startYear) exportUrl += `&start_year=${startYear}`;
        if (endYear) exportUrl += `&end_year=${endYear}`;
        exportBtn.href = exportUrl;
        
        console.log(`Filter applied: ${visibleCount} records shown`);
    }

    function resetFloodRecordFilter() {
        // Clear input fields
        document.getElementById('filter-start-year').value = '';
        document.getElementById('filter-end-year').value = '';
        
        // Show all rows
        const table = document.querySelector('.flood-records-table tbody');
        const rows = table.getElementsByTagName('tr');
        
        for (let i = 0; i < rows.length; i++) {
            rows[i].style.display = '';
        }

        // Hide empty state and show table
        const emptyState = document.getElementById('flood-records-empty-state');
        const tableContainer = document.querySelector('.flood-records-table-container');
        tableContainer.style.display = 'block';
        emptyState.classList.remove('show');
        
        // Reset count badge
        const countBadge = document.querySelector('.records-count-badge span');
        if (countBadge) {
            countBadge.textContent = {{ flood_records|length }};
        }
        
        // Reset export link
        const exportBtn = document.getElementById('export-pdf-btn');
        exportBtn.href = '{% url "export_flood_records" %}?type=pdf';
        
        console.log('Filter reset: All records shown');
    }
</script>

{% endblock %}