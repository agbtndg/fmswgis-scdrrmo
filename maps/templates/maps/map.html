{% extends 'users/base.html' %}
{% load static %}

{% block title %}Silay City Flood Map - DRRMO{% endblock %}

{% block header_title %}SCDRRMO - FMSWGIS{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/ol.css' %}">
<style>
    /* Enhanced Map View Styles with Dashboard Theme */
    :root {
        --primary-blue: #1e3a5f;
        --secondary-blue: #2563eb;
        --light-gray: #f8fafc;
        --border-gray: #e2e8f0;
        --text-dark: #1e293b;
        --text-muted: #64748b;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
        overflow: hidden;
        min-height: 100vh;
        background: #ffffff;
        color: var(--text-dark);
        margin: 0;
        padding-top: 64px !important;
    }

    .map-container {
        display: flex;
        height: 90vh;
        background: var(--light-gray);
        margin-bottom: 20px;
    }

    .sidebar {
        width: 340px;
        background: #ffffff;
        color: var(--text-dark);
        padding: 0;
        overflow-y: auto;
        box-shadow: 2px 0 16px rgba(0,0,0,0.08);
        border-right: 1px solid var(--border-gray);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 24px 24px 20px;
        border-bottom: 1px solid var(--border-gray);
        background: #ffffff;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sidebar-header h2 {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-dark);
        letter-spacing: -0.02em;
    }

    .back-to-dashboard {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: white;
        font-size: 14px;
        font-weight: 600;
        padding: 12px 20px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        border: none;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        cursor: pointer;
        margin-top: -8px;
        margin-bottom: 16px;
    }

    .back-to-dashboard:hover {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }

    .back-to-dashboard i {
        font-size: 12px;
    }

    .sidebar-subtitle {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 400;
    }

    .sidebar-content {
        padding: 20px;
        flex: 1;
    }

    .section {
        margin-bottom: 28px;
    }

    .section:last-child {
        margin-bottom: 0;
    }

    .section-title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
    }

    #barangay-select {
        width: 100%;
        padding: 12px 16px;
        border: 1.5px solid var(--border-gray);
        border-radius: 8px;
        font-size: 14px;
        background: #ffffff;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
    }

    #barangay-select:hover {
        border-color: var(--secondary-blue);
    }

    #barangay-select:focus {
        outline: none;
        border-color: var(--secondary-blue);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .legend {
        background: var(--light-gray);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border-gray);
        margin-top: 8px;
    }

    .legend-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 14px;
        color: var(--text-dark);
    }

    .legend-item:last-child {
        margin-bottom: 0;
    }

    .legend-color {
        width: 36px;
        height: 20px;
        margin-right: 14px;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 4px;
        flex-shrink: 0;
    }

    .switch-group {
        margin-bottom: 0;
    }

    .switch-container {
        display: flex;
        background: white;
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
        border: 1px solid var(--border-gray);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .switch-btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
        font-weight: 600;
        font-family: inherit;
    }

    .switch-btn:hover {
        background: var(--light-gray);
        color: var(--text-dark);
    }

    .switch-btn.active {
        background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        color: white;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 8px;
        border: 1px solid var(--border-gray);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .toggle-switch:hover {
        background: var(--light-gray);
        border-color: var(--secondary-blue);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .toggle-switch:last-child {
        margin-bottom: 0;
    }

    .toggle-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .toggle-input {
        position: relative;
        width: 44px;
        height: 24px;
        flex-shrink: 0;
    }

    .toggle-input input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, #e5e7eb, #d1d5db);
        transition: 0.3s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    input:checked + .slider {
        background: linear-gradient(90deg, var(--secondary-blue), var(--primary-blue));
    }

    input:checked + .slider:before {
        transform: translateX(20px);
    }

    #map {
        flex: 1;
        position: relative;
        background: var(--light-gray);
        width: 100%;
        height: 100%;
    }

    #popup {
        display: none;
        position: absolute;
        background: white;
        border: none;
        padding: 14px 18px;
        border-radius: 10px;
        pointer-events: none;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        color: var(--text-dark);
        line-height: 1.6;
        border: 1px solid var(--border-gray);
        font-family: inherit;
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }

    #popup.show {
        opacity: 1;
    }

    #risk-graph, #risk-table {
        margin-top: 0;
        width: 100%;
        display: block;
    }

    #risk-table {
        display: none;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border-gray);
    }

    th, td {
        border: 1px solid var(--border-gray);
        padding: 12px 14px;
        text-align: left;
        font-size: 13px;
    }

    th {
        background-color: var(--light-gray);
        font-weight: 600;
        color: var(--text-dark);
    }

    td {
        color: var(--text-dark);
        background: #ffffff;
    }

    #loading-screen {
        display: none;
        position: fixed;
        top: 60px; /* Account for header */
        left: 0;
        width: 100%;
        height: calc(100vh - 60px);
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    #loading-screen.active {
        display: flex;
    }

    #loading-content {
        text-align: center;
        color: white;
        background: #ffffff;
        padding: 32px 40px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        border: 1px solid var(--border-gray);
    }

    #loading-content h3 {
        color: var(--text-dark);
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    #cancel-btn, #see-result-btn {
        margin-top: 16px;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        font-family: inherit;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        width: 100%;
    }

    #cancel-btn:hover, #see-result-btn:hover {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }

    #see-result-btn {
        display: none;
        background: linear-gradient(135deg, #10b981, #059669);
    }

    #see-result-btn:hover {
        background: linear-gradient(135deg, #059669, #047857);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    #assessment-panel {
        position: fixed;
        right: -420px;
        top: 60px; /* Account for header */
        width: 420px;
        height: calc(100vh - 60px);
        background: #ffffff;
        box-shadow: -4px 0 24px rgba(0,0,0,0.15);
        padding: 0;
        transition: right 0.3s ease;
        z-index: 2001;
        display: flex;
        flex-direction: column;
        border-left: 1px solid var(--border-gray);
    }

    #assessment-panel.active {
        right: 0;
    }

    .assessment-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-gray);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--light-gray);
    }

    .assessment-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }

    #close-assessment {
        border: none;
        background: #f3f4f6;
        font-size: 20px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: all 0.2s ease;
    }

    #close-assessment:hover {
        background: #e5e7eb;
        color: var(--text-dark);
    }

    #assessment-content {
        padding: 24px;
        flex: 1;
        overflow-y: auto;
    }

    #assessment-content p {
        margin-bottom: 16px;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-dark);
    }

    #assessment-content strong {
        color: var(--text-dark);
        font-weight: 600;
    }

    .chart-container {
        background: var(--light-gray);
        padding: 16px;
        border-radius: 10px;
        border: 1px solid var(--border-gray);
        margin-bottom: 16px;
    }

    @media (max-width: 1024px) {
        .sidebar {
            width: 300px;
        }
    }

    @media (max-width: 768px) {
        .map-container {
            flex-direction: column;
            height: calc(100vh - 60px);
            top: 60px;
        }
        .sidebar {
            width: 100%;
            height: 300px;
            border-right: none;
            border-bottom: 1px solid var(--border-gray);
        }
        #assessment-panel {
            width: 100%;
            height: calc(100vh - 300px);
            right: -100%;
            top: auto;
            bottom: 0;
            border-left: none;
            border-top: 1px solid var(--border-gray);
        }
        #loading-screen {
            height: calc(100vh - 60px);
            top: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<form id="csrf-form" style="display:none;">{% csrf_token %}</form>
<div class="map-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Silay City Flood Map</h2>
            <div class="sidebar-subtitle">Interactive Risk Assessment</div>
        </div>

        <div class="sidebar-content">
            <!-- Barangay Selection -->
            <div class="section">
                <div class="section-title">Select Barangay</div>
                <select id="barangay-select">
                    <option value="">View All Barangays</option>
                    {% for name in barangay_names %}
                        <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Map View Switch -->
            <div class="section">
                <div class="section-title">Map Type</div>
                <div class="switch-group">
                    <div class="switch-container">
                        <button class="switch-btn" id="osm-btn">Street</button>
                        <button class="switch-btn active" id="satellite-btn">Satellite</button>
                    </div>
                </div>
            </div>

            <!-- Layer Settings -->
            <div class="section">
                <div class="section-title">Layer Settings</div>
                <label class="toggle-switch">
                    <span class="toggle-label">Flood Risk Layer</span>
                    <div class="toggle-input">
                        <input type="checkbox" id="flood-layer-toggle" checked>
                        <span class="slider"></span>
                    </div>
                </label>
                <label class="toggle-switch">
                    <span class="toggle-label">Barangay Boundaries</span>
                    <div class="toggle-input">
                        <input type="checkbox" id="barangay-layer-toggle" checked>
                        <span class="slider"></span>
                    </div>
                </label>
            </div>

            <!-- Graph/Table Toggle -->
            <div class="section" style="display: none;">
                <div class="section-title">Display Type</div>
                <div class="switch-group">
                    <div class="switch-container">
                        <button class="switch-btn active" id="graph-btn">Graph</button>
                        <button class="switch-btn" id="table-btn">Table</button>
                    </div>
                </div>
            </div>

            <!-- Graph Section -->
            <div class="section" style="display: none;">
                <div class="chart-container">
                    <canvas id="risk-graph" width="280" height="180"></canvas>
                </div>
                <div id="risk-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Risk Level</th>
                                <th>Area & Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="risk-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Flood Susceptibility</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #0a255b;"></div>
                    <span>Very High Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #6124d8;"></div>
                    <span>High Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #954fc9;"></div>
                    <span>Moderate Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #b9b2c8;"></div>
                    <span>Low Risk</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map" data-barangays='{{ barangays_json|safe }}' data-floods='{{ flood_areas_json|safe }}'>
        <div id="popup"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div id="loading-content">
            <h3>Initializing Assessment...</h3>
            <button id="cancel-btn">Cancel</button>
            <button id="see-result-btn">See Result</button>
        </div>
    </div>

    <!-- Assessment Panel -->
    <div id="assessment-panel">
        <div class="assessment-header">
            <h2>Flood Assessment</h2>
            <button id="close-assessment">Ã—</button>
        </div>
        <div id="assessment-content"></div>
    </div>
</div>

<style>
    /* Override base template constraints for full-width map */
    .main-content {
        padding: 0 !important;
        max-width: none !important;
        margin: 0 !important;
    }

    /* Prevent horizontal scrolling */
    html, body {
        overflow-x: hidden !important;
        width: 100% !important;
    }
</style>

<script src="{% static 'js/ol.js' %}"></script>
<script>
    // Helper function to convert hex to RGB
    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    // Create base layers
    var osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        visible: false
    });

    var satelliteLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            maxZoom: 19
        }),
        visible: true
    });

    // Initialize the map
    var map = new ol.Map({
        target: 'map',
        layers: [osmLayer, satelliteLayer],
        controls: [], // Remove default attribution and zoom controls
        view: new ol.View({
            center: ol.proj.fromLonLat([122.975, 10.787]),
            zoom: 12
        })
    });

    // Remove the default double-click zoom interaction
    map.getInteractions().forEach(function(interaction) {
        if (interaction instanceof ol.interaction.DoubleClickZoom) {
            map.removeInteraction(interaction);
        }
    });

    // Create vector sources for layers
    var barangayVectorSource = new ol.source.Vector();
    var floodVectorSource = new ol.source.Vector();
    var pinVectorSource = new ol.source.Vector();

    // Style for highlighted barangay
    var highlightStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({ 
            color: '#fbbf24', 
            width: 4 
        }),
        fill: new ol.style.Fill({ 
            color: 'rgba(251, 191, 36, 0.25)' 
        })
    });

    // Default style for barangays
    var defaultBarangayStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({ 
            color: '#6b7280', 
            width: 2 
        }),
        fill: new ol.style.Fill({ 
            color: 'rgba(0, 0, 0, 0)' 
        })
    });

    // Pin style
    var pinStyle = new ol.style.Style({
        image: new ol.style.Icon({
            src: 'https://openlayers.org/en/latest/examples/data/icon.png',
            scale: 0.1,
            anchor: [0.5, 1]
        })
    });

    // Load barangay data
    var barangaysData = JSON.parse(document.getElementById('map').dataset.barangays || '[]');
    if (barangaysData.type === 'FeatureCollection' && barangaysData.features) {
        barangaysData.features.forEach(function(feature) {
            var barangayFeature = new ol.format.GeoJSON().readFeature(feature, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });
            barangayFeature.setStyle(defaultBarangayStyle);
            barangayVectorSource.addFeature(barangayFeature);
        });
    }

    // Load flood susceptibility data
    var floodData = JSON.parse(document.getElementById('map').dataset.floods || '[]');
    if (floodData.type === 'FeatureCollection' && floodData.features) {
        floodData.features.forEach(function(feature) {
            var floodFeature = new ol.format.GeoJSON().readFeature(feature, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });
            
            // Color mapping for flood risk levels
            var colorMap = { 
                'VHF': '#0a255b',
                'HF': '#6124d8',
                'MF': '#954fc9',
                'LF': '#b9b2c8'
            };
            
            var color = colorMap[feature.properties.haz_code] || '#ffffff';
            var rgb = hexToRgb(color);
            
            floodFeature.setStyle(new ol.style.Style({
                stroke: new ol.style.Stroke({ 
                    color: '#000000', 
                    width: 0.5 
                }),
                fill: new ol.style.Fill({ 
                    color: 'rgba(' + rgb.r + ', ' + rgb.g + ', ' + rgb.b + ', 0.6)' 
                })
            }));
            
            floodVectorSource.addFeature(floodFeature);
        });
    }

    // Create layers
    var floodLayer = new ol.layer.Vector({
        source: floodVectorSource,
        zIndex: 1
    });

    var barangayLayer = new ol.layer.Vector({
        source: barangayVectorSource,
        zIndex: 2
    });

    var pinLayer = new ol.layer.Vector({
        source: pinVectorSource,
        zIndex: 3
    });

    // Add layers to map
    map.addLayer(floodLayer);
    map.addLayer(barangayLayer);
    map.addLayer(pinLayer);

    // Popup element
    var popup = document.getElementById('popup');

    // Map click handler
    map.on('click', function(evt) {
        var coordinate = evt.coordinate;
        var lonlat = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');
        var viewResolution = map.getView().getResolution();

        // Hide existing popup
        popup.style.display = 'none';

        var barangayFeature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature.get('name') ? feature : null;
        });

        var floodFeature = null;
        if (floodLayer.getVisible()) {
            floodFeature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature.get('haz_code') ? feature : null;
            });
        }

        if (barangayFeature || floodFeature) {
            var content = '';
            if (barangayFeature) {
                content += 'Barangay: ' + barangayFeature.get('name');
            }
            if (floodFeature) {
                var riskMap = {
                    'VHF': 'Very High Risk',
                    'HF': 'High Risk',
                    'MF': 'Moderate Risk',
                    'LF': 'Low Risk'
                };
                content += content ? '<br>' : '';
                content += 'Flood Risk: ' + (riskMap[floodFeature.get('haz_code')] || 'Unknown');
            }
            popup.innerHTML = content;
            popup.style.left = (evt.pixel[0] + 10) + 'px';
            popup.style.top = (evt.pixel[1] - 30) + 'px';
            popup.style.display = 'block';
            popup.classList.add('show');

            // Auto-hide popup after 3 seconds with fade effect
            setTimeout(function() {
                popup.classList.remove('show');
                // Hide completely after fade transition
                setTimeout(function() {
                    popup.style.display = 'none';
                }, 500);
            }, 3000);
        }
    });

    // Bar graph and table setup
    var canvas = document.getElementById('risk-graph');
    var ctx = canvas.getContext('2d');
    var tableBody = document.getElementById('risk-table-body');

    function drawBarGraph(data) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        var barWidth = (canvas.width / 4) * 0.7;
        var maxHeight = canvas.height - 50;
        var totalArea = data.totalArea || Object.values(data.areas).reduce((a, b) => a + b, 0);
        var spacing = canvas.width / 4;
        var startX = spacing / 2 - barWidth / 2;

        ctx.font = 'bold 12px Inter, sans-serif';
        ctx.fillStyle = '#1a1a1a';
        ctx.textAlign = 'center';

        var labels = ['VHF', 'HF', 'MF', 'LF'];
        var colors = ['#0a255b', '#6124d8', '#954fc9', '#b9b2c8'];
        var names = ['Very High', 'High', 'Moderate', 'Low'];

        labels.forEach((code, index) => {
            var area = data.areas[code] || 0;
            var percentage = totalArea > 0 ? (area / totalArea) * 100 : 0;
            var height = totalArea > 0 ? (area / totalArea) * maxHeight : 0;
            
            var xPos = startX + (index * spacing);
            
            // Draw bar
            ctx.fillStyle = colors[index];
            ctx.fillRect(xPos, canvas.height - height - 30, barWidth, height);
            
            // Draw percentage above bar
            ctx.fillStyle = '#1a1a1a';
            ctx.font = 'bold 11px Inter, sans-serif';
            ctx.fillText(`${percentage.toFixed(1)}%`, xPos + barWidth / 2, canvas.height - height - 35);
            
            // Draw label below bar
            ctx.fillStyle = '#6b7280';
            ctx.font = '10px Inter, sans-serif';
            ctx.fillText(names[index], xPos + barWidth / 2, canvas.height - 15);
        });

        // Draw axis line
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(5, canvas.height - 25);
        ctx.lineTo(canvas.width - 5, canvas.height - 25);
        ctx.stroke();
    }

    function updateTable(data) {
        tableBody.innerHTML = '';
        var totalArea = data.totalArea || Object.values(data.areas).reduce((a, b) => a + b, 0);
        var totalZones = data.totalZones || Object.values(data.zoneCount).reduce((a, b) => a + b, 0);

        ['VHF', 'HF', 'MF', 'LF'].forEach(code => {
            var area = data.areas[code] || 0;
            var zones = data.zoneCount[code] || 0;
            var percentage = totalArea > 0 ? (area / totalArea) * 100 : 0;
            var riskLabel = code === 'VHF' ? 'Very High' : code === 'HF' ? 'High' : code === 'MF' ? 'Moderate' : 'Low';

            var row = document.createElement('tr');
            row.innerHTML = `
                <td>${riskLabel} Risk</td>
                <td>${percentage.toFixed(1)}% (${area.toFixed(2)} ha, ${zones} zones)</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function calculateRiskPercentages(selectedBarangay) {
        var areas = { VHF: 0, HF: 0, MF: 0, LF: 0 };
        var zoneCount = { VHF: 0, HF: 0, MF: 0, LF: 0 };

        // City-wide calculation
        if (!selectedBarangay) {
            floodData.features.forEach(f => {
                var hazCode = f.properties.haz_code;
                var hazArea = parseFloat(f.properties.haz_area_ha) || 0;
                if (hazArea > 0 && hazCode && (hazCode === 'VHF' || hazCode === 'HF' || hazCode === 'MF' || hazCode === 'LF')) {
                    areas[hazCode] = (areas[hazCode] || 0) + hazArea;
                    zoneCount[hazCode] = (zoneCount[hazCode] || 0) + 1;
                }
            });
        } else {
            // Barangay-specific calculation using proper geometry intersection
            var barangayFeature = barangaysData.features.find(f => f.properties.name === selectedBarangay);
            if (barangayFeature) {
                var barangayGeom = new ol.format.GeoJSON().readGeometry(barangayFeature.geometry, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:4326'
                });

                // Proper intersection check: only count zones that actually intersect
                floodData.features.forEach(f => {
                    var floodGeom = new ol.format.GeoJSON().readGeometry(f.geometry, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:4326'
                    });

                    // Use proper intersection check instead of just extent
                    if (barangayGeom.intersectsCoordinate && floodGeom.getClosestPoint) {
                        // For polygons, check if they actually intersect
                        try {
                            var intersect = barangayGeom.getExtent();
                            var floodExtent = floodGeom.getExtent();
                            if (ol.extent.intersects(intersect, floodExtent)) {
                                var hazCode = f.properties.haz_code;
                                var hazArea = parseFloat(f.properties.haz_area_ha) || 0;
                                if (hazArea > 0 && hazCode && (hazCode === 'VHF' || hazCode === 'HF' || hazCode === 'MF' || hazCode === 'LF')) {
                                    areas[hazCode] = (areas[hazCode] || 0) + hazArea;
                                    zoneCount[hazCode] = (zoneCount[hazCode] || 0) + 1;
                                }
                            }
                        } catch (e) {
                            console.error('Error in intersection calculation:', e);
                        }
                    }
                });
            }
        }

        // Return both area data and zone count data
        return {
            areas: areas,
            zoneCount: zoneCount,
            totalArea: Object.values(areas).reduce((a, b) => a + b, 0),
            totalZones: Object.values(zoneCount).reduce((a, b) => a + b, 0)
        };
    }

    // Initial display
    var graphVisible = true;
    drawBarGraph(calculateRiskPercentages(''));

    // Toggle between graph and table
    document.getElementById('graph-btn').addEventListener('click', function() {
        graphVisible = true;
        this.classList.add('active');
        document.getElementById('table-btn').classList.remove('active');
        document.getElementById('risk-graph').style.display = 'block';
        document.getElementById('risk-table').style.display = 'none';
        drawBarGraph(calculateRiskPercentages(document.getElementById('barangay-select').value));
    });

    document.getElementById('table-btn').addEventListener('click', function() {
        graphVisible = false;
        this.classList.add('active');
        document.getElementById('graph-btn').classList.remove('active');
        document.getElementById('risk-graph').style.display = 'none';
        document.getElementById('risk-table').style.display = 'block';
        updateTable(calculateRiskPercentages(document.getElementById('barangay-select').value));
    });

    // Initial graph and update on selection
    document.getElementById('barangay-select').addEventListener('change', function() {
        console.log('Selection changed to:', this.value);
        var selectedBarangay = this.value;
        barangayVectorSource.clear();
        
        if (selectedBarangay) {
            var selectedFeature = barangaysData.features.find(f => f.properties.name === selectedBarangay);
            if (selectedFeature) {
                var feature = new ol.format.GeoJSON().readFeature(selectedFeature, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                feature.setStyle(highlightStyle);
                barangayVectorSource.addFeature(feature);
                
                var extent = feature.getGeometry().getExtent();
                map.getView().fit(extent, { 
                    padding: [50, 50, 50, 50], 
                    duration: 500 
                });
            }
        } else {
            map.getView().setCenter(ol.proj.fromLonLat([122.975, 10.787]));
            map.getView().setZoom(12);
            
            barangaysData.features.forEach(function(feature) {
                var barangayFeature = new ol.format.GeoJSON().readFeature(feature, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                barangayFeature.setStyle(defaultBarangayStyle);
                barangayVectorSource.addFeature(barangayFeature);
            });
        }
        if (graphVisible) {
            drawBarGraph(calculateRiskPercentages(selectedBarangay));
        } else {
            updateTable(calculateRiskPercentages(selectedBarangay));
        }
    });

    // Map type switch buttons
    var osmBtn = document.getElementById('osm-btn');
    var satelliteBtn = document.getElementById('satellite-btn');

    osmBtn.addEventListener('click', function() {
        osmLayer.setVisible(true);
        satelliteLayer.setVisible(false);
        osmBtn.classList.add('active');
        satelliteBtn.classList.remove('active');
    });

    satelliteBtn.addEventListener('click', function() {
        osmLayer.setVisible(false);
        satelliteLayer.setVisible(true);
        satelliteBtn.classList.add('active');
        osmBtn.classList.remove('active');
    });

    // Layer toggles
    document.getElementById('flood-layer-toggle').addEventListener('change', function() {
        floodLayer.setVisible(this.checked);
    });

    document.getElementById('barangay-layer-toggle').addEventListener('change', function() {
        barangayLayer.setVisible(this.checked);
    });

    // Assessment logic
    var pinFeature = null;
    var assessmentTimeout = null;

    // Function to save assessment to database
    function saveAssessmentToDatabase(barangayName, lonlat, floodRisk) {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        
        // Prepare form data
        const formData = new FormData();
        formData.append('barangay', barangayName || 'Unknown');
        formData.append('latitude', lonlat[1].toFixed(6));
        formData.append('longitude', lonlat[0].toFixed(6));
        formData.append('flood_risk_code', floodRisk || 'Unknown');
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Send to server
        fetch('/maps/save-assessment/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Assessment saved successfully:', data);
            } else {
                console.error('Failed to save assessment:', data.message);
            }
        })
        .catch(error => {
            console.error('Error saving assessment:', error);
        });
    }

    map.on('dblclick', function(evt) {
        var coordinate = evt.coordinate;
        var lonlat = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');

        // Remove existing pin
        pinVectorSource.clear();

        // Add new pin
        pinFeature = new ol.Feature(new ol.geom.Point(coordinate));
        pinFeature.setStyle(pinStyle);
        pinVectorSource.addFeature(pinFeature);

        // Show loading screen
        var loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.add('active');
        document.getElementById('cancel-btn').style.display = 'block';
        document.getElementById('see-result-btn').style.display = 'none';

        // Simulate assessment loading (2 seconds)
        assessmentTimeout = setTimeout(function() {
            document.getElementById('cancel-btn').style.display = 'none';
            document.getElementById('see-result-btn').style.display = 'block';
        }, 2000);
    });

    document.getElementById('cancel-btn').addEventListener('click', function() {
        var loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.remove('active');
        pinVectorSource.clear();
        clearTimeout(assessmentTimeout);
    });

    document.getElementById('see-result-btn').addEventListener('click', function() {
        var loadingScreen = document.getElementById('loading-screen');
        loadingScreen.classList.remove('active');
        var assessmentPanel = document.getElementById('assessment-panel');
        assessmentPanel.classList.add('active');

        // Determine barangay and flood risk
        var coordinate = pinFeature.getGeometry().getCoordinates();
        var lonlat = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');
        var barangayName = null;
        var floodRisk = null;

        barangaysData.features.forEach(function(feature) {
            var geom = new ol.format.GeoJSON().readGeometry(feature.geometry, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });
            if (geom.intersectsCoordinate(coordinate)) {
                barangayName = feature.properties.name;
            }
        });

        floodData.features.forEach(function(feature) {
            var geom = new ol.format.GeoJSON().readGeometry(feature.geometry, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            });
            if (geom.intersectsCoordinate(coordinate)) {
                floodRisk = feature.properties.haz_code;
            }
        });

        // Save assessment to database
        saveAssessmentToDatabase(barangayName, lonlat, floodRisk);

        // Generic assessment based on flood susceptibility
        var assessmentText = '';
        if (floodRisk) {
            switch (floodRisk) {
                case 'LF':
                    assessmentText = 'Low Susceptibility; less than 0.5 meters flood height and/or less than 1 day flooding';
                    break;
                case 'MF':
                    assessmentText = 'Moderate Susceptibility; 0.5 to 1 meter flood height and/or 1 to 3 days flooding';
                    break;
                case 'HF':
                    assessmentText = 'High Susceptibility; 1 to 2 meters flood height and/or more than 3 days flooding';
                    break;
                case 'VHF':
                    assessmentText = 'Very High Susceptibility; more than 2 meters flood height and/or more than 3 days flooding';
                    break;
            }
        } else {
            assessmentText = 'No significant flood risk detected.';
        }

        // Populate assessment content
        var content = `
            <p><strong>Barangay:</strong> ${barangayName || 'Unknown'}</p>
            <p><strong>Coordinates:</strong> (${lonlat[0].toFixed(6)}, ${lonlat[1].toFixed(6)})</p>
            <p><strong>Flood Susceptibility:</strong> ${floodRisk ? floodRisk.replace('VHF', 'Very High').replace('HF', 'High').replace('MF', 'Moderate').replace('LF', 'Low') : 'Unknown'}</p>
            <p><strong>Flood Hazard Assessment:</strong> ${assessmentText}</p>
            <button id="view-report-btn" style="width: 100%; padding: 12px; margin-top: 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #2563eb, #1e3a5f); color: white; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);">View Report with Recommendations</button>
            <button id="generate-cert-btn" style="width: 100%; padding: 12px; margin-top: 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #2563eb, #1e3a5f); color: white; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);">Generate Certificate</button>
        `;
        document.getElementById('assessment-content').innerHTML = content;
        
        // Add event listeners for the buttons
        document.getElementById('view-report-btn').addEventListener('click', function() {
            // Check if barangay and flood risk are valid
            if (barangayName === 'Unknown' || !barangayName) {
                var errorUrl = '/maps/error/?title=' + encodeURIComponent('Invalid Location') + 
                              '&message=' + encodeURIComponent('You clicked outside Silay City. Please select a location within Silay City to generate a report.') + 
                              '&details=' + encodeURIComponent('Coordinates: (' + lonlat[0].toFixed(6) + ', ' + lonlat[1].toFixed(6) + ')');
                window.open(errorUrl, '_blank');
                return;
            }
            
            var reportUrl = '/maps/report/?barangay=' + encodeURIComponent(barangayName || 'Unknown') + 
                           '&lat=' + lonlat[1].toFixed(6) + 
                           '&lon=' + lonlat[0].toFixed(6) + 
                           '&risk=' + (floodRisk || 'Unknown');
            window.open(reportUrl, '_blank');
        });
        
        document.getElementById('view-report-btn').addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #1e3a5f, #2563eb)';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(37, 99, 235, 0.3)';
        });
        
        document.getElementById('view-report-btn').addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(135deg, #2563eb, #1e3a5f)';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(37, 99, 235, 0.15)';
        });
        
        document.getElementById('generate-cert-btn').addEventListener('click', function() {
            // Check if barangay is valid
            if (barangayName === 'Unknown' || !barangayName) {
                var errorUrl = '/maps/error/?title=' + encodeURIComponent('Invalid Location') + 
                              '&message=' + encodeURIComponent('You clicked outside Silay City. Please select a location within Silay City to generate a certificate.') + 
                              '&details=' + encodeURIComponent('Coordinates: (' + lonlat[0].toFixed(6) + ', ' + lonlat[1].toFixed(6) + ')');
                window.open(errorUrl, '_blank');
                return;
            }
            
            var certUrl = '/maps/certificate/form/?barangay=' + encodeURIComponent(barangayName || 'Unknown') + 
                         '&lat=' + lonlat[1].toFixed(6) + 
                         '&lon=' + lonlat[0].toFixed(6) + 
                         '&risk=' + (floodRisk || 'Unknown');
            window.open(certUrl, '_blank');
        });
        
        document.getElementById('generate-cert-btn').addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #1e3a5f, #2563eb)';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(37, 99, 235, 0.3)';
        });
        
        document.getElementById('generate-cert-btn').addEventListener('mouseleave', function() {
            this.style.background = 'linear-gradient(135deg, #2563eb, #1e3a5f)';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(37, 99, 235, 0.15)';
        });
    });

    document.getElementById('close-assessment').addEventListener('click', function() {
        var assessmentPanel = document.getElementById('assessment-panel');
        assessmentPanel.classList.remove('active');
        pinVectorSource.clear();
    });
</script>

{% endblock %}